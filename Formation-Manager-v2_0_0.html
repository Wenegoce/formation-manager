<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation Manager v2.0.0 - WeN√©goce</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #F3FEFF 0%, #57976E 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: white;
            color: #333;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            border-bottom: 3px solid #3270AF;
        }

        .header-logo {
            flex-shrink: 0;
        }

        .header-logo img {
            height: 60px;
            width: auto;
        }

        .header-content {
            flex-grow: 1;
            text-align: right;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #3270AF;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            background: transparent;
            color: #666;
        }

        .tab.active {
            background: white;
            color: #3270AF;
            border-bottom: 3px solid #3270AF;
        }

        .tab:hover:not(.active) {
            background: #ebebeb;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            transition: border-color 0.3s;
        }

        input[type="date"], input[type="time"] {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3270AF;
        }

        input.valid, select.valid {
            background-color: #e8f5e9;
            border-color: #4caf50;
        }

        input.invalid, select.invalid {
            border-color: #dc3545;
        }

        .error-message {
            color: #dc3545;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stagiaire-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #3270AF;
        }

        .stagiaire-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stagiaire-number {
            background: #3270AF;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn {
            background: #3270AF;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            background: #265a8f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(50,112,175,0.3);
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .info-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .info-row {
            display: flex;
            margin-bottom: 10px;
        }

        .info-label {
            font-weight: 600;
            min-width: 230px;
            color: #3270AF;
        }

        .stars {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .star {
            font-size: 40px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            color: #ddd;
        }

        .star.active {
            color: #ffd700;
        }

        .star:hover {
            transform: scale(1.2);
        }

        .radio-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .radio-item {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: auto;
        }

        .switch-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .switch-label {
            font-weight: 600;
            color: #999;
            min-width: 110px;
            transition: color 0.3s;
        }

        .switch-label.active {
            color: #3270AF;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3270AF;
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .radio-item:has(input[type="radio"]:checked) {
            background-color: #3270AF !important;
            color: white !important;
            border-color: #3270AF !important;
        }

        .radio-item input[type="radio"]:checked {
            accent-color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #3270AF 0%, #265a8f 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }

        .modal-body {
            padding: 30px;
        }

        .btn-icon {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 24px;
            padding: 5px 10px;
            transition: transform 0.2s;
        }

        .btn-icon:hover {
            transform: scale(1.1);
        }

        .btn-edit {
            background: #3270AF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-edit:hover {
            background: #265a8f;
            transform: translateY(-2px);
        }

        .version-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            margin-top: 20px;
            text-align: center;
        }

        .version-info .version-number {
            font-size: 18px;
            font-weight: 700;
            color: #3270AF;
            margin-bottom: 5px;
        }

        .version-info .version-date {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .version-info .copyright {
            font-size: 12px;
            color: #999;
            font-style: italic;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
        }

        .formation-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .formation-card:hover {
            border-color: #3270AF;
            box-shadow: 0 4px 12px rgba(50,112,175,0.15);
        }

        .formation-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .formation-card-title {
            font-size: 18px;
            font-weight: 700;
            color: #3270AF;
        }

        .formation-card-date {
            background: #3270AF;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .formation-card-body {
            margin-bottom: 15px;
        }

        .formation-card-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .formation-card-label {
            font-weight: 600;
            min-width: 140px;
            color: #666;
        }

        .formation-card-value {
            color: #333;
        }

        /* Optimisations Mobile */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 8px;
            }

            .header {
                flex-direction: column;
                text-align: center;
                padding: 15px;
            }

            .header-logo img {
                height: 50px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 12px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                padding: 12px;
                font-size: 14px;
            }

            .content {
                padding: 15px;
            }

            .row {
                grid-template-columns: 1fr;
            }

            .btn {
                width: 100%;
                margin-top: 10px;
                margin-left: 0 !important;
            }

            .radio-group {
                flex-direction: column;
            }

            .radio-item {
                min-width: 100%;
            }

            .stars {
                justify-content: center;
            }

            .star {
                font-size: 36px;
            }

            /* Stagiaire items */
            .stagiaire-item {
                padding: 12px;
            }

            .stagiaire-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            /* Modal plein √©cran sur mobile */
            .modal-content {
                width: 95%;
                margin: 2% auto;
                max-height: 95vh;
                overflow-y: auto;
            }

            .modal-header {
                padding: 15px 20px;
            }

            .modal-header h3 {
                font-size: 18px;
            }

            .modal-body {
                padding: 20px;
            }

            /* Alert */
            .alert {
                padding: 12px;
                font-size: 14px;
            }

            /* Titres */
            h2 {
                font-size: 20px !important;
            }

            h3 {
                font-size: 18px !important;
            }

            h4 {
                font-size: 16px !important;
            }

            /* Formulaire de satisfaction */
            #satisfactionForm .form-group {
                margin-bottom: 25px;
            }

            /* Bouton test et envoi */
            .btn-edit {
                padding: 10px 14px;
                font-size: 13px;
            }

            /* Switch container */
            .switch-container {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            /* Petits textes plus lisibles */
            small {
                font-size: 13px !important;
            }

            /* Espacement des sections */
            .form-group {
                margin-bottom: 25px;
            }
        }

        /* Tr√®s petits √©crans (moins de 400px) */
        @media screen and (max-width: 400px) {
            .header h1 {
                font-size: 18px;
            }

            .tab {
                font-size: 12px;
                padding: 10px;
            }

            .btn {
                font-size: 14px;
                padding: 14px 20px;
            }

            .star {
                font-size: 36px;
                gap: 8px;
            }

            .stars {
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-logo">
                <img src="https://raw.githubusercontent.com/Wenegoce/formation-manager/main/assets/images/Logo_WeN√©goce.png" alt="WeN√©goce">
            </div>
            <div class="header-content">
                <h1>Formation Manager</h1>
                <p>Suivi des pr√©sences et enqu√™te de satisfaction stagiaires</p>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="formateur">üë®‚Äçüè´ Espace Formateur</button>
            <button class="tab" data-tab="formations">üìã Formations</button>
            <button class="tab" data-tab="stagiaire">üë§ Espace Stagiaire</button>
            <button class="tab" data-tab="settings">‚öôÔ∏è Param√®tres</button>
        </div>

        <div class="content">
            <div id="formateur" class="tab-content active">
                <h2 style="margin-bottom: 20px; color: #3270AF;">Pr√©paration de la formation</h2>
                
                <div id="preparationForm">
                    <form id="formateurForm">
                        <div class="form-group">
                            <label>Raison sociale du client *</label>
                            <input type="text" id="raisonSociale" required>
                            <span class="error-message" id="error-raisonSociale">Ce champ est obligatoire</span>
                        </div>

                        <div class="form-group">
                            <label>Th√®me de la formation *</label>
                            <input type="text" id="themeFormation" required>
                            <span class="error-message" id="error-themeFormation">Ce champ est obligatoire</span>
                        </div>

                        <div class="form-group">
                            <label>R√©f√©rence JIRA</label>
                            <input type="text" id="referenceJira" placeholder="TIC-123, SMC-456 ou SNC-789">
                            <small style="color: #999; font-size: 12px;">Format : TIC-, SMC- ou SNC- suivi d'un num√©ro (optionnel)</small>
                        </div>

                        <div class="form-group">
                            <label>Nom du formateur *</label>
                            <input type="text" id="nomFormateur" required>
                            <span class="error-message" id="error-nomFormateur">Ce champ est obligatoire</span>
                        </div>

                        <div class="row">
                            <div class="form-group">
                                <label>Date de la formation *</label>
                                <input type="date" id="dateFormation" required>
                                <span class="error-message" id="error-dateFormation">Ce champ est obligatoire</span>
                            </div>
                            <div class="form-group">
                                <label>Type de formation *</label>
                                <div class="switch-container">
                                    <span class="switch-label active" id="labelPresentiel">üè¢ Pr√©sentiel</span>
                                    <label class="switch">
                                        <input type="checkbox" id="typeFormationToggle">
                                        <span class="slider"></span>
                                    </label>
                                    <span class="switch-label" id="labelVisio">üíª Visio</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group">
                                <label>Heure de d√©but *</label>
                                <input type="time" id="heureDebut" required>
                                <span class="error-message" id="error-heureDebut">Ce champ est obligatoire</span>
                            </div>
                            <div class="form-group">
                                <label>Heure de fin *</label>
                                <input type="time" id="heureFin" required>
                                <span class="error-message" id="error-heureFin">Ce champ est obligatoire</span>
                            </div>
                        </div>

                        <h3 style="margin: 30px 0 15px; color: #3270AF;">Liste des stagiaires</h3>
                        
                        <div id="stagiairesList"></div>

                        <div style="display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-secondary" id="btnAddStagiaire" onclick="addStagiaire()">
                                ‚ûï Ajouter un stagiaire
                            </button>
                            <button type="submit" class="btn" id="btnFeuillePresence" disabled style="opacity: 0.5; cursor: not-allowed;">üìù Feuille de pr√©sence</button>
                        </div>
                    </form>
                </div>

                <div id="postFormationSection" style="display: none;">
                    <div class="alert alert-info">
                        ‚ÑπÔ∏è <strong>Formation enregistr√©e !</strong> Une fois la formation termin√©e, compl√©tez la pr√©sence de chaque stagiaire ci-dessous.
                    </div>

                    <div id="formationInfo" class="info-display" style="margin-bottom: 30px;"></div>

                    <h3 style="margin-bottom: 20px; color: #3270AF;">Compl√©ter les pr√©sences</h3>
                    
                    <form id="presenceForm">
                        <div id="presenceList"></div>
                        <div style="margin-top: 30px;">
                            <button type="submit" class="btn">üìß G√©n√©rer et envoyer les liens stagiaires</button>
                        </div>
                    </form>
                </div>

                <div id="linksGenerated" style="display: none; margin-top: 30px;">
                    <div class="alert alert-success">
                        ‚úÖ Les liens ont √©t√© g√©n√©r√©s avec succ√®s ! Vous pouvez maintenant envoyer les emails aux stagiaires.
                    </div>
                    <div id="emailLinks"></div>
                </div>
            </div>

            <div id="formations" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #3270AF;">üìã Mes Formations</h2>
                
                <div class="alert alert-info">
                    ‚ÑπÔ∏è S√©lectionnez une formation pour envoyer les liens d'enqu√™te de satisfaction aux stagiaires.
                </div>

                <div id="formationsLoading" style="text-align: center; padding: 40px; color: #666;">
                    üîÑ Chargement des formations...
                </div>

                <div id="formationsList" style="display: none;">
                    <!-- La liste des formations sera g√©n√©r√©e ici -->
                </div>

                <div id="formationsEmpty" style="display: none; text-align: center; padding: 40px; color: #999;">
                    üì≠ Aucune formation trouv√©e.
                </div>
            </div>

            <div id="stagiaire" class="tab-content">
                <div id="stagiaireView">
                    <div class="alert alert-info">
                        ‚ÑπÔ∏è Cette page est accessible via le lien envoy√© par email par votre formateur.
                    </div>

                    <h2 id="attestationTitle" style="margin-bottom: 20px; color: #3270AF;">Attestation de formation</h2>
                    
                    <div class="info-display" id="infoFormation">
                        <p style="text-align: center; color: #666;">En attente du lien personnalis√©...</p>
                    </div>

                    <form id="satisfactionForm" style="display: none;">
                        <h3 style="margin: 30px 0 20px; color: #3270AF;">üìã Enqu√™te de satisfaction</h3>

                        <div class="form-group">
                            <label>La formation a-t-elle r√©pondu √† vos attentes ? *</label>
                            <div class="stars" id="q1Stars"></div>
                            <input type="hidden" id="q1" required>
                        </div>

                        <div class="form-group">
                            <label>Les objectifs de la formation √©taient-ils clairs et bien expliqu√©s ? *</label>
                            <div class="stars" id="q2Stars"></div>
                            <input type="hidden" id="q2" required>
                        </div>

                        <div class="form-group">
                            <label>Le formateur a-t-il su rendre la session claire, dynamique et adapt√©e √† votre niveau ? *</label>
                            <div class="stars" id="q3Stars"></div>
                            <input type="hidden" id="q3" required>
                        </div>

                        <div class="form-group">
                            <label>Vous sentez-vous √† pr√©sent √† l'aise pour utiliser les fonctions pr√©sent√©es lors de cette formation ? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="q4" value="Pas du tout" required>
                                    <span>Pas du tout</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="q4" value="Un peu" required>
                                    <span>Un peu</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="q4" value="Moyennement" required>
                                    <span>Moyennement</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="q4" value="Assez" required>
                                    <span>Assez</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="q4" value="Tout √† fait" required>
                                    <span>Tout √† fait</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Comment jugez-vous la dur√©e de la formation ? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="q5" value="Trop courte" required>
                                    <span>Trop courte</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="q5" value="Adapt√©e" required>
                                    <span>Adapt√©e</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="q5" value="Trop longue" required>
                                    <span>Trop longue</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Quelles sont vos suggestions pour am√©liorer cette formation ?</label>
                            <textarea id="q6" maxlength="100" rows="3" placeholder="Maximum 100 caract√®res"></textarea>
                            <small style="color: #666;">Caract√®res restants: <span id="q6Count">100</span></small>
                        </div>

                        <div class="form-group">
                            <label>Un dernier commentaire ?</label>
                            <textarea id="q7" maxlength="100" rows="3" placeholder="Maximum 100 caract√®res"></textarea>
                            <small style="color: #666;">Caract√®res restants: <span id="q7Count">100</span></small>
                        </div>

                        <button type="submit" id="submitSatisfactionBtn" class="btn btn-success" disabled style="opacity: 0.5; cursor: not-allowed;">üì§ Envoyer mon √©valuation</button>
                    </form>

                    <div id="thankYouMessage" style="display: none;"></div>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #3270AF;">‚öôÔ∏è Configuration de Production</h2>
                
                <div class="alert alert-warning" style="background: #fff3cd; border: 2px solid #ffc107;">
                    ‚ö†Ô∏è <strong>Version de Production (v1.9)</strong><br>
                    Les param√®tres de connexion sont configur√©s directement dans le code source de l'application.<br>
                    Pour modifier ces valeurs, contactez l'administrateur syst√®me.
                </div>

                <div style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #3270AF; margin-bottom: 15px;">üîó Configuration Make.com</h3>
                    
                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e9ecef;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">URL Webhook Formation (POST) :</label>
                        <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Utilis√© pour : <strong>Cr√©er une formation</strong> et <strong>Enregistrer les satisfactions</strong></p>
                        <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #dee2e6; font-family: 'Courier New', monospace; font-size: 11px; word-break: break-all; margin-bottom: 10px;" id="webhookDisplay">Non configur√©e</div>
                        <button class="btn btn-secondary" onclick="copyWebhookURL()" style="margin: 0;">üìã Copier l'URL</button>
                    </div>

                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e9ecef;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">URL Webhook R√©cup√©ration (GET) :</label>
                        <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Utilis√© pour : <strong>R√©cup√©rer une formation existante</strong></p>
                        <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #dee2e6; font-family: 'Courier New', monospace; font-size: 11px; word-break: break-all; margin-bottom: 10px;" id="webhookGetDisplay">Non configur√©e</div>
                        <button class="btn btn-secondary" onclick="copyWebhookGetURL()" style="margin: 0;">üìã Copier l'URL</button>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Cl√© API Make :</label>
                        <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #dee2e6; font-family: 'Courier New', monospace; font-size: 11px; word-break: break-all; margin-bottom: 10px;" id="apiKeyDisplay">Non configur√©e</div>
                        <button class="btn btn-secondary" onclick="copyAPIKey()" style="margin: 0;">üìã Copier la cl√©</button>
                    </div>
                </div>

                <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #2e7d32; margin-bottom: 15px;">‚úÖ Synchronisation SharePoint</h3>
                    <p style="color: #1b5e20; margin-bottom: 10px;">
                        <strong>√âtat :</strong> <span style="color: #4caf50; font-weight: bold;">‚óè ACTIV√âE</span>
                    </p>
                    <p style="font-size: 13px; color: #2e7d32;">
                        Les donn√©es sont automatiquement synchronis√©es avec SharePoint Online via Make.com d√®s la cr√©ation des formations et l'envoi des questionnaires de satisfaction.
                    </p>
                </div>

                <div style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                    <h3 style="color: #3270AF; margin-bottom: 15px;">üìä Donn√©es & Stockage</h3>
                    
                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e9ecef;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Formations enregistr√©es localement :</label>
                        <div style="color: #666;"><strong id="formationCount">0</strong> formation(s)</div>
                        <p style="font-size: 13px; color: #999; margin-top: 8px;">üí° Stock√©es dans le navigateur (localStorage) et synchronis√©es avec SharePoint</p>
                    </div>
                </div>

                <div class="version-info">
                    <div class="version-number">Version 2.0.0</div>
                    <div class="version-date">5 novembre 2025</div>
                    <div style="font-size: 13px; color: #666; margin-top: 10px;">
                        <strong>üéâ Version 2.0.0 - Syst√®me simplifi√© :</strong><br>
                        ‚Ä¢ Nouvelle architecture Make.com ultra simplifi√©e<br>
                        ‚Ä¢ Stockage JSON direct dans SharePoint<br>
                        ‚Ä¢ Webhooks optimis√©s pour performances maximales<br>
                        ‚Ä¢ Tous les bugs de synchronisation r√©solus
                    </div>
                    <div class="copyright">
                        ¬© 2025 WeN√©goce - Tous droits r√©serv√©s<br>
                        Formation Manager est une solution propri√©taire d√©velopp√©e par WeN√©goce
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'email</h3>
                <button class="btn-icon" onclick="closeEmailModal()" style="color: white;">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Objet de l'email *</label>
                    <input type="text" id="emailSubjectEdit" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Corps du message *</label>
                    <textarea id="emailBodyEdit" rows="12" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: 'Segoe UI', sans-serif; line-height: 1.6;"></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn" onclick="saveEmailChanges()">
                        ‚úì Termin√©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="reminderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìß Relancer le stagiaire</h3>
                <button class="btn-icon" onclick="closeReminderModal()" style="color: white;">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="reminderInfo" class="info-display" style="margin-bottom: 20px;"></div>
                
                <div class="form-group">
                    <label>Objet de l'email *</label>
                    <input type="text" id="reminderSubjectEdit" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Corps du message *</label>
                    <textarea id="reminderBodyEdit" rows="12" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: 'Segoe UI', sans-serif; line-height: 1.6;"></textarea>
                </div>
                
                <div class="alert alert-info" style="margin-top: 20px;">
                    ‚ÑπÔ∏è <strong>Note :</strong> Le lien personnalis√© sera automatiquement ins√©r√© √† la place de [LIEN]
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn" onclick="closeReminderModal()" style="background: #6c757d; margin-right: 10px;">
                        Annuler
                    </button>
                    <button class="btn" onclick="sendReminder()">
                        üìß Envoyer la relance
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ========================================
        // FORMATION MANAGER v2.0.0
        // Version de PRODUCTION (5 novembre 2025)
        // 
        // üéâ NOUVELLE VERSION MAJEURE v2.0.0 :
        // - ‚úÖ Architecture Make.com compl√®tement simplifi√©e (90% de modules en moins)
        // - ‚úÖ Stockage JSON direct dans SharePoint (1 seul champ texte)
        // - ‚úÖ Nouveaux webhooks optimis√©s pour performances maximales
        // - ‚úÖ Flux POST : 3 modules (au lieu de 15+)
        // - ‚úÖ Flux GET : 7 modules avec Router (au lieu de 20+)
        // - ‚úÖ Tous les bugs de synchronisation r√©solus
        // - ‚úÖ Plus d'Iterator, plus d'Array Aggregator, plus de complexit√©
        // 
        // Historique :
        // v1.9.3 - FIX : R√©cup√©ration correcte de la pr√©sence et commentaire formateur
        // v1.9.2 - Webhooks Make.com configur√©s avec URLs r√©elles
        // v1.9.1 - Mise √† jour de l'URL du logo vers GitHub
        // v1.9.0 - Configuration des webhooks en dur dans le code source
        // 
        // Corrections v1.8.7 :
        // - FIX : Suppression du titre "Attestation de formation" dans la page de remerciement apr√®s l'envoi du questionnaire
        // - Am√©lioration du message de remerciement pour le cas o√π le stagiaire a d√©j√† r√©pondu
        // - Le titre est masqu√© automatiquement quand on affiche le message de remerciement
        // 
        // Corrections v1.8.6 :
        // - FIX : Alignement des labels sur le plus grand ("Commentaire Formateur") - largeur de 230px au lieu de 180px
        // - FIX : Uniformisation de la police de la valeur "Pr√©sence" - retrait du style gras (strong) pour la coh√©rence avec les autres valeurs
        // - Conservation de la couleur pour la valeur Pr√©sence (vert/rouge/gris) mais sans gras
        // 
        // Corrections v1.8.5 :
        // - FIX : Affichage correct de la valeur "Pr√©sence" depuis le champ "Presence" de la base
        // - FIX : Ajout du champ "Commentaire Formateur" toujours visible avec la valeur de "CommentaireFormateur"
        // - Am√©lioration de la priorit√© de lecture des champs (majuscule SharePoint d'abord, puis minuscule local)
        // - Ajout de logs console pour d√©boguer l'affichage des donn√©es
        // - Correction de la condition pour afficher le formulaire de satisfaction (utilise presenceValue)
        // 
        // Corrections v1.8.4 :
        // - FIX : Am√©lioration des contr√¥les de validation des champs obligatoires
        //   * Contour rouge avec message d'erreur en dessous quand le champ n'est pas rempli
        //   * Fond vert clair quand le champ est correct
        // - FIX : Le bouton "Feuille de pr√©sence" est d√©sactiv√© tant que :
        //   * Les champs obligatoires ne sont pas tous remplis
        //   * Il n'y a pas au moins un stagiaire
        // - FIX : Le bouton "Ajouter un stagiaire" fonctionne √† nouveau correctement
        // - FIX : Erreur de syntaxe JavaScript corrig√©e
        // 
        // Corrections v1.8.3 :
        // - FIX : Affichage correct de la valeur "Pr√©sence" dans l'attestation de pr√©sence
        // - FIX : Affichage du "Commentaire Formateur" dans l'attestation de pr√©sence
        // - Support des deux formats de donn√©es (local: presence/commentaire, SharePoint: Presence/CommentaireFormateur)
        // - FIX : Le bouton "Envoyer mon √©valuation" n'est activ√© que si les 5 questions obligatoires sont remplies
        // 
        // Corrections v1.8.2 :
        // - FIX : Les modifications du mod√®le de mail sont maintenant correctement conserv√©es
        // - Les variables emailSubjectGlobal et emailBodyGlobal ne sont plus √©cras√©es lors du rafra√Æchissement
        // - R√©initialisation automatique des mod√®les lors de la cr√©ation d'une nouvelle formation
        // 
        // Corrections v1.8.1 :
        // - FIX : Suppression du double envoi des donn√©es de satisfaction √† Make/SharePoint
        // - Suppression du gestionnaire d'√©v√©nements obsol√®te qui causait un envoi avec StagiaireID undefined
        // 
        // Nouveaut√©s v1.8 :
        // - Lien cliquable dans le mod√®le de mail (affichage)
        // - Remplacement de "Statut" par "Pr√©sence" dans l'onglet Stagiaire
        // - Ajout du "Commentaire Formateur" dans l'onglet Stagiaire
        // - FIX CRITIQUE : Les donn√©es de satisfaction sont maintenant sauvegard√©es localement dans l'objet stagiaire
        // - FIX CRITIQUE : La synchronisation SharePoint est activ√©e par d√©faut pour assurer l'envoi √† Make
        // - Les donn√©es Q1-Q7 et commentaires sont maintenant correctement envoy√©es √† Make/SharePoint
        // ========================================
        
        let stagiaireCount = 0;
        let formationsData = [];
        let currentFormationId = null;
        const MAX_STAGIAIRES = 10;
        let emailSubjectGlobal = '';
        let emailBodyGlobal = '';
        let currentFormationData = null;
        
        // ‚ö†Ô∏è CONFIGURATION PRODUCTION - URLs FIXES ‚ö†Ô∏è
        // IMPORTANT : Remplacez ces URLs par vos v√©ritables webhooks Make.com avant d√©ploiement
        // Ces valeurs sont fixes dans l'application pour permettre aux stagiaires d'utiliser l'app sans configuration
        
        // ‚ö†Ô∏è CONFIGURATION PRODUCTION - URLs CONFIGUR√âES v2.0.0 ‚ö†Ô∏è
        // WeN√©goce - Formation Manager v2.0.0
        // Syst√®me simplifi√© : JSON stock√© dans SharePoint
        
        // Webhook POST - Pour cr√©er formations et enregistrer satisfactions
        const WEBHOOK_URL = 'https://hook.eu2.make.com/cfbp7ax6nn9tprkret24fh53yf8aymsi';
        
        // Webhook GET - Pour r√©cup√©rer les formations existantes
        const WEBHOOK_GET_URL = 'https://hook.eu2.make.com/otdeapvo7w4q8his7cv6e00vqydl73md';
        
        // Cl√© API - Non utilis√©e (pas configur√©e dans Make.com)
        const API_KEY = '';
        
        // Synchronisation SharePoint activ√©e par d√©faut
        const ENABLE_SHAREPOINT_SYNC = true;

        document.addEventListener('DOMContentLoaded', function() {
            loadFormations();
            addStagiaire();
            initStarRatings();
            initCharCounters();
            checkURLParams();
            initEventListeners();
            initTypeFormationToggle();
            initializeSettings();
            setTodayDate();
        });

        function setTodayDate() {
            const dateInput = document.getElementById('dateFormation');
            if (dateInput && !dateInput.value) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${yyyy}-${mm}-${dd}`;
            }
        }

        function initEventListeners() {
            document.querySelectorAll('.tab').forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });

            const btnAdd = document.getElementById('btnAddStagiaire');
            if (btnAdd) {
                btnAdd.addEventListener('click', function(e) {
                    e.preventDefault();
                    addStagiaire();
                });
            }

            const formateurForm = document.getElementById('formateurForm');
            if (formateurForm) {
                formateurForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleFormateurSubmit();
                });
            }

            const champsObligatoires = [
                'raisonSociale',
                'themeFormation',
                'nomFormateur',
                'dateFormation',
                'heureDebut',
                'heureFin'
            ];

            champsObligatoires.forEach(function(fieldId) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        validateRequiredField(this);
                    });
                    field.addEventListener('input', function() {
                        validateRequiredField(this);
                    });
                }
            });

            const heureDebut = document.getElementById('heureDebut');
            const heureFin = document.getElementById('heureFin');
            
            if (heureDebut) {
                heureDebut.addEventListener('change', function() {
                    validateHeures();
                });
            }
            
            if (heureFin) {
                heureFin.addEventListener('change', function() {
                    validateHeures();
                });
                heureFin.addEventListener('blur', function() {
                    validateHeures();
                });
            }

            const dateFormationInput = document.getElementById('dateFormation');
            if (dateFormationInput) {
                dateFormationInput.addEventListener('change', function() {
                    validateDateFormation();
                });
            }

            const presenceForm = document.getElementById('presenceForm');
            if (presenceForm) {
                presenceForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handlePresenceSubmit();
                });
            }

            // Note: Le gestionnaire d'√©v√©nements pour satisfactionForm est attach√© dynamiquement
            // dans la fonction loadStagiaireView() pour avoir acc√®s √† formationId et stagiaireId

            const referenceJira = document.getElementById('referenceJira');
            if (referenceJira) {
                referenceJira.addEventListener('blur', function() {
                    if (this.value.trim()) {
                        validateJiraReference(this);
                    }
                });
            }
        }

        function validateRequiredField(input) {
            const errorMessage = document.getElementById('error-' + input.id);
            if (!input.value.trim()) {
                input.classList.add('invalid');
                input.classList.remove('valid');
                if (errorMessage) errorMessage.classList.add('show');
            } else {
                input.classList.remove('invalid');
                input.classList.add('valid');
                if (errorMessage) errorMessage.classList.remove('show');
            }
            checkFormValidity();
        }

        function checkFormValidity() {
            const raisonSociale = document.getElementById('raisonSociale');
            const themeFormation = document.getElementById('themeFormation');
            const nomFormateur = document.getElementById('nomFormateur');
            const dateFormation = document.getElementById('dateFormation');
            const heureDebut = document.getElementById('heureDebut');
            const heureFin = document.getElementById('heureFin');
            const btnFeuillePresence = document.getElementById('btnFeuillePresence');
            
            // V√©rifier que tous les champs obligatoires sont remplis
            const allFieldsValid = raisonSociale.value.trim() && 
                                   themeFormation.value.trim() && 
                                   nomFormateur.value.trim() && 
                                   dateFormation.value && 
                                   heureDebut.value && 
                                   heureFin.value;
            
            // V√©rifier qu'il y a au moins un stagiaire
            const hasStagiaires = stagiaireCount > 0;
            
            // Activer le bouton seulement si tout est valide
            if (allFieldsValid && hasStagiaires) {
                btnFeuillePresence.disabled = false;
                btnFeuillePresence.style.opacity = '1';
                btnFeuillePresence.style.cursor = 'pointer';
            } else {
                btnFeuillePresence.disabled = true;
                btnFeuillePresence.style.opacity = '0.5';
                btnFeuillePresence.style.cursor = 'not-allowed';
            }
        }

        function validateEmail(input) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (input.value.trim() && !emailRegex.test(input.value)) {
                showError(input, 'Format email invalide');
            } else if (input.value.trim()) {
                clearError(input);
                input.style.borderColor = '#28a745';
            }
        }

        function validateJiraReference(input) {
            const jiraRegex = /^(TIC|SMC|SNC)-\d+$/i;
            if (input.value.trim() && !jiraRegex.test(input.value)) {
                showError(input, 'Format JIRA invalide (ex: TIC-123)');
            } else if (input.value.trim()) {
                clearError(input);
                input.style.borderColor = '#28a745';
            }
        }

        function validateDateFormation() {
            const input = document.getElementById('dateFormation');
            const selectedDate = new Date(input.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const minDate = new Date();
            minDate.setDate(today.getDate() - 7);
            
            if (selectedDate < minDate) {
                const minDateStr = minDate.toLocaleDateString('fr-FR');
                showError(input, 'La formation est trop ancienne. Date minimum accept√©e : ' + minDateStr);
            } else {
                clearError(input);
                input.style.borderColor = '#28a745';
            }
        }

        function validateHeures() {
            const heureDebut = document.getElementById('heureDebut');
            const heureFin = document.getElementById('heureFin');
            const errorDebut = document.getElementById('error-heureDebut');
            const errorFin = document.getElementById('error-heureFin');
            
            // V√©rifier que les deux champs sont remplis
            if (!heureDebut.value) {
                heureDebut.classList.add('invalid');
                heureDebut.classList.remove('valid');
                if (errorDebut) errorDebut.classList.add('show');
                checkFormValidity();
                return;
            } else {
                heureDebut.classList.remove('invalid');
                heureDebut.classList.add('valid');
                if (errorDebut) errorDebut.classList.remove('show');
            }
            
            if (!heureFin.value) {
                heureFin.classList.add('invalid');
                heureFin.classList.remove('valid');
                if (errorFin) errorFin.classList.add('show');
                checkFormValidity();
                return;
            }
            
            // V√©rifier que l'heure de fin est apr√®s l'heure de d√©but
            if (heureDebut.value && heureFin.value) {
                const debut = heureDebut.value.split(':');
                const fin = heureFin.value.split(':');
                const minutesDebut = parseInt(debut[0]) * 60 + parseInt(debut[1]);
                const minutesFin = parseInt(fin[0]) * 60 + parseInt(fin[1]);
                
                if (minutesFin <= minutesDebut) {
                    heureFin.classList.add('invalid');
                    heureFin.classList.remove('valid');
                    // Changer le message d'erreur
                    if (errorFin) {
                        errorFin.textContent = 'L\'heure de fin doit √™tre apr√®s l\'heure de d√©but';
                        errorFin.classList.add('show');
                    }
                } else {
                    heureFin.classList.remove('invalid');
                    heureFin.classList.add('valid');
                    if (errorFin) {
                        errorFin.textContent = 'Ce champ est obligatoire';
                        errorFin.classList.remove('show');
                    }
                }
            }
            
            checkFormValidity();
        }

        function showError(input, message) {
            input.style.borderColor = '#dc3545';
            
            const existingError = input.parentElement.querySelector('.error-message');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('small');
            errorDiv.className = 'error-message';
            errorDiv.style.color = '#dc3545';
            errorDiv.style.display = 'block';
            errorDiv.style.marginTop = '5px';
            errorDiv.textContent = message;
            input.parentElement.appendChild(errorDiv);
        }

        function clearError(input) {
            const existingError = input.parentElement.querySelector('.error-message');
            if (existingError) existingError.remove();
            input.style.borderColor = '#e0e0e0';
        }

        function initTypeFormationToggle() {
            const toggle = document.getElementById('typeFormationToggle');
            const labelPresentiel = document.getElementById('labelPresentiel');
            const labelVisio = document.getElementById('labelVisio');
            
            if (toggle) {
                toggle.addEventListener('change', function() {
                    if (this.checked) {
                        labelPresentiel.classList.remove('active');
                        labelVisio.classList.add('active');
                    } else {
                        labelPresentiel.classList.add('active');
                        labelVisio.classList.remove('active');
                    }
                });
            }
        }

        // ========================================
        // ONGLET FORMATIONS
        // ========================================
        async function loadFormationsTab() {
            const loadingDiv = document.getElementById('formationsLoading');
            const listDiv = document.getElementById('formationsList');
            const emptyDiv = document.getElementById('formationsEmpty');
            
            loadingDiv.style.display = 'block';
            listDiv.style.display = 'none';
            emptyDiv.style.display = 'none';
            
            // Charger les formations locales
            let formations = [...formationsData];
            
            // Filtrer les formations :
            // 1. Moins de 3 mois
            // 2. Au moins un stagiaire n'a pas renseign√© l'enqu√™te
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            
            formations = formations.filter(formation => {
                // V√©rifier si la formation a moins de 3 mois
                const formationDate = new Date(formation.date);
                if (formationDate < threeMonthsAgo) return false;
                
                // V√©rifier si au moins un stagiaire n'a pas r√©pondu
                const hasUnansweredStagiaire = formation.stagiaires.some(s => 
                    (s.presence === 'Present' || s.presence === 'Partielle') && !s.satisfaction
                );
                return hasUnansweredStagiaire;
            });
            
            setTimeout(() => {
                loadingDiv.style.display = 'none';
                
                if (formations.length === 0) {
                    emptyDiv.style.display = 'block';
                } else {
                    displayFormationsCards(formations);
                    listDiv.style.display = 'block';
                }
            }, 500);
        }

        function displayFormationsCards(formations) {
            const container = document.getElementById('formationsList');
            container.innerHTML = '';
            
            formations.forEach(formation => {
                const card = createFormationCard(formation);
                container.appendChild(card);
            });
        }

        function createFormationCard(formation) {
            const dateFormation = new Date(formation.date).toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Filtrer les stagiaires qui n'ont pas encore r√©pondu (pr√©sents ou partiels sans satisfaction)
            const stagiairesSansReponse = formation.stagiaires.filter(s => 
                (s.presence === 'Present' || s.presence === 'Partielle') && !s.satisfaction
            );
            
            const card = document.createElement('div');
            card.className = 'formation-card';
            
            let stagiairesList = '';
            stagiairesSansReponse.forEach((stagiaire, index) => {
                stagiairesList += `
                    <div class="stagiaire-item" style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${stagiaire.nom}</strong><br>
                                <small style="color: #666;">${stagiaire.email}</small>
                            </div>
                            <button class="btn" onclick="openReminderModal('${formation.id}', ${index})" style="background: #ff9800;">
                                üìß Relancer le stagiaire
                            </button>
                        </div>
                    </div>
                `;
            });
            
            card.innerHTML = `
                <div class="formation-card-header" style="background: #3270AF; color: white; padding: 15px; border-radius: 8px 8px 0 0;">
                    <div style="margin-bottom: 8px;">
                        <div style="font-size: 14px; opacity: 0.85; font-weight: 500;">${formation.raisonSociale}</div>
                        <div class="formation-card-title" style="font-size: 18px; font-weight: 600; margin-top: 4px;">${formation.theme}</div>
                    </div>
                    <div class="formation-card-date" style="font-size: 13px; opacity: 0.75; font-style: italic; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px; margin-top: 8px;">${dateFormation}</div>
                </div>
                <div class="formation-card-body" style="padding: 15px;">
                    <div>
                        <h4 style="color: #3270AF; margin-bottom: 12px;">Stagiaires en attente de r√©ponse :</h4>
                        ${stagiairesList}
                    </div>
                </div>
            `;
            
            return card;
        }

        function viewFormationDetails(formationId) {
            const formation = formationsData.find(f => f.id === formationId);
            if (!formation) return;
            
            let detailsHTML = '<h3 style="color: #3270AF; margin-bottom: 20px;">D√©tails de la formation</h3>';
            detailsHTML += '<div class="info-display">';
            detailsHTML += `<div class="info-row"><div class="info-label">Formation :</div><div>${formation.theme}</div></div>`;
            detailsHTML += `<div class="info-row"><div class="info-label">Client :</div><div>${formation.raisonSociale}</div></div>`;
            detailsHTML += `<div class="info-row"><div class="info-label">Formateur :</div><div>${formation.nomFormateur}</div></div>`;
            detailsHTML += `<div class="info-row"><div class="info-label">Date :</div><div>${new Date(formation.date).toLocaleDateString('fr-FR')}</div></div>`;
            detailsHTML += '</div>';
            
            detailsHTML += '<h4 style="color: #3270AF; margin: 20px 0 10px;">Liste des stagiaires</h4>';
            formation.stagiaires.forEach((stagiaire, index) => {
                const satisfactionStatus = stagiaire.satisfaction ? '‚úÖ Compl√©t√©e' : '‚è≥ En attente';
                detailsHTML += `
                    <div class="stagiaire-item" style="margin-bottom: 15px;">
                        <div class="stagiaire-header">
                            <span class="stagiaire-number">Stagiaire ${index + 1}</span>
                        </div>
                        <div style="margin-top: 10px;">
                            <div><strong>Nom:</strong> ${stagiaire.nom}</div>
                            <div><strong>Email:</strong> ${stagiaire.email}</div>
                            <div><strong>Pr√©sence:</strong> <span style="color: ${stagiaire.presence === 'Present' ? '#28a745' : '#dc3545'};">${stagiaire.presence || 'Non renseign√©'}</span></div>
                            <div><strong>Satisfaction:</strong> ${satisfactionStatus}</div>
                        </div>
                    </div>
                `;
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üìã D√©tails de la formation</h3>
                        <button class="btn-icon" onclick="this.closest('.modal').remove()" style="color: white;">‚úñ</button>
                    </div>
                    <div class="modal-body">
                        ${detailsHTML}
                        <button class="btn" onclick="this.closest('.modal').remove()" style="margin-top: 20px;">Fermer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function sendLinksForFormation(formationId) {
            const formation = formationsData.find(f => f.id === formationId);
            if (!formation) return;
            
            const presentsCount = formation.stagiaires.filter(s => 
                s.presence === 'Present' || s.presence === 'Partiellement pr√©sent'
            ).length;
            
            if (presentsCount === 0) {
                alert('‚ö†Ô∏è Aucun stagiaire pr√©sent ou partiellement pr√©sent. Veuillez d\'abord compl√©ter les pr√©sences dans l\'espace formateur.');
                return;
            }
            
            if (confirm(`Voulez-vous envoyer les liens d'√©valuation aux ${presentsCount} stagiaire(s) pr√©sent(s) ?`)) {
                formation.stagiaires.forEach((stagiaire, index) => {
                    if (stagiaire.presence === 'Present' || stagiaire.presence === 'Partiellement pr√©sent') {
                        sendEmailToStagiaire(stagiaire, formationId, index);
                    }
                });
                alert('‚úÖ Les liens ont √©t√© g√©n√©r√©s ! Vos emails par d√©faut vont s\'ouvrir.');
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
            const activeContent = document.getElementById(tabName);
            
            if (activeTab) activeTab.classList.add('active');
            if (activeContent) activeContent.classList.add('active');
            
            if (tabName === 'export') {
                displayFormationsList();
            }
            
            if (tabName === 'settings') {
                updateFormationCount();
            }
            
            if (tabName === 'formations') {
                loadFormationsTab();
            }
        }

        function addStagiaire() {
            if (stagiaireCount >= MAX_STAGIAIRES) {
                alert('‚ö†Ô∏è Maximum de ' + MAX_STAGIAIRES + ' stagiaires atteint');
                return;
            }
            
            stagiaireCount++;
            const container = document.getElementById('stagiairesList');
            const item = document.createElement('div');
            item.className = 'stagiaire-item';
            item.id = 'stagiaire-' + stagiaireCount;
            
            item.innerHTML = `
                <div class="stagiaire-header">
                    <span class="stagiaire-number">Stagiaire ${stagiaireCount}</span>
                    <button type="button" class="btn-remove" onclick="removeStagiaire(${stagiaireCount})">üóëÔ∏è Supprimer</button>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>Nom complet *</label>
                        <input type="text" id="nomStagiaire${stagiaireCount}" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="emailStagiaire${stagiaireCount}" required>
                    </div>
                </div>
            `;
            
            container.appendChild(item);
            
            // Ajouter les event listeners pour la validation
            const emailInput = document.getElementById('emailStagiaire' + stagiaireCount);
            if (emailInput) {
                emailInput.addEventListener('blur', function() {
                    validateEmail(this);
                });
                emailInput.addEventListener('input', function() {
                    if (this.value.trim()) {
                        clearError(this);
                    }
                });
            }
            
            // V√©rifier la validit√© du formulaire apr√®s l'ajout
            checkFormValidity();
        }

        function removeStagiaire(id) {
            const item = document.getElementById('stagiaire-' + id);
            if (item) {
                item.remove();
                stagiaireCount--;
                renumberStagiaires();
                // V√©rifier la validit√© du formulaire apr√®s la suppression
                checkFormValidity();
            }
        }

        function renumberStagiaires() {
            const items = document.querySelectorAll('.stagiaire-item');
            stagiaireCount = 0;
            items.forEach((item, index) => {
                stagiaireCount++;
                item.id = 'stagiaire-' + stagiaireCount;
                const number = item.querySelector('.stagiaire-number');
                if (number) number.textContent = 'Stagiaire ' + stagiaireCount;
                
                const removeBtn = item.querySelector('.btn-remove');
                if (removeBtn) {
                    removeBtn.onclick = function() { removeStagiaire(stagiaireCount); };
                }
                
                const nomInput = item.querySelector('input[id^="nomStagiaire"]');
                const emailInput = item.querySelector('input[id^="emailStagiaire"]');
                if (nomInput) nomInput.id = 'nomStagiaire' + stagiaireCount;
                if (emailInput) emailInput.id = 'emailStagiaire' + stagiaireCount;
            });
        }

        async function handleFormateurSubmit() {
            const raisonSociale = document.getElementById('raisonSociale').value.trim();
            const theme = document.getElementById('themeFormation').value.trim();
            const referenceJira = document.getElementById('referenceJira').value.trim();
            const nomFormateur = document.getElementById('nomFormateur').value.trim();
            const dateFormation = document.getElementById('dateFormation').value;
            const typeToggle = document.getElementById('typeFormationToggle').checked;
            const typeFormation = typeToggle ? 'Visio' : 'Pr√©sentiel';
            const heureDebut = document.getElementById('heureDebut').value;
            const heureFin = document.getElementById('heureFin').value;
            
            if (!raisonSociale || !theme || !nomFormateur || !dateFormation || !heureDebut || !heureFin) {
                alert('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (referenceJira) {
                const jiraRegex = /^(TIC|SMC|SNC)-\d+$/i;
                if (!jiraRegex.test(referenceJira)) {
                    alert('‚ö†Ô∏è Format de r√©f√©rence JIRA invalide. Utilisez le format TIC-123, SMC-456 ou SNC-789');
                    return;
                }
            }
            
            const selectedDate = new Date(dateFormation);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const minDate = new Date();
            minDate.setDate(today.getDate() - 7);
            
            if (selectedDate < minDate) {
                alert('‚ö†Ô∏è La date de formation est trop ancienne (plus de 7 jours avant aujourd\'hui)');
                return;
            }
            
            const debut = heureDebut.split(':');
            const fin = heureFin.split(':');
            const minutesDebut = parseInt(debut[0]) * 60 + parseInt(debut[1]);
            const minutesFin = parseInt(fin[0]) * 60 + parseInt(fin[1]);
            
            if (minutesFin <= minutesDebut) {
                alert('‚ö†Ô∏è L\'heure de fin doit √™tre apr√®s l\'heure de d√©but');
                return;
            }
            
            const stagiaires = [];
            let hasError = false;
            
            for (let i = 1; i <= stagiaireCount; i++) {
                const nomInput = document.getElementById('nomStagiaire' + i);
                const emailInput = document.getElementById('emailStagiaire' + i);
                
                if (nomInput && emailInput) {
                    const nom = nomInput.value.trim();
                    const email = emailInput.value.trim();
                    
                    // V√©rifier que le nom est rempli
                    if (!nom) {
                        showError(nomInput, 'Ce champ est obligatoire');
                        hasError = true;
                    }
                    
                    // V√©rifier que l'email est rempli
                    if (!email) {
                        showError(emailInput, 'Ce champ est obligatoire');
                        hasError = true;
                    } else {
                        // V√©rifier le format de l'email
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(email)) {
                            showError(emailInput, 'Format email invalide');
                            hasError = true;
                        }
                    }
                    
                    if (nom && email) {
                        // G√©n√©rer un ID unique pour chaque stagiaire
                        const stagiaireId = 'STG-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                        stagiaires.push({
                            id: stagiaireId,
                            nom: nom,
                            email: email,
                            lien: null, // Sera g√©n√©r√© apr√®s la cr√©ation de la formation
                            presence: null,
                            commentaire: '',
                            satisfaction: null
                        });
                    }
                }
            }
            
            if (hasError) {
                alert('‚ö†Ô∏è Veuillez corriger les erreurs dans le formulaire');
                return;
            }
            
            if (stagiaires.length === 0) {
                alert('‚ö†Ô∏è Veuillez ajouter au moins un stagiaire');
                return;
            }
            
            // V√©rifier que le webhook SharePoint est configur√©
            if (!WEBHOOK_URL) {
                alert('‚ö†Ô∏è Erreur : Le webhook SharePoint n\'est pas configur√©.\nVeuillez configurer l\'URL du webhook dans l\'onglet Param√®tres avant de cr√©er une formation.');
                return;
            }
            
            currentFormationId = 'FRM-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            currentFormationData = {
                id: currentFormationId,
                raisonSociale: raisonSociale,
                theme: theme,
                referenceJira: referenceJira,
                nomFormateur: nomFormateur,
                date: dateFormation,
                type: typeFormation,
                heureDebut: heureDebut,
                heureFin: heureFin,
                stagiaires: stagiaires
            };
            
            // G√©n√©rer les liens personnalis√©s pour chaque stagiaire
            const baseUrl = window.location.origin + window.location.pathname;
            currentFormationData.stagiaires.forEach(stagiaire => {
                stagiaire.lien = `${baseUrl}?fid=${currentFormationId}&stid=${stagiaire.id}`;
            });
            
            // Afficher un indicateur de chargement
            const submitButton = document.querySelector('#formateurForm button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '‚è≥ Enregistrement en cours...';
            
            try {
                // Envoyer vers SharePoint AVANT de continuer
                const success = await sendFormationToSharePoint(currentFormationData);
                
                if (!success) {
                    throw new Error('√âchec de l\'enregistrement dans SharePoint');
                }
                
                // Sauvegarder localement seulement si SharePoint a r√©ussi
                formationsData.push(currentFormationData);
                saveFormations();
                
                // Afficher la feuille de pr√©sence
                document.getElementById('preparationForm').style.display = 'none';
                document.getElementById('postFormationSection').style.display = 'block';
                
                displayFormationInfo();
                displayPresenceForm();
                
                window.scrollTo(0, 0);
                
            } catch (error) {
                alert('‚ùå Erreur lors de l\'enregistrement de la formation.\n' + error.message + '\n\nVeuillez v√©rifier votre connexion et la configuration du webhook dans Param√®tres.');
                console.error('Erreur:', error);
            } finally {
                // Restaurer le bouton
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        }

        function displayFormationInfo() {
            const info = document.getElementById('formationInfo');
            const formation = currentFormationData;
            
            info.innerHTML = `
                <div class="info-row"><div class="info-label">Client :</div><div>${formation.raisonSociale}</div></div>
                <div class="info-row"><div class="info-label">Formation :</div><div>${formation.theme}</div></div>
                ${formation.referenceJira ? `<div class="info-row"><div class="info-label">R√©f√©rence JIRA :</div><div>${formation.referenceJira}</div></div>` : ''}
                <div class="info-row"><div class="info-label">Formateur :</div><div>${formation.nomFormateur}</div></div>
                <div class="info-row"><div class="info-label">Date :</div><div>${new Date(formation.date).toLocaleDateString('fr-FR')}</div></div>
                <div class="info-row"><div class="info-label">Type :</div><div>${formation.type}</div></div>
                <div class="info-row"><div class="info-label">Horaires :</div><div>${formation.heureDebut} - ${formation.heureFin}</div></div>
                <div class="info-row"><div class="info-label">Nombre de stagiaires :</div><div>${formation.stagiaires.length}</div></div>
            `;
        }

        function displayPresenceForm() {
            const container = document.getElementById('presenceList');
            container.innerHTML = '';
            
            currentFormationData.stagiaires.forEach((stagiaire, index) => {
                const div = document.createElement('div');
                div.className = 'stagiaire-item';
                div.innerHTML = `
                    <div class="stagiaire-header">
                        <span class="stagiaire-number">${stagiaire.nom}</span>
                    </div>
                    <div class="form-group">
                        <label>Pr√©sence *</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="presence${index}" value="Present" required>
                                <span>‚úÖ Present</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="presence${index}" value="Absent" required>
                                <span>‚ùå Absent</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="presence${index}" value="Partielle" required>
                                <span>‚ö†Ô∏è Partielle</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Commentaire du formateur</label>
                        <textarea id="commentaire${index}" rows="2" placeholder="Observations particuli√®res sur ce stagiaire..."></textarea>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function handlePresenceSubmit() {
            currentFormationData.stagiaires.forEach((stagiaire, index) => {
                const presenceInputs = document.getElementsByName('presence' + index);
                const commentaireInput = document.getElementById('commentaire' + index);
                
                let presenceValue = null;
                presenceInputs.forEach(input => {
                    if (input.checked) presenceValue = input.value;
                });
                
                stagiaire.presence = presenceValue;
                stagiaire.commentaire = commentaireInput ? commentaireInput.value.trim() : '';
            });
            
            saveFormations();
            
            // Masquer la section pr√©sence
            document.getElementById('postFormationSection').style.display = 'none';
            
            // R√©initialiser les variables d'email pour cette nouvelle formation
            emailSubjectGlobal = '';
            emailBodyGlobal = '';
            
            // G√©n√©rer et afficher la page d'envoi des emails
            generateEmailLinks();
            
            window.scrollTo(0, 0);
        }

        function generateEmailLinks() {
            const container = document.getElementById('emailLinks');
            const formation = currentFormationData;
            
            // V2.5.0 : Envoyer les donn√©es de pr√©sence et commentaires √† SharePoint
            sendPresenceDataToSharePoint(formation);
            
            const dateFormation = new Date(formation.date).toLocaleDateString('fr-FR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Ne d√©finir les valeurs par d√©faut que si elles sont vides (premier appel)
            // Cela permet de conserver les modifications faites par l'utilisateur
            if (!emailSubjectGlobal) {
                emailSubjectGlobal = `Votre formation ${formation.theme} - attestation et enqu√™te de satisfaction`;
            }
            if (!emailBodyGlobal) {
                emailBodyGlobal = 
                    `Bonjour,\n\n` +
                    `Vous avez particip√© √† la formation ¬´ ${formation.theme} ¬ª anim√©e par ${formation.nomFormateur} le ${dateFormation}.\n\n` +
                    `Afin de finaliser votre dossier, nous vous invitons √† cliquer sur le lien ci-dessous. Vous y trouverez :\n` +
                    `‚Äì votre attestation de pr√©sence,\n` +
                    `‚Äì ainsi qu'une br√®ve enqu√™te de satisfaction (moins d'une minute √† remplir).\n\n` +
                    `üëâ [LIEN]\n\n` +
                    `Nous vous remercions pour votre participation et restons √† votre disposition pour toute question compl√©mentaire.\n\n` +
                    `Bien cordialement,`;
            }
            
            container.innerHTML = `
                <h2 style="margin-bottom: 20px; color: #3270AF;">üìß Envoi des liens aux stagiaires</h2>
                
                <div class="alert alert-success" style="margin-bottom: 30px;">
                    ‚úÖ Les pr√©sences ont √©t√© enregistr√©es avec succ√®s ! Vous pouvez maintenant envoyer les emails aux stagiaires.
                </div>
                
                <div style="background: #e7f3ff; padding: 20px; border-radius: 8px; border-left: 4px solid #3270AF; margin-bottom: 20px;">
                    <strong style="color: #3270AF;">üìß Mod√®le d'email</strong>
                    <button class="btn-edit" style="margin-left: 10px;" onclick="openEmailModal()">
                        ‚úèÔ∏è Personnaliser l'email
                    </button>
                    <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px; font-family: 'Segoe UI', sans-serif;">
                        <div style="margin-bottom: 10px;"><strong>Objet :</strong> ${emailSubjectGlobal}</div>
                        <div style="white-space: pre-wrap; color: #666; font-size: 14px;">${emailBodyGlobal.replace('[LIEN]', '<a href="#" style="color: #3270AF; text-decoration: underline;" onclick="event.preventDefault(); alert(\'Ce lien sera remplac√© par le lien personnalis√© du stagiaire lors de l\\\'envoi de l\\\'email\');">üîó Lien personnalis√© du stagiaire</a>')}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #3270AF;">
                    <strong style="color: #3270AF;">üìß Envoi individuel par stagiaire</strong><br>
                    <small style="color: #666;">Chaque stagiaire recevra un email avec uniquement son lien personnel</small>
                    <div style="margin-top: 15px;" id="individualEmailsList"></div>
                </div>
            `;

            // Cr√©er la liste des boutons individuels
            const individualList = document.getElementById('individualEmailsList');
            formation.stagiaires.forEach((stagiaire, index) => {
                // Utiliser le lien stock√© dans les donn√©es du stagiaire
                const link = stagiaire.lien;
                
                const div = document.createElement('div');
                div.style.cssText = 'background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;';
                
                div.innerHTML = `
                    <div>
                        <strong style="color: #333;">${stagiaire.nom}</strong><br>
                        <small style="color: #666;">${stagiaire.email}</small><br>
                        <small style="color: #999;">Pr√©sence : <strong style="color: ${stagiaire.presence === 'Present' ? '#28a745' : '#666'};">${stagiaire.presence}</strong></small>
                    </div>
                    <button class="btn" style="margin: 0; padding: 10px 20px; font-size: 14px;" onclick="sendIndividualEmail('${stagiaire.id}')">
                        üìß Envoyer l'email
                    </button>
                `;
                
                individualList.appendChild(div);
            });

            document.getElementById('linksGenerated').style.display = 'block';
        }

        function openEmailModal() {
            document.getElementById('emailSubjectEdit').value = emailSubjectGlobal;
            document.getElementById('emailBodyEdit').value = emailBodyGlobal;
            document.getElementById('emailModal').style.display = 'block';
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }

        function saveEmailChanges() {
            emailSubjectGlobal = document.getElementById('emailSubjectEdit').value;
            emailBodyGlobal = document.getElementById('emailBodyEdit').value;
            closeEmailModal();
            generateEmailLinks();
        }

        function sendIndividualEmail(stagiaireId) {
            const formation = currentFormationData;
            const stagiaire = formation.stagiaires.find(s => s.id === stagiaireId);
            
            if (!stagiaire) {
                alert('‚ùå Erreur : Stagiaire non trouv√©');
                return;
            }
            
            // Utiliser le lien stock√© dans les donn√©es du stagiaire
            const link = stagiaire.lien;
            
            const subject = encodeURIComponent(emailSubjectGlobal);
            const body = encodeURIComponent(emailBodyGlobal.replace('[LIEN]', link));
            
            window.location.href = `mailto:${stagiaire.email}?subject=${subject}&body=${body}`;
        }

        // ========================================
        // RELANCE STAGIAIRES
        // ========================================
        let currentReminderFormationId = null;
        let currentReminderStagiaireId = null;

        function openReminderModal(formationId, stagiaireIndex) {
            const formation = formationsData.find(f => f.id === formationId);
            if (!formation) return;
            
            const stagiairesSansReponse = formation.stagiaires.filter(s => 
                (s.presence === 'Present' || s.presence === 'Partielle') && !s.satisfaction
            );
            const stagiaire = stagiairesSansReponse[stagiaireIndex];
            
            if (!stagiaire) return;
            
            currentReminderFormationId = formationId;
            currentReminderStagiaireId = stagiaire.id;
            
            // Informations de la formation
            const dateFormation = new Date(formation.date).toLocaleDateString('fr-FR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('reminderInfo').innerHTML = `
                <div class="info-row"><div class="info-label">Formation :</div><div>${formation.theme}</div></div>
                <div class="info-row"><div class="info-label">Date :</div><div>${dateFormation}</div></div>
                <div class="info-row"><div class="info-label">Stagiaire :</div><div>${stagiaire.nom}</div></div>
                <div class="info-row"><div class="info-label">Email :</div><div>${stagiaire.email}</div></div>
            `;
            
            // Texte de relance par d√©faut
            const subject = `Relance - Enqu√™te de satisfaction formation ${formation.theme}`;
            const body = 
                `Bonjour,\n\n` +
                `La mesure de votre satisfaction est un √©l√©ment important pour nous permettre d'√©valuer la formation ${formation.theme} que vous avez suivie le ${dateFormation}.\n\n` +
                `Ainsi, nous vous remercions de bien vouloir r√©pondre √† un rapide questionnaire en cliquant sur le lien : [LIEN]\n\n` +
                `Vous souhaitant une tr√®s bonne journ√©e,\n` +
                `Tr√®s Cordialement`;
            
            document.getElementById('reminderSubjectEdit').value = subject;
            document.getElementById('reminderBodyEdit').value = body;
            
            document.getElementById('reminderModal').style.display = 'block';
        }

        function closeReminderModal() {
            document.getElementById('reminderModal').style.display = 'none';
            currentReminderFormationId = null;
            currentReminderStagiaireId = null;
        }

        function sendReminder() {
            if (!currentReminderFormationId || !currentReminderStagiaireId) return;
            
            const formation = formationsData.find(f => f.id === currentReminderFormationId);
            if (!formation) return;
            
            const stagiaire = formation.stagiaires.find(s => s.id === currentReminderStagiaireId);
            if (!stagiaire) return;
            
            // Utiliser le lien stock√© dans les donn√©es du stagiaire
            const link = stagiaire.lien;
            
            const subject = document.getElementById('reminderSubjectEdit').value;
            const body = document.getElementById('reminderBodyEdit').value.replace('[LIEN]', link);
            
            const mailtoLink = `mailto:${stagiaire.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            window.location.href = mailtoLink;
            
            closeReminderModal();
        }

        // ========================================
        // ONGLET STAGIAIRE
        // ========================================
        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const formationId = urlParams.get('fid');
            const stagiaireId = urlParams.get('stid'); // Utiliser l'ID au lieu de l'index
            
            if (formationId && stagiaireId) {
                // Mode stagiaire : masquer tous les onglets sauf "Espace Stagiaire"
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    if (tab.getAttribute('data-tab') !== 'stagiaire') {
                        tab.style.display = 'none';
                    }
                });
                
                switchTab('stagiaire');
                loadStagiaireView(formationId, stagiaireId);
            }
        }

        async function loadStagiaireView(formationId, stagiaireId) {
            let formation = formationsData.find(f => f.id === formationId);
            
            // Si pas trouv√©e en local et webhook configur√©, essayer de r√©cup√©rer depuis SharePoint
            if (!formation && WEBHOOK_GET_URL) {
                try {
                    formation = await getFormationFromSharePoint(formationId, stagiaireId);
                } catch (error) {
                    console.error('Erreur lors de la r√©cup√©ration depuis SharePoint:', error);
                }
            }
            
            if (!formation) {
                document.getElementById('infoFormation').innerHTML = `
                    <div class="alert" style="background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">
                        ‚ùå Formation non trouv√©e ou lien invalide.
                    </div>
                `;
                return;
            }
            
            // Trouver le stagiaire par son ID
            const stagiaire = formation.stagiaires.find(s => s.id === stagiaireId);
            
            if (!stagiaire) {
                document.getElementById('infoFormation').innerHTML = `
                    <div class="alert" style="background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">
                        ‚ùå Stagiaire non trouv√© ou lien invalide.
                    </div>
                `;
                return;
            }
            
            if (stagiaire.satisfaction) {
                displayThankYouMessage();
                return;
            }
            
            const dateFormation = new Date(formation.date).toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Supporter les deux formats de donn√©es (local et SharePoint)
            // V√©rifier d'abord les champs avec majuscule (SharePoint), puis les minuscules (local)
            const presenceValue = stagiaire.Presence || stagiaire.presence || 'Non renseign√©';
            const commentaireValue = stagiaire.CommentaireFormateur || stagiaire.commentaire || '';
            
            console.log('üìã Donn√©es du stagiaire:', stagiaire);
            console.log('‚úÖ Pr√©sence affich√©e:', presenceValue);
            console.log('üí¨ Commentaire affich√©:', commentaireValue);
            
            document.getElementById('infoFormation').innerHTML = `
                <h3 style="color: #3270AF; margin-bottom: 15px;">‚úÖ Attestation de pr√©sence</h3>
                <div class="info-row"><div class="info-label">Formation :</div><div>${formation.theme}</div></div>
                <div class="info-row"><div class="info-label">Date :</div><div>${dateFormation}</div></div>
                <div class="info-row"><div class="info-label">Horaires :</div><div>${formation.heureDebut} - ${formation.heureFin}</div></div>
                <div class="info-row"><div class="info-label">Formateur :</div><div>${formation.nomFormateur}</div></div>
                <div class="info-row"><div class="info-label">Client :</div><div>${formation.raisonSociale}</div></div>
                <div class="info-row"><div class="info-label">Stagiaire :</div><div>${stagiaire.nom}</div></div>
                <div class="info-row"><div class="info-label">Pr√©sence :</div><div style="color: ${presenceValue === 'Present' ? '#28a745' : (presenceValue === 'Non renseign√©' ? '#666' : '#dc3545')};">${presenceValue}</div></div>
                <div class="info-row"><div class="info-label">Commentaire Formateur :</div><div>${commentaireValue || '<em style="color: #999;">Aucun commentaire</em>'}</div></div>
            `;
            
            // Utiliser presenceValue au lieu de stagiaire.presence pour la condition
            if (presenceValue !== 'Absent' && presenceValue !== 'Non renseign√©') {
                document.getElementById('satisfactionForm').style.display = 'block';
                
                document.getElementById('satisfactionForm').onsubmit = function(e) {
                    e.preventDefault();
                    handleSatisfactionSubmit(formationId, stagiaireId);
                };
            } else {
                document.getElementById('infoFormation').innerHTML += `
                    <div class="alert alert-warning" style="margin-top: 20px;">
                        ‚ÑπÔ∏è Vous avez √©t√© marqu√©(e) comme "Absent". L'enqu√™te de satisfaction n'est disponible que pour les stagiaires pr√©sents ou partiellement pr√©sents.
                    </div>
                `;
            }
        }

        function initStarRatings() {
            ['q1', 'q2', 'q3'].forEach(qId => {
                const container = document.getElementById(qId + 'Stars');
                if (!container) return;
                
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.className = 'star';
                    star.innerHTML = '‚òÖ';
                    star.dataset.value = i;
                    star.dataset.question = qId;
                    star.addEventListener('click', function() {
                        document.getElementById(this.dataset.question).value = this.dataset.value;
                        updateStars(this.dataset.question, this.dataset.value);
                        checkSatisfactionFormValidity();
                    });
                    container.appendChild(star);
                }
            });
            
            // Ajouter des √©couteurs sur les boutons radio pour valider le formulaire
            document.querySelectorAll('input[name="q4"], input[name="q5"]').forEach(radio => {
                radio.addEventListener('change', checkSatisfactionFormValidity);
            });
        }

        function updateStars(qId, value) {
            const stars = document.querySelectorAll('#' + qId + 'Stars .star');
            stars.forEach((star, index) => {
                if (index < value) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }
        
        function checkSatisfactionFormValidity() {
            const q1 = document.getElementById('q1').value;
            const q2 = document.getElementById('q2').value;
            const q3 = document.getElementById('q3').value;
            const q4 = document.querySelector('input[name="q4"]:checked');
            const q5 = document.querySelector('input[name="q5"]:checked');
            const submitBtn = document.getElementById('submitSatisfactionBtn');
            
            // Activer le bouton seulement si toutes les questions obligatoires sont remplies
            if (q1 && q2 && q3 && q4 && q5) {
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
            } else {
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.5';
                submitBtn.style.cursor = 'not-allowed';
            }
        }

        function initCharCounters() {
            ['q6', 'q7'].forEach(id => {
                const textarea = document.getElementById(id);
                const counter = document.getElementById(id + 'Count');
                
                if (textarea && counter) {
                    textarea.addEventListener('input', function() {
                        const remaining = 100 - this.value.length;
                        counter.textContent = remaining;
                        
                        if (remaining < 20) {
                            counter.style.color = '#dc3545';
                        } else {
                            counter.style.color = '#666';
                        }
                    });
                }
            });
        }

        function handleSatisfactionSubmit(formationId, stagiaireId) {
            const q4Radio = document.querySelector('input[name="q4"]:checked');
            const q5Radio = document.querySelector('input[name="q5"]:checked');
            
            if (!q4Radio || !q5Radio) {
                alert('‚ö†Ô∏è Veuillez r√©pondre √† toutes les questions obligatoires (*)');
                return;
            }
            
            const q1Score = parseInt(document.getElementById('q1').value);
            const q2Score = parseInt(document.getElementById('q2').value);
            const q3Score = parseInt(document.getElementById('q3').value);
            
            let q4Score = 0;
            switch(q4Radio.value) {
                case 'Pas du tout': q4Score = 0; break;
                case 'Un peu': q4Score = 1; break;
                case 'Moyennement': q4Score = 2; break;
                case 'Assez': q4Score = 3; break;
                case 'Tout √† fait': q4Score = 5; break;
            }
            
            let q5Score = 0;
            switch(q5Radio.value) {
                case 'Trop courte': q5Score = 0; break;
                case 'Adapt√©e': q5Score = 5; break;
                case 'Trop longue': q5Score = 3; break;
            }
            
            const totalScore = q1Score + q2Score + q3Score + q4Score + q5Score;
            const noteGlobale = (totalScore / 5).toFixed(2);
            
            const satisfaction = {
                q1: q1Score,
                q2: q2Score,
                q3: q3Score,
                q4: q4Radio.value,
                q5: q5Radio.value,
                q6: document.getElementById('q6').value,
                q7: document.getElementById('q7').value,
                noteGlobale: noteGlobale,
                dateEnvoi: new Date().toISOString()
            };
            
            // Trouver la formation et le stagiaire dans les donn√©es locales
            const formation = formationsData.find(f => f.id === formationId);
            if (formation) {
                const stagiaire = formation.stagiaires.find(s => s.id === stagiaireId);
                if (stagiaire) {
                    // Sauvegarder les donn√©es de satisfaction dans l'objet stagiaire
                    stagiaire.satisfaction = satisfaction;
                    // Sauvegarder dans le localStorage
                    saveFormations();
                }
            }
            
            // V2.5.0 : Envoi vers SharePoint si activ√© - Envoie les donn√©es de satisfaction du stagiaire
            if (ENABLE_SHAREPOINT_SYNC && WEBHOOK_URL) {
                sendSatisfactionToSharePoint(stagiaireId, satisfaction);
            }
            
            let message = '';
            if (noteGlobale < 3) {
                message = 'Nous sommes d√©sol√©s de cette appr√©ciation, nous allons revenir vers vous pour comprendre cette √©valuation.';
            } else if (noteGlobale >= 3 && noteGlobale <= 4.5) {
                message = 'Merci pour cette appr√©ciation, votre retour va nous permettre de nous am√©liorer.';
            } else {
                message = 'Merci ! Cette bonne note nous encourage √† continuer √† travailler pour votre satisfaction.';
            }
            
            displayThankYouMessage(noteGlobale, message);
        }

        function sendToMake(formation, stagiaire, stagiaireIndex) {
            // Cr√©er des dates compl√®tes pour les heures (format ISO 8601)
            const dateFormation = formation.date; // Format: YYYY-MM-DD
            const heureDebutISO = `${dateFormation}T${formation.heureDebut}:00`;
            const heureFinISO = `${dateFormation}T${formation.heureFin}:00`;
            
            const payload = {
                formationId: formation.id,
                date: new Date(formation.date).toLocaleDateString('fr-FR'),
                client: formation.raisonSociale,
                formation: formation.theme,
                referenceJira: formation.referenceJira || '',
                formateur: formation.nomFormateur,
                type: formation.type,
                heureDebut: heureDebutISO,
                heureFin: heureFinISO,
                stagiaireNom: stagiaire.nom,
                stagiaireEmail: stagiaire.email,
                presence: stagiaire.presence,
                commentaireFormateur: stagiaire.commentaire,
                q1: stagiaire.satisfaction.q1,
                q2: stagiaire.satisfaction.q2,
                q3: stagiaire.satisfaction.q3,
                q4: stagiaire.satisfaction.q4,
                q5: stagiaire.satisfaction.q5,
                suggestions: stagiaire.satisfaction.q6,
                commentaire: stagiaire.satisfaction.q7,
                noteGlobale: stagiaire.satisfaction.noteGlobale,
                dateReponse: new Date(stagiaire.satisfaction.dateEnvoi).toLocaleDateString('fr-FR')
            };
            
            console.log('üì§ Envoi des donn√©es vers Make:', payload);
            console.log('üîë Authentification avec cl√©:', API_KEY);
            
            fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-make-apikey': API_KEY
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('üì• R√©ponse de Make:', response.status, response.statusText);
                if (response.ok) {
                    console.log('‚úÖ Donn√©es envoy√©es √† Make avec succ√®s');
                } else {
                    console.error('‚ùå Erreur lors de l\'envoi vers Make:', response.status, response.statusText);
                }
                return response.text();
            })
            .then(text => {
                if (text) console.log('R√©ponse Make:', text);
            })
            .catch(error => {
                console.error('‚ùå Erreur lors de l\'envoi vers Make:', error);
            });
        }

        function displayThankYouMessage(noteGlobale, message) {
            document.getElementById('infoFormation').style.display = 'none';
            document.getElementById('satisfactionForm').style.display = 'none';
            document.getElementById('attestationTitle').style.display = 'none';
            
            const thankYou = document.getElementById('thankYouMessage');
            
            // Si appel√© sans param√®tres (stagiaire d√©j√† r√©pondu)
            if (!noteGlobale && !message) {
                thankYou.innerHTML = `
                    <div class="alert alert-success">
                        <h3 style="margin-bottom: 15px;">‚úÖ Merci pour votre participation !</h3>
                        <p style="font-size: 18px; margin: 15px 0;"><strong>Vous avez d√©j√† r√©pondu √† l'enqu√™te de satisfaction.</strong></p>
                    </div>
                `;
            } else {
                thankYou.innerHTML = `
                    <div class="alert alert-success">
                        <h3 style="margin-bottom: 15px;">‚úÖ Merci pour votre participation !</h3>
                        <p style="font-size: 18px; margin: 15px 0;"><strong>Votre avis compte beaucoup pour nous.</strong></p>
                        <p style="font-size: 20px; margin: 15px 0; color: #3270AF;"><strong>Votre appr√©ciation globale est de ${noteGlobale} sur 5.</strong></p>
                        <p style="margin-top: 15px;">${message}</p>
                    </div>
                `;
            }
            
            thankYou.style.display = 'block';
        }

        // ========================================
        // GESTION DES DONN√âES
        // ========================================
        function saveFormations() {
            localStorage.setItem('wenegoce_formations', JSON.stringify(formationsData));
        }

        function loadFormations() {
            const saved = localStorage.getItem('wenegoce_formations');
            if (saved) {
                try {
                    formationsData = JSON.parse(saved);
                } catch (e) {
                    console.error('Erreur lors du chargement des donn√©es:', e);
                    formationsData = [];
                }
            }
        }

        // ========================================
        // EXPORT EXCEL
        // ========================================
        function generateExcel(autoExport = false) {
            if (formationsData.length === 0) {
                if (!autoExport) {
                    alert('‚ùå Aucune donn√©e √† exporter');
                }
                return;
            }

            const data = [];
            
            formationsData.forEach(formation => {
                const row = {
                    'Date': new Date(formation.date).toLocaleDateString('fr-FR'),
                    'Client': formation.raisonSociale,
                    'Formation': formation.theme,
                    'R√©f√©rence JIRA': formation.referenceJira || '',
                    'Formateur': formation.nomFormateur,
                    'Type': formation.type,
                    'Heure d√©but': formation.heureDebut,
                    'Heure fin': formation.heureFin
                };

                // Ajouter les colonnes pour chaque stagiaire (max 10)
                for (let i = 0; i < MAX_STAGIAIRES; i++) {
                    const stagiaire = formation.stagiaires[i];
                    const prefix = 'Stagiaire ' + (i + 1) + ' - ';
                    
                    if (stagiaire) {
                        row[prefix + 'Nom'] = stagiaire.nom;
                        row[prefix + 'Email'] = stagiaire.email;
                        row[prefix + 'Pr√©sence'] = stagiaire.presence || 'Non renseign√©';
                        row[prefix + 'Commentaire formateur'] = stagiaire.commentaire || '';
                        
                        if (stagiaire.satisfaction) {
                            row[prefix + 'Q1 (attentes 1-5)'] = stagiaire.satisfaction.q1;
                            row[prefix + 'Q2 (objectifs 1-5)'] = stagiaire.satisfaction.q2;
                            row[prefix + 'Q3 (formateur 1-5)'] = stagiaire.satisfaction.q3;
                            row[prefix + 'Q4 (aisance)'] = stagiaire.satisfaction.q4;
                            row[prefix + 'Q5 (dur√©e)'] = stagiaire.satisfaction.q5;
                            row[prefix + 'Suggestions'] = stagiaire.satisfaction.q6;
                            row[prefix + 'Commentaire'] = stagiaire.satisfaction.q7;
                            row[prefix + 'Note globale /5'] = stagiaire.satisfaction.noteGlobale;
                            const dateEnvoi = new Date(stagiaire.satisfaction.dateEnvoi);
                            row[prefix + 'Date r√©ponse'] = dateEnvoi.toLocaleDateString('fr-FR');
                        } else {
                            row[prefix + 'Q1 (attentes 1-5)'] = '';
                            row[prefix + 'Q2 (objectifs 1-5)'] = '';
                            row[prefix + 'Q3 (formateur 1-5)'] = '';
                            row[prefix + 'Q4 (aisance)'] = '';
                            row[prefix + 'Q5 (dur√©e)'] = '';
                            row[prefix + 'Suggestions'] = '';
                            row[prefix + 'Commentaire'] = '';
                            row[prefix + 'Note globale /5'] = '';
                            row[prefix + 'Date r√©ponse'] = '';
                        }
                    } else {
                        // Colonnes vides si pas de stagiaire
                        row[prefix + 'Nom'] = '';
                        row[prefix + 'Email'] = '';
                        row[prefix + 'Pr√©sence'] = '';
                        row[prefix + 'Commentaire formateur'] = '';
                        row[prefix + 'Q1 (attentes 1-5)'] = '';
                        row[prefix + 'Q2 (objectifs 1-5)'] = '';
                        row[prefix + 'Q3 (formateur 1-5)'] = '';
                        row[prefix + 'Q4 (aisance)'] = '';
                        row[prefix + 'Q5 (dur√©e)'] = '';
                        row[prefix + 'Suggestions'] = '';
                        row[prefix + 'Commentaire'] = '';
                        row[prefix + 'Note globale /5'] = '';
                        row[prefix + 'Date r√©ponse'] = '';
                    }
                }

                data.push(row);
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Formations');
            
            const fileName = 'wenegoce-formations-' + new Date().toISOString().split('T')[0] + '.xlsx';
            XLSX.writeFile(wb, fileName);
            
            // Message uniquement si export manuel
            if (!autoExport) {
                console.log('Export Excel g√©n√©r√© : ' + fileName);
            }
        }

        // ========================================
        // GESTION DES PARAM√àTRES MAKE
        // ========================================
        function initializeSettings() {
            // En v1.9, les param√®tres sont fixes - on affiche juste les valeurs
            updateWebhookDisplay();
            updateWebhookGetDisplay();
            updateAPIKeyDisplay();
            updateFormationCount();
        }

        function updateWebhookDisplay() {
            const display = document.getElementById('webhookDisplay');
            if (WEBHOOK_URL && WEBHOOK_URL !== '') {
                display.textContent = WEBHOOK_URL.substring(0, 100) + '...';
            } else {
                display.textContent = 'Non configur√©e';
            }
        }

        function updateWebhookGetDisplay() {
            const display = document.getElementById('webhookGetDisplay');
            if (WEBHOOK_GET_URL && WEBHOOK_GET_URL !== '') {
                display.textContent = WEBHOOK_GET_URL.substring(0, 100) + '...';
            } else {
                display.textContent = 'Non configur√©e';
            }
        }

        function updateAPIKeyDisplay() {
            const display = document.getElementById('apiKeyDisplay');
            if (API_KEY && API_KEY !== '') {
                display.textContent = API_KEY;
            } else {
                display.textContent = 'Non configur√©e';
            }
        }

        function showSettingsMessage(message, type = 'success') {
            const settingsContent = document.getElementById('settings');
            const existingMsg = settingsContent.querySelector('.settings-message');
            if (existingMsg) existingMsg.remove();
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'settings-message alert';
            if (type === 'success') {
                msgDiv.style.background = '#d4edda';
                msgDiv.style.color = '#155724';
                msgDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                msgDiv.style.background = '#f8d7da';
                msgDiv.style.color = '#721c24';
                msgDiv.style.border = '1px solid #f5c6cb';
            }
            msgDiv.innerHTML = message;
            
            const firstChild = settingsContent.querySelector('h2').nextElementSibling;
            settingsContent.insertBefore(msgDiv, firstChild);
            
            setTimeout(() => msgDiv.remove(), 3000);
        }

        function updateWebhookURL() {
            // Fonction d√©sactiv√©e en v1.9 - Configuration fixe dans le code
            alert('‚ö†Ô∏è Cette fonctionnalit√© est d√©sactiv√©e en version 1.9.\n\nLes URLs des webhooks sont configur√©es directement dans le code source.\nPour les modifier, contactez l\'administrateur syst√®me.');
        }

        function updateWebhookGetURL() {
            // Fonction d√©sactiv√©e en v1.9 - Configuration fixe dans le code
            alert('‚ö†Ô∏è Cette fonctionnalit√© est d√©sactiv√©e en version 1.9.\n\nLes URLs des webhooks sont configur√©es directement dans le code source.\nPour les modifier, contactez l\'administrateur syst√®me.');
        }

        function updateAPIKey() {
            // Fonction d√©sactiv√©e en v1.9 - Configuration fixe dans le code
            alert('‚ö†Ô∏è Cette fonctionnalit√© est d√©sactiv√©e en version 1.9.\n\nLa cl√© API est configur√©e directement dans le code source.\nPour la modifier, contactez l\'administrateur syst√®me.');
        }

        function toggleSync() {
            // Fonction d√©sactiv√©e en v1.9 - Synchronisation toujours activ√©e
            alert('‚ö†Ô∏è La synchronisation SharePoint est activ√©e par d√©faut en version 1.9 et ne peut pas √™tre d√©sactiv√©e.');
        }

        function copyWebhookURL() {
            if (!WEBHOOK_URL) {
                showSettingsMessage('‚ùå Aucune URL configur√©e', 'error');
                return;
            }
            navigator.clipboard.writeText(WEBHOOK_URL);
            showSettingsMessage('‚úÖ URL copi√©e dans le presse-papiers', 'success');
        }

        function copyWebhookGetURL() {
            if (!WEBHOOK_GET_URL) {
                showSettingsMessage('‚ùå Aucune URL configur√©e', 'error');
                return;
            }
            navigator.clipboard.writeText(WEBHOOK_GET_URL);
            showSettingsMessage('‚úÖ URL r√©cup√©ration copi√©e dans le presse-papiers', 'success');
        }

        function copyAPIKey() {
            if (!API_KEY) {
                showSettingsMessage('‚ùå Aucune cl√© API configur√©e', 'error');
                return;
            }
            navigator.clipboard.writeText(API_KEY);
            showSettingsMessage('‚úÖ Cl√© API copi√©e dans le presse-papiers', 'success');
        }

        function updateFormationCount() {
            document.getElementById('formationCount').textContent = formationsData.length;
        }

        // ========================================
        // FONCTIONS SHAREPOINT (V2.0)
        // ========================================
        
        async function sendFormationToSharePoint(formation) {
            try {
                // Transformer les donn√©es au format attendu par SharePoint/Make
                const sharePointData = {
                    FormationID: formation.id,
                    RaisonSociale: formation.raisonSociale,
                    ThemeFormation: formation.theme,
                    ReferenceJira: formation.referenceJira || '',
                    NomFormateur: formation.nomFormateur,
                    DateFormation: formation.date,
                    TypeFormation: formation.type,
                    HeureDebut: formation.heureDebut,
                    HeureFin: formation.heureFin,
                    Stagiaires: formation.stagiaires  // Envoyer comme array, pas comme string
                };

                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-make-apikey': API_KEY
                    },
                    body: JSON.stringify(sharePointData)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Formation envoy√©e √† SharePoint avec succ√®s');
                    return true;
                } else {
                    console.error('‚ùå Erreur lors de l\'envoi vers SharePoint:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erreur r√©seau lors de l\'envoi:', error);
                return false;
            }
        }

        function transformSharePointData(spData) {
            // Transformer les donn√©es SharePoint ({{3.Fields}}) vers le format attendu par l'application
            try {
                // Parser les stagiaires si c'est une string JSON
                let stagiaires = [];
                if (spData.Stagiaires) {
                    if (typeof spData.Stagiaires === 'string') {
                        stagiaires = JSON.parse(spData.Stagiaires);
                    } else {
                        stagiaires = spData.Stagiaires;
                    }
                    
                    // Si Stagiaires est un objet (un seul stagiaire), le transformer en array
                    if (!Array.isArray(stagiaires)) {
                        stagiaires = [stagiaires];
                    }
                    
                    // Parser chaque √©l√©ment du tableau s'il est une string JSON
                    stagiaires = stagiaires.map(stag => {
                        if (typeof stag === 'string') {
                            return JSON.parse(stag);
                        }
                        return stag;
                    });
                    
                    // CORRECTION v1.9.3 : Mapper les champs SharePoint vers le format de l'application
                    stagiaires = stagiaires.map(stag => ({
                        id: stag.StagiaireID || stag.id,
                        nom: stag.Nom || stag.nom,
                        email: stag.Email || stag.email,
                        presence: stag.Presence || stag.presence || null,
                        commentaire: stag.CommentaireFormateur || stag.commentaire || '',
                        // Mapper les champs de satisfaction s'ils existent
                        satisfaction: (stag.Q1_Attentes || stag.Q1) ? {
                            q1: stag.Q1_Attentes || stag.Q1 || stag.satisfaction?.q1,
                            q2: stag.Q2_Objectifs || stag.Q2 || stag.satisfaction?.q2,
                            q3: stag.Q3_Formateur || stag.Q3 || stag.satisfaction?.q3,
                            q4: stag.Q4_Aise || stag.Q4 || stag.satisfaction?.q4,
                            q5: stag.Q5_Duree || stag.Q5 || stag.satisfaction?.q5,
                            q6: stag.Q6_Suggestions || stag.Q6 || stag.satisfaction?.q6 || '',
                            q7: stag.Q7_Commentaire || stag.Q7 || stag.satisfaction?.q7 || '',
                            noteGlobale: stag.NoteGlobale || stag.satisfaction?.noteGlobale,
                            dateEnvoi: stag.DateReponse || stag.satisfaction?.dateEnvoi
                        } : (stag.satisfaction || null)
                    }));
                }
                
                // Formater la date si n√©cessaire
                let dateFormation = spData.DateFormation || spData.date;
                if (dateFormation && dateFormation.includes('T')) {
                    dateFormation = dateFormation.split('T')[0]; // Garder seulement YYYY-MM-DD
                }
                
                return {
                    id: spData.FormationID || spData.id,
                    raisonSociale: spData.RaisonSociale || spData.raisonSociale,
                    theme: spData.ThemeFormation || spData.theme,
                    referenceJira: spData.ReferenceJira || spData.referenceJira || '',
                    nomFormateur: spData.NomFormateur || spData.nomFormateur,
                    date: dateFormation,
                    type: spData.TypeFormation || spData.type,
                    heureDebut: spData.HeureDebut || spData.heureDebut,
                    heureFin: spData.HeureFin || spData.heureFin,
                    stagiaires: stagiaires
                };
            } catch (error) {
                console.error('‚ùå Erreur lors de la transformation des donn√©es SharePoint:', error);
                return null;
            }
        }

        async function getFormationFromSharePoint(formationId, stagiaireId) {
            try {
                const response = await fetch(WEBHOOK_GET_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        formationId: formationId,
                        stagiaireId: stagiaireId
                    })
                });
                
                if (response.ok) {
                    const rawData = await response.json();
                    console.log('‚úÖ Formation r√©cup√©r√©e depuis SharePoint (brut):', rawData);
                    
                    // Extraire l'objet formation de la r√©ponse Make
                    const formationData = rawData.formation || rawData;
                    
                    // Transformer les donn√©es SharePoint vers le format attendu
                    const transformedData = transformSharePointData(formationData);
                    
                    if (transformedData) {
                        console.log('‚úÖ Donn√©es transform√©es:', transformedData);
                        return transformedData;
                    } else {
                        console.error('‚ùå √âchec de la transformation des donn√©es');
                        return null;
                    }
                } else {
                    console.error('‚ùå Formation non trouv√©e dans SharePoint');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la r√©cup√©ration depuis SharePoint:', error);
                return null;
            }
        }

        async function sendSatisfactionToSharePoint(stagiaireId, satisfaction) {
            try {
                // Envoyer uniquement les r√©ponses du stagiaire pour mettre √† jour la ligne Presences
                const satisfactionData = {
                    StagiaireID: stagiaireId,
                    Q1_Attentes: satisfaction.q1,
                    Q2_Objectifs: satisfaction.q2,
                    Q3_Formateur: satisfaction.q3,
                    Q4_Aise: satisfaction.q4,
                    Q5_Duree: satisfaction.q5,
                    Q6_Suggestions: satisfaction.q6 || '',
                    Q7_Commentaire: satisfaction.q7 || '',
                    NoteGlobale: parseFloat(satisfaction.noteGlobale),
                    DateReponse: satisfaction.dateEnvoi
                };

                console.log('üì§ Envoi des donn√©es de satisfaction √† SharePoint:', satisfactionData);

                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-make-apikey': API_KEY
                    },
                    body: JSON.stringify(satisfactionData)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Donn√©es de satisfaction envoy√©es √† SharePoint avec succ√®s');
                } else {
                    console.error('‚ùå Erreur lors de l\'envoi de la satisfaction:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Erreur r√©seau lors de l\'envoi de la satisfaction:', error);
            }
        }

        // ========================================
        // NOUVELLE FONCTION v2.5.0 : ENVOI DES DONN√âES DE PR√âSENCE ET COMMENTAIRES
        // ========================================
        async function sendPresenceDataToSharePoint(formation) {
            // V√©rifier si la synchronisation SharePoint est activ√©e
            if (!ENABLE_SHAREPOINT_SYNC || !WEBHOOK_URL) {
                console.log('‚ÑπÔ∏è Synchronisation SharePoint d√©sactiv√©e ou webhook non configur√©');
                return false;
            }

            try {
                // Pr√©parer les donn√©es √† envoyer : ID formation + donn√©es de chaque stagiaire
                const presenceData = {
                    FormationID: formation.id,
                    Stagiaires: formation.stagiaires.map(stagiaire => ({
                        StagiaireID: stagiaire.id,
                        Nom: stagiaire.nom,
                        Email: stagiaire.email,
                        Presence: stagiaire.presence || 'Non renseign√©',
                        CommentaireFormateur: stagiaire.commentaire || ''
                    }))
                };

                console.log('üì§ Envoi des donn√©es de pr√©sence √† SharePoint:', presenceData);

                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-make-apikey': API_KEY
                    },
                    body: JSON.stringify(presenceData)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Donn√©es de pr√©sence envoy√©es √† SharePoint avec succ√®s');
                    return true;
                } else {
                    console.error('‚ùå Erreur lors de l\'envoi des donn√©es de pr√©sence:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erreur r√©seau lors de l\'envoi des donn√©es de pr√©sence:', error);
                return false;
            }
        }
    </script>
</body>
</html>
