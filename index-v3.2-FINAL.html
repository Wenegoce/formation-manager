<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formation Manager - WeN√©goce</title>

  <!-- Favicon pour √©viter 404 console -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéì</text></svg>">

  <!-- MSAL via unpkg (plus fiable) -->
  <script src="https://unpkg.com/@azure/msal-browser@3.21.0/lib/msal-browser.min.js" crossorigin="anonymous"></script>
  
  <!-- Attendre le chargement de MSAL -->
  <script>
    window.__msalReady = new Promise(function(resolve) {
      if (typeof msal !== 'undefined') {
        resolve();
      } else {
        var checkMsal = setInterval(function() {
          if (typeof msal !== 'undefined') {
            clearInterval(checkMsal);
            resolve();
          }
        }, 50);
      }
    });
  </script>

  <!-- Styles V3.2 (look & feel WeN√©goce - inchang√©) -->
  <style>
    :root{
      --brand:#3270AF; /* primaire WeN√©goce */
      --brand-600:#2b66a3;
      --brand-50:#e7f3ff;
      --text:#1f2937;
      --muted:#6b7280;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e5e7eb;
      --success:#28a745;
      --warning:#ff9800;
      --danger:#dc3545;
      --radius:12px;
      --shadow:0 6px 14px rgba(0,0,0,.06), 0 2px 6px rgba(0,0,0,.04);
      --shadow-sm:0 2px 8px rgba(0,0,0,.06);
      --focus:0 0 0 3px rgba(50,112,175,.25);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;line-height:1.45}
    img{max-width:100%;height:auto}

    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .header{display:flex;gap:16px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;box-shadow:var(--shadow-sm)}
    .header-logo{width:80px;min-width:80px}
    .header-content h1{margin:2px 0 6px 0;font-size:28px}
    .header-content p{margin:0;color:var(--muted)}

    /* Nouveau : User info et login button */
    .auth-section{display:flex;align-items:center;gap:12px;margin-left:auto}
    .user-info{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--brand-50);border-radius:8px}
    .user-avatar{width:32px;height:32px;border-radius:50%;background:var(--brand);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold}
    .user-name{font-size:14px;color:var(--text);font-weight:600}
    .btn-login{background:var(--brand);color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;transition:.2s}
    .btn-login:hover{background:var(--brand-600)}
    .btn-logout{background:transparent;color:var(--brand);border:1px solid var(--brand);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;transition:.2s}
    .btn-logout:hover{background:var(--brand-50)}

    .tabs{display:flex;gap:10px;margin:18px 0 12px;flex-wrap:wrap}
    .tab{appearance:none;border:1px solid var(--border);background:var(--card);padding:10px 14px;border-radius:10px;cursor:pointer;transition:.2s box-shadow,.2s transform,.2s background;box-shadow:var(--shadow-sm);font-weight:600;color:var(--text)}
    .tab:hover{transform:translateY(-1px)}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#fff;box-shadow:var(--shadow)}

    .content .tab-content{display:none}
    .content .tab-content.active{display:block}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-sm)}

    .form-group{margin-bottom:16px}
    label{font-weight:600;display:block;margin-bottom:6px}
    input[type="text"],input[type="email"],input[type="date"],input[type="time"],textarea{
      width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;background:#fff;transition:.2s border,.2s box-shadow;font-size:14px
    }
    input:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:var(--focus)}

    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}

    .btn{background:var(--brand);color:#fff;border:none;padding:12px 16px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow-sm);transition:.2s transform,.2s box-shadow}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:#6b7280}
    .btn-success{background:var(--success)}
    .btn-edit{background:#0ea5e9;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn-remove{background:#ef4444;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer}

    .switch-container{display:flex;align-items:center;gap:10px}
    .switch{position:relative;width:52px;height:30px;display:inline-block}
    .switch input{display:none}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;transition:.2s;border-radius:999px}
    .slider:before{content:"";position:absolute;height:22px;width:22px;left:4px;top:4px;background:#fff;border-radius:999px;transition:.2s}
    .switch input:checked + .slider{background:var(--brand)}
    .switch input:checked + .slider:before{transform:translateX(22px)}
    .switch-label{font-weight:600;color:#6b7280}
    .switch-label.active{color:var(--brand)}

    .alert{padding:14px 16px;border-radius:10px;border:1px solid var(--border);background:#fff}
    .alert-info{background:#eef6ff;border-color:#dbeafe;color:#1e3a8a}
    .alert-success{background:#ecfdf5;border-color:#d1fae5;color:#065f46}
    .alert-warning{background:#fff7ed;border-color:#ffedd5;color:#7c2d12}

    .info-display{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 12px}
    .info-row{display:grid;grid-template-columns:220px 1fr;gap:12px;padding:8px 4px;border-bottom:1px dashed #edf2f7}
    .info-row:last-child{border-bottom:none}
    .info-label{color:var(--muted);font-weight:600}

    .stagiaire-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:var(--shadow-sm)}
    .stagiaire-header{display:flex;align-items:center;justify-content:space-between}
    .stagiaire-number{font-weight:700;color:var(--brand)}

    .radio-group{display:flex;gap:14px;flex-wrap:wrap}
    .radio-item{display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 10px;border-radius:10px;background:#fff}
    .radio-item input[type="radio"]{accent-color:var(--brand)}

    .stars{display:flex;gap:6px;font-size:32px;cursor:pointer;user-select:none}
    .star{color:#d1d5db;transition:.15s}
    .star.active,.star:hover{color:#fbbf24}

    .presence-radio-group{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
    .presence-item{flex:1;min-width:140px;border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer;transition:.2s;background:#fff}
    .presence-item:hover{border-color:var(--brand);transform:scale(1.02)}
    .presence-item input[type="radio"]{margin-right:8px;accent-color:var(--brand)}
    .presence-item input[type="radio"]:checked + label{font-weight:600;color:var(--brand)}

    .email-preview{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin:12px 0;font-family:inherit}
    .email-link{display:block;padding:12px;background:var(--brand);color:#fff;text-decoration:none;border-radius:8px;text-align:center;margin:10px 0;font-weight:600;transition:.2s}
    .email-link:hover{background:var(--brand-600);transform:translateY(-1px)}

    .formation-card{border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px;box-shadow:var(--shadow-sm);background:var(--card);overflow:hidden;transition:.2s}
    .formation-card:hover{box-shadow:var(--shadow)}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:1000;align-items:center;justify-content:center}
    .modal-content{background:var(--card);border-radius:var(--radius);max-width:600px;width:90%;max-height:90vh;overflow:auto;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    .modal-header{background:var(--brand);color:#fff;padding:16px 18px;display:flex;justify-content:space-between;align-items:center;border-radius:var(--radius) var(--radius) 0 0}
    .modal-header h3{margin:0}
    .modal-body{padding:18px}
    .btn-icon{background:transparent;border:none;font-size:22px;cursor:pointer;color:inherit;padding:0;transition:.2s}
    .btn-icon:hover{opacity:.8}

    textarea{resize:vertical;font-family:inherit}
    small{display:block;margin-top:4px;color:var(--muted)}
    .error-message{color:var(--danger);font-size:13px;margin-top:4px}

    .loading-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.95);display:none;align-items:center;justify-content:center;z-index:2000;flex-direction:column;gap:16px}
    .loading-screen.active{display:flex}
    .spinner{width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .version-info{text-align:center;padding:16px;color:var(--muted);font-size:13px;border-top:1px solid var(--border);margin-top:32px}
    .version-number{font-weight:700;color:var(--brand);font-size:14px;margin-bottom:4px}
    .version-date{margin-bottom:8px}
    .copyright{font-size:12px;line-height:1.5}

    @media(max-width:768px){
      .row{grid-template-columns:1fr}
      .info-row{grid-template-columns:1fr;gap:4px}
      .header{flex-direction:column;text-align:center}
      .auth-section{margin-left:0;width:100%;justify-content:center}
    }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="spinner"></div>
    <div style="color:var(--brand);font-weight:600">Chargement...</div>
  </div>

  <div class="container">
    <div class="header">
      <img class="header-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüéì%3C/text%3E%3C/svg%3E" alt="Logo">
      <div class="header-content">
        <h1>Formation Manager</h1>
        <p>Gestion des formations et √©valuations</p>
      </div>
      <div class="auth-section" id="authSection">
        <!-- Sera rempli dynamiquement par JS -->
      </div>
    </div>

    <!-- Navigation tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="nouveau">‚ûï Nouvelle Formation</button>
      <button class="tab" data-tab="formations">üìã Mes Formations</button>
      <button class="tab" data-tab="stagiaire" style="display:none">üë§ Espace Stagiaire</button>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- NOUVEAU -->
      <div id="nouveau" class="tab-content active">
        <h2 style="margin-bottom:20px;color:var(--brand);">‚ûï Cr√©er une nouvelle formation</h2>
        <div id="formSection">
          <form id="formateurForm" class="card" style="padding:18px;">
            <div class="form-group">
              <label>Raison sociale du client *</label>
              <input type="text" id="raisonSociale" placeholder="Ex: Entreprise XYZ" required>
            </div>
            <div class="form-group">
              <label>Th√®me de la formation *</label>
              <input type="text" id="theme" placeholder="Ex: Gestion de projet" required>
            </div>
            <div class="form-group">
              <label>R√©f√©rence JIRA (optionnel)</label>
              <input type="text" id="referenceJira" placeholder="Ex: TIC-123">
            </div>
            <div class="form-group">
              <label>Nom du formateur *</label>
              <input type="text" id="nomFormateur" placeholder="Ex: Jean Dupont" required>
            </div>
            <div class="row">
              <div class="form-group">
                <label>Date de la formation *</label>
                <input type="date" id="dateFormation" required>
              </div>
              <div class="form-group">
                <label>Type de formation *</label>
                <div class="switch-container">
                  <span class="switch-label active" id="labelPresentiel">Pr√©sentiel</span>
                  <label class="switch">
                    <input type="checkbox" id="typeFormationToggle">
                    <span class="slider"></span>
                  </label>
                  <span class="switch-label" id="labelVisio">Visio</span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="form-group">
                <label>Heure de d√©but *</label>
                <input type="time" id="heureDebut" value="09:00" required>
              </div>
              <div class="form-group">
                <label>Heure de fin *</label>
                <input type="time" id="heureFin" value="17:00" required>
              </div>
            </div>

            <h3 style="margin:22px 0 12px;color:var(--brand);">Stagiaires</h3>
            <div id="stagiairesList"></div>
            <button type="button" id="btnAddStagiaire" class="btn btn-secondary" style="margin-top:12px">‚ûï Ajouter un stagiaire</button>
            <div style="margin-top:18px">
              <button type="submit" class="btn">üíæ Enregistrer la formation</button>
            </div>
          </form>
        </div>

        <div id="postFormationSection" style="display:none;">
          <div class="alert alert-info" style="margin:12px 0 16px;">
            ‚ÑπÔ∏è <strong>Formation enregistr√©e !</strong> Une fois la formation termin√©e, compl√©tez la pr√©sence de chaque stagiaire ci-dessous.
          </div>
          <div id="formationInfo" class="info-display" style="margin-bottom:18px"></div>
          <h3 style="margin:12px 0 12px;color:var(--brand);">Compl√©ter les pr√©sences</h3>
          <form id="presenceForm" class="card" style="padding:18px;">
            <div id="presenceList"></div>
            <div style="margin-top:18px">
              <button type="submit" class="btn">üìß G√©n√©rer et envoyer les liens stagiaires</button>
            </div>
          </form>
        </div>

        <div id="linksGenerated" style="display:none;margin-top:18px;">
          <div class="alert alert-success">‚úÖ Les liens ont √©t√© g√©n√©r√©s avec succ√®s ! Vous pouvez maintenant envoyer les emails aux stagiaires.</div>
          <div id="emailLinks"></div>
        </div>
      </div>

      <!-- FORMATIONS -->
      <div id="formations" class="tab-content">
        <h2 style="margin-bottom:20px;color:var(--brand);">üìã Mes Formations</h2>
        <div class="alert alert-info">‚ÑπÔ∏è S√©lectionnez une formation pour envoyer les liens d'enqu√™te de satisfaction aux stagiaires.</div>
        <div id="formationsLoading" style="text-align:center;padding:30px;color:#666;">üîÑ Chargement des formations...</div>
        <div id="formationsList" style="display:none"></div>
        <div id="formationsEmpty" style="display:none;text-align:center;padding:40px;color:#999;">üì≠ Aucune formation trouv√©e.</div>
      </div>

      <!-- STAGIAIRE -->
      <div id="stagiaire" class="tab-content">
        <div id="stagiaireView">
          <div class="alert alert-info">‚ÑπÔ∏è Cette page est accessible via le lien envoy√© par email par votre formateur.</div>
          <h2 style="margin-bottom:16px;color:var(--brand);">Attestation de formation</h2>
          <div class="info-display" id="infoFormation"><p style="text-align:center;color:#666">En attente du lien personnalis√©...</p></div>

          <form id="satisfactionForm" style="display:none" class="card" >
            <div style="padding:18px">
              <h3 style="margin:0 0 12px;color:var(--brand);">üìã Enqu√™te de satisfaction</h3>
              <div class="form-group">
                <label>La formation a-t-elle r√©pondu √† vos attentes ? *</label>
                <div class="stars" id="q1Stars"></div>
                <input type="hidden" id="q1" required>
              </div>
              <div class="form-group">
                <label>Les objectifs de la formation √©taient-ils clairs et bien expliqu√©s ? *</label>
                <div class="stars" id="q2Stars"></div>
                <input type="hidden" id="q2" required>
              </div>
              <div class="form-group">
                <label>Le formateur a-t-il su rendre la session claire, dynamique et adapt√©e √† votre niveau ? *</label>
                <div class="stars" id="q3Stars"></div>
                <input type="hidden" id="q3" required>
              </div>
              <div class="form-group">
                <label>Vous sentez-vous √† pr√©sent √† l'aise pour utiliser les fonctions pr√©sent√©es lors de cette formation ? *</label>
                <div class="radio-group">
                  <label class="radio-item"><input type="radio" name="q4" value="Pas du tout" required><span>Pas du tout</span></label>
                  <label class="radio-item"><input type="radio" name="q4" value="Un peu" required><span>Un peu</span></label>
                  <label class="radio-item"><input type="radio" name="q4" value="Moyennement" required><span>Moyennement</span></label>
                  <label class="radio-item"><input type="radio" name="q4" value="Assez" required><span>Assez</span></label>
                  <label class="radio-item"><input type="radio" name="q4" value="Tout √† fait" required><span>Tout √† fait</span></label>
                </div>
              </div>
              <div class="form-group">
                <label>Comment jugez-vous la dur√©e de la formation ? *</label>
                <div class="radio-group">
                  <label class="radio-item"><input type="radio" name="q5" value="Trop courte" required><span>Trop courte</span></label>
                  <label class="radio-item"><input type="radio" name="q5" value="Adapt√©e" required><span>Adapt√©e</span></label>
                  <label class="radio-item"><input type="radio" name="q5" value="Trop longue" required><span>Trop longue</span></label>
                </div>
              </div>
              <div class="form-group">
                <label>Quelles sont vos suggestions pour am√©liorer cette formation ?</label>
                <textarea id="q6" maxlength="100" rows="3" placeholder="Maximum 100 caract√®res"></textarea>
                <small style="color:#666">Caract√®res restants: <span id="q6Count">100</span></small>
              </div>
              <div class="form-group">
                <label>Un dernier commentaire ?</label>
                <textarea id="q7" maxlength="100" rows="3" placeholder="Maximum 100 caract√®res"></textarea>
                <small style="color:#666">Caract√®res restants: <span id="q7Count">100</span></small>
              </div>
              <button type="submit" class="btn btn-success">üì§ Envoyer mon √©valuation</button>
            </div>
          </form>
          <div id="thankYouMessage" style="display:none"></div>
        </div>
      </div>

      <div class="version-info">
        <div class="version-number">Version 3.2</div>
        <div class="version-date">13 novembre 2025</div>
        <div class="copyright">¬© 2025 WeN√©goce - Tous droits r√©serv√©s<br>Formation Manager est une solution propri√©taire d√©velopp√©e par WeN√©goce</div>
      </div>
    </div>
  </div>

  <!-- Modale √©dition email -->
  <div id="emailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úèÔ∏è Modifier l'email</h3>
        <button class="btn-icon" onclick="closeEmailModal()" style="color:white">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Objet de l'email *</label>
          <input type="text" id="emailSubjectEdit">
        </div>
        <div class="form-group">
          <label>Corps du message *</label>
          <textarea id="emailBodyEdit" rows="12" style="font-family:inherit;line-height:1.6"></textarea>
        </div>
        <div style="text-align:right;margin-top:10px">
          <button class="btn" onclick="saveEmailChanges()">‚úì Termin√©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modale relance -->
  <div id="reminderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üìß Relancer le stagiaire</h3>
        <button class="btn-icon" onclick="closeReminderModal()" style="color:white">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="reminderInfo" class="info-display" style="margin-bottom:12px"></div>
        <div class="form-group">
          <label>Objet de l'email *</label>
          <input type="text" id="reminderSubjectEdit">
        </div>
        <div class="form-group">
          <label>Corps du message *</label>
          <textarea id="reminderBodyEdit" rows="12" style="font-family:inherit;line-height:1.6"></textarea>
        </div>
        <div class="alert alert-info" style="margin-top:10px">‚ÑπÔ∏è <strong>Note :</strong> Le lien personnalis√© sera automatiquement ins√©r√© √† la place de [LIEN]</div>
        <div style="text-align:right;margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btn-secondary" onclick="closeReminderModal()">Annuler</button>
          <button class="btn" onclick="sendReminder()">üìß Envoyer la relance</button>
        </div>
      </div>
    </div>
  </div>

  <!-- XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Helpers g√©n√©riques -->
  <script>
    function toDateISOFromInput(d){
      if(!d) return null; try{
        if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d+"T00:00:00Z";
        if(/^\d{2}\/\d{2}\/\d{4}$/.test(d)){const [dd,mm,yyyy]=d.split('/');return `${yyyy}-${mm}-${dd}T00:00:00Z`;}
      }catch(e){}
      return null;
    }
  </script>

  <!-- ============================= -->
  <!--   MSAL AUTHENTICATION V3.2    -->
  <!-- ============================= -->
  <script>
  // Configuration MSAL
  const msalConfig = {
    auth: {
      clientId: 'e270fde7-2324-487e-8cb4-c249dbafa968',
      authority: 'https://login.microsoftonline.com/bc9934d3-8db6-47e6-a844-a32a407400c2',
      redirectUri: window.location.origin + window.location.pathname
    },
    cache: {
      cacheLocation: 'localStorage',
      storeAuthStateInCookie: false
    }
  };

  const loginRequest = {
    scopes: ['User.Read', 'GroupMember.Read.All']
  };

  // Groupes autoris√©s
  const GROUPS = {
    TRAINER: 'FM.trainer',
    ADMIN: 'FM.Admin'
  };

  let msalInstance;
  let currentUser = null;

  // Initialisation MSAL
  async function initMSAL() {
    try {
      // Attendre que MSAL soit charg√©
      await window.__msalReady;
      
      msalInstance = new msal.PublicClientApplication(msalConfig);
      await msalInstance.initialize();
      
      // G√©rer le retour de redirection
      const response = await msalInstance.handleRedirectPromise();
      if (response) {
        currentUser = response.account;
        await checkUserAccess();
      } else {
        // V√©rifier si un utilisateur est d√©j√† connect√©
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) {
          currentUser = accounts[0];
          msalInstance.setActiveAccount(currentUser);
          await checkUserAccess();
        }
      }
      
      updateAuthUI();
    } catch (error) {
      console.error('Erreur initialisation MSAL:', error);
    }
  }

  // V√©rifier l'acc√®s utilisateur
  async function checkUserAccess() {
    if (!currentUser) return false;
    
    try {
      // R√©cup√©rer le token pour acc√©der √† Graph API
      const tokenResponse = await msalInstance.acquireTokenSilent({
        scopes: ['User.Read', 'GroupMember.Read.All'],
        account: currentUser
      });

      // V√©rifier les groupes de l'utilisateur via Graph API
      const response = await fetch('https://graph.microsoft.com/v1.0/me/memberOf', {
        headers: {
          'Authorization': `Bearer ${tokenResponse.accessToken}`
        }
      });

      if (response.ok) {
        const data = await response.json();
        const groups = data.value.map(g => g.displayName);
        
        // V√©rifier si l'utilisateur appartient √† un groupe autoris√©
        const hasAccess = groups.some(g => g === GROUPS.TRAINER || g === GROUPS.ADMIN);
        
        if (!hasAccess) {
          showAccessDenied();
          return false;
        }

        // Stocker le r√¥le pour usage ult√©rieur
        currentUser.isAdmin = groups.includes(GROUPS.ADMIN);
        return true;
      }
    } catch (error) {
      console.error('Erreur v√©rification acc√®s:', error);
      // En cas d'erreur, on tente un acquireTokenRedirect
      try {
        await msalInstance.acquireTokenRedirect({
          scopes: ['User.Read', 'GroupMember.Read.All'],
          account: currentUser
        });
      } catch (redirectError) {
        console.error('Erreur redirect token:', redirectError);
      }
    }
    
    return false;
  }

  // Connexion
  async function login() {
    try {
      showLoading();
      await msalInstance.loginRedirect(loginRequest);
    } catch (error) {
      console.error('Erreur connexion:', error);
      hideLoading();
      alert('‚ùå Erreur lors de la connexion. Veuillez r√©essayer.');
    }
  }

  // D√©connexion
  async function logout() {
    try {
      const logoutRequest = {
        account: currentUser,
        postLogoutRedirectUri: window.location.origin + window.location.pathname
      };
      await msalInstance.logoutRedirect(logoutRequest);
    } catch (error) {
      console.error('Erreur d√©connexion:', error);
    }
  }

  // Mettre √† jour l'UI d'authentification
  function updateAuthUI() {
    const authSection = document.getElementById('authSection');
    
    if (currentUser) {
      const initials = currentUser.name ? currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'U';
      authSection.innerHTML = `
        <div class="user-info">
          <div class="user-avatar">${initials}</div>
          <div class="user-name">${currentUser.name || currentUser.username}</div>
        </div>
        <button class="btn-logout" onclick="logout()">D√©connexion</button>
      `;
    } else {
      authSection.innerHTML = `
        <button class="btn-login" onclick="login()">üîê Se connecter</button>
      `;
    }
  }

  // Afficher message d'acc√®s refus√©
  function showAccessDenied() {
    document.querySelector('.container').innerHTML = `
      <div style="text-align:center;padding:60px 20px">
        <div style="font-size:64px;margin-bottom:20px">üîí</div>
        <h2 style="color:var(--danger);margin-bottom:12px">Acc√®s refus√©</h2>
        <p style="color:var(--muted);margin-bottom:24px">
          Vous n'avez pas les autorisations n√©cessaires pour acc√©der √† cette application.<br>
          Veuillez contacter votre administrateur si vous pensez qu'il s'agit d'une erreur.
        </p>
        <button class="btn" onclick="logout()">Retour</button>
      </div>
    `;
  }

  // V√©rifier si l'utilisateur doit √™tre authentifi√©
  function requiresAuth() {
    const params = new URLSearchParams(window.location.search);
    const fid = params.get('fid');
    const sid = params.get('stid');
    
    // Si les param√®tres fid et stid sont pr√©sents, c'est la page stagiaire (pas d'auth requise)
    return !(fid && sid);
  }

  // Loading screen
  function showLoading() {
    document.getElementById('loadingScreen').classList.add('active');
  }

  function hideLoading() {
    document.getElementById('loadingScreen').classList.remove('active');
  }
  </script>

  <!-- ============================= -->
  <!--   FORMATION MANAGER CORE JS   -->
  <!-- ============================= -->
  <script>
  // ===== Donn√©es & √©tat =====
  let stagiaireCount=0; let formationsData=[]; let currentFormationId=null; const MAX_STAGIAIRES=10;
  let emailSubjectGlobal=''; let emailBodyGlobal=''; let currentFormationData=null;

  // ===== Endpoints Azure =====
  const FM_ENDPOINTS={
    createFormation: "https://prod-01.francecentral.logic.azure.com:443/workflows/2ed0a1ded8c04bdb919956463f324d76/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=xdDuSi6kyJazxW0euPSUkEowfVgIrgxfAQ6a6Ogejg0",
    createPresence:  "https://prod-02.francecentral.logic.azure.com:443/workflows/a108ca6c917a4197ba14e2674ff31b44/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=zOjl38vl1AXhyV25ZGW_01wVLwXZwftceAYxyk8gjro",
    manager:         "https://prod-20.francecentral.logic.azure.com:443/workflows/bad15f005ef64adab56e14fd436b8a1f/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=6iHn4hVguX6pLJFyTTvbq4ujoMwF0dnCgRfy7k7hiKA"
  };
  const ENABLE_SHAREPOINT_SYNC=true;

  // ===== Utils =====
  async function postJson(url,data){
    const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    if(!(res.ok||res.status===202)){const txt=await res.text().catch(()=>" ");throw new Error(`HTTP ${res.status} ${res.statusText} ‚Äî ${txt}`)}
    try{return await res.json();}catch{return await res.text().catch(()=>null)}
  }

  // ===== DOM Ready avec MSAL =====
  document.addEventListener('DOMContentLoaded', async ()=>{
    showLoading();
    
    // Initialiser MSAL
    await initMSAL();
    
    // V√©rifier si authentification requise
    if (requiresAuth()) {
      if (!currentUser) {
        // Rediriger vers la page de connexion
        hideLoading();
        updateAuthUI();
        
        // Masquer tout le contenu sauf le header
        document.querySelector('.tabs').style.display = 'none';
        document.querySelector('.content').style.display = 'none';
        
        // Afficher message de connexion
        const container = document.querySelector('.container');
        const message = document.createElement('div');
        message.style.cssText = 'text-align:center;padding:60px 20px;background:var(--card);border-radius:var(--radius);margin-top:24px;box-shadow:var(--shadow)';
        message.innerHTML = `
          <div style="font-size:64px;margin-bottom:20px">üîê</div>
          <h2 style="color:var(--brand);margin-bottom:12px">Authentification requise</h2>
          <p style="color:var(--muted);margin-bottom:24px">
            Veuillez vous connecter avec votre compte Microsoft 365 pour acc√©der √† l'application.
          </p>
          <button class="btn" onclick="login()" style="font-size:16px;padding:14px 28px">Se connecter</button>
        `;
        container.appendChild(message);
        return;
      }
      
      // V√©rifier les droits d'acc√®s
      const hasAccess = await checkUserAccess();
      if (!hasAccess) {
        hideLoading();
        return;
      }
    }
    
    // Initialiser l'application
    loadFormations(); 
    addStagiaire(); 
    initStarRatings(); 
    initCharCounters(); 
    checkURLParams(); 
    initEventListeners(); 
    initTypeFormationToggle(); 
    setTodayDate();
    
    hideLoading();
  });

  // ===== UI helpers =====
  function setTodayDate(){const el=document.getElementById('dateFormation'); if(el && !el.value){const d=new Date(),y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0'); el.value=`${y}-${m}-${da}`;}}
  function switchTab(name){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); const t=document.querySelector(`.tab[data-tab="${name}"]`),c=document.getElementById(name); if(t)t.classList.add('active'); if(c)c.classList.add('active'); if(name==='formations') loadFormationsTab(); }
  function initEventListeners(){
    document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click',function(){switchTab(this.getAttribute('data-tab'));}));
    const btnAdd=document.getElementById('btnAddStagiaire'); if(btnAdd) btnAdd.addEventListener('click',e=>{e.preventDefault(); addStagiaire();});
    const formateurForm=document.getElementById('formateurForm'); if(formateurForm) formateurForm.addEventListener('submit',e=>{e.preventDefault(); handleFormateurSubmit();});
    ['raisonSociale','theme','nomFormateur','dateFormation','heureDebut','heureFin'].forEach(id=>{const f=document.getElementById(id); if(!f) return; f.addEventListener('blur',()=>validateRequiredField(f)); f.addEventListener('input',()=>{if(f.value.trim()) clearError(f);});});
    const hd=document.getElementById('heureDebut'), hf=document.getElementById('heureFin'); if(hd) hd.addEventListener('change',validateHeures); if(hf){hf.addEventListener('change',validateHeures); hf.addEventListener('blur',validateHeures);} 
    const df=document.getElementById('dateFormation'); if(df) df.addEventListener('change',validateDateFormation);
    const presenceForm=document.getElementById('presenceForm'); if(presenceForm) presenceForm.addEventListener('submit',e=>{e.preventDefault(); handlePresenceSubmit();});
    const satisfactionForm=document.getElementById('satisfactionForm'); if(satisfactionForm) satisfactionForm.addEventListener('submit',e=>{e.preventDefault(); handleSatisfactionSubmit();});
    const jira=document.getElementById('referenceJira'); if(jira) jira.addEventListener('blur',function(){if(this.value.trim()) validateJiraReference(this);});
  }

  // ===== Validations (inchang√©) =====
  function showError(input,msg){input.style.borderColor='var(--danger)'; const ex=input.parentElement.querySelector('.error-message'); if(ex) ex.remove(); const s=document.createElement('small'); s.className='error-message'; s.textContent=msg; input.parentElement.appendChild(s);}
  function clearError(input){const ex=input.parentElement.querySelector('.error-message'); if(ex) ex.remove(); input.style.borderColor='#e0e0e0';}
  function validateRequiredField(input){ if(!input.value.trim()) showError(input,'Ce champ est obligatoire'); else {clearError(input); input.style.borderColor='var(--success)';}}
  function validateEmail(input){const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; if(input.value.trim() && !re.test(input.value)) showError(input,'Format email invalide'); else if(input.value.trim()){clearError(input); input.style.borderColor='var(--success)';}}
  function validateJiraReference(input){const r=/^(TIC|SMC|SNC)-\d+$/i; if(input.value.trim() && !r.test(input.value)) showError(input,'Format JIRA invalide (ex: TIC-123)'); else if(input.value.trim()){clearError(input); input.style.borderColor='var(--success)';}}
  function validateDateFormation(){const el=document.getElementById('dateFormation'); const d=new Date(el.value), today=new Date(); today.setHours(0,0,0,0); const min=new Date(); min.setDate(today.getDate()-7); if(d<min){showError(el,'La formation est trop ancienne. Date minimum: '+min.toLocaleDateString('fr-FR'));} else {clearError(el); el.style.borderColor='var(--success)';}}
  function validateHeures(){const hd=document.getElementById('heureDebut'), hf=document.getElementById('heureFin'); if(hd.value && hf.value){const [a,b]=hd.value.split(':').map(Number), [c,d]=hf.value.split(':').map(Number); if((c*60+d) <= (a*60+b)) showError(hf,"L'heure de fin doit √™tre apr√®s l'heure de d√©but"); else {clearError(hf); hf.style.borderColor='var(--success)';}}}
  function initTypeFormationToggle(){const t=document.getElementById('typeFormationToggle'), lp=document.getElementById('labelPresentiel'), lv=document.getElementById('labelVisio'); if(!t) return; t.addEventListener('change',function(){ if(this.checked){lp.classList.remove('active'); lv.classList.add('active');} else {lp.classList.add('active'); lv.classList.remove('active');}})}

  // ===== Gestion stagiaires (inchang√©) =====
  function addStagiaire(){ if(stagiaireCount>=MAX_STAGIAIRES){alert('‚ö†Ô∏è Maximum de '+MAX_STAGIAIRES+' stagiaires atteint'); return;} stagiaireCount++; const c=document.getElementById('stagiairesList'); const d=document.createElement('div'); d.className='stagiaire-item'; d.id='stagiaire-'+stagiaireCount; d.innerHTML=`
    <div class="stagiaire-header">
      <span class="stagiaire-number">Stagiaire ${stagiaireCount}</span>
      <button type="button" class="btn-remove" onclick="removeStagiaire(${stagiaireCount})">üóëÔ∏è Supprimer</button>
    </div>
    <div class="row">
      <div class="form-group"><label>Nom complet *</label><input type="text" id="nomStagiaire${stagiaireCount}" required></div>
      <div class="form-group"><label>Email *</label><input type="email" id="emailStagiaire${stagiaireCount}" required></div>
    </div>`; c.appendChild(d);
    const emailInput=document.getElementById('emailStagiaire'+stagiaireCount); if(emailInput){emailInput.addEventListener('blur',function(){validateEmail(this)}); emailInput.addEventListener('input',function(){if(this.value.trim()) clearError(this)});}
  }
  function removeStagiaire(id){const it=document.getElementById('stagiaire-'+id); if(it){it.remove(); stagiaireCount--;}}

  // ===== Submit formation -> Azure (inchang√© jusqu'√† la ligne suivante) =====
  async function handleFormateurSubmit(){
    const raisonSociale=document.getElementById('raisonSociale').value.trim();
    const theme=document.getElementById('theme').value.trim();
    const referenceJira=document.getElementById('referenceJira').value.trim();
    const nomFormateur=document.getElementById('nomFormateur').value.trim();
    const dateFormation=document.getElementById('dateFormation').value;
    const typeFormation=document.getElementById('typeFormationToggle').checked ? 'Visio':'Pr√©sentiel';
    const heureDebut=document.getElementById('heureDebut').value; const heureFin=document.getElementById('heureFin').value;

    if(!raisonSociale||!theme||!nomFormateur||!dateFormation||!heureDebut||!heureFin){alert('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires'); return;}
    if(referenceJira){const r=/^(TIC|SMC|SNC)-\d+$/i; if(!r.test(referenceJira)){alert('‚ö†Ô∏è Format de r√©f√©rence JIRA invalide. Utilisez TIC-123 / SMC-456 / SNC-789'); return;}}
    const d=new Date(dateFormation), today=new Date(); today.setHours(0,0,0,0); const min=new Date(); min.setDate(today.getDate()-7); if(d<min){alert('‚ö†Ô∏è La date de formation est trop ancienne (plus de 7 jours)'); return;}
    const [hd,md]=heureDebut.split(':').map(Number), [hf,mf]=heureFin.split(':').map(Number); if((hf*60+mf)<=(hd*60+md)){alert("‚ö†Ô∏è L'heure de fin doit √™tre apr√®s l'heure de d√©but"); return;}

    const stagiaires=[]; let hasError=false;
    for(let i=1;i<=stagiaireCount;i++){
      const nom=document.getElementById('nomStagiaire'+i); const email=document.getElementById('emailStagiaire'+i);
      if(!nom||!email) continue; const n=nom.value.trim(), e=email.value.trim();
      if(!n){showError(nom,'Ce champ est obligatoire'); hasError=true}
      else if(!e){showError(email,'Ce champ est obligatoire'); hasError=true}
      else if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){showError(email,'Format email invalide'); hasError=true}
      else {const id=crypto.randomUUID(); stagiaires.push({id,nom:n,email:e,presence:'Non renseign√©',commentaire:'',satisfaction:null});}
    }
    if(hasError){alert('‚ö†Ô∏è Veuillez corriger les erreurs avant de continuer'); return;}
    if(stagiaires.length===0){alert('‚ö†Ô∏è Veuillez ajouter au moins un stagiaire'); return;}

    const formationId=crypto.randomUUID(); const formation={id:formationId,raisonSociale,theme,referenceJira,nomFormateur,date:dateFormation,type:typeFormation,heureDebut,heureFin,stagiaires};
    formationsData.push(formation); saveFormations(); currentFormationData=formation; currentFormationId=formationId;

    if(ENABLE_SHAREPOINT_SYNC && FM_ENDPOINTS.createFormation){
      try{const payload={RaisonSociale:raisonSociale,Theme:theme,ReferenceJIRA:referenceJira||'',Formateur:nomFormateur,DateFormation:toDateISOFromInput(dateFormation)||dateFormation,TypeFormation:typeFormation,HeureDebut:heureDebut,HeureFin:heureFin,FormationID:formationId,Stagiaires:JSON.stringify(stagiaires.map(s=>({StagiaireID:s.id,Nom:s.nom,Email:s.email})))};
      await postJson(FM_ENDPOINTS.createFormation,payload); console.log('Formation cr√©√©e dans SharePoint');}catch(err){console.error('Erreur SharePoint createFormation:',err);}}

    document.getElementById('formSection').style.display='none';
    displayFormationInfo(formation); document.getElementById('postFormationSection').style.display='block';
    displayPresenceList(formation.stagiaires); generateEmail(formation);
  }

  function displayFormationInfo(f){const d=new Date(f.date).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}); document.getElementById('formationInfo').innerHTML=`
    <div class="info-row"><div class="info-label">Client :</div><div>${f.raisonSociale}</div></div>
    <div class="info-row"><div class="info-label">Formation :</div><div>${f.theme}</div></div>
    ${f.referenceJira?`<div class="info-row"><div class="info-label">R√©f√©rence JIRA :</div><div>${f.referenceJira}</div></div>`:''}
    <div class="info-row"><div class="info-label">Formateur :</div><div>${f.nomFormateur}</div></div>
    <div class="info-row"><div class="info-label">Date :</div><div>${d}</div></div>
    <div class="info-row"><div class="info-label">Type :</div><div>${f.type}</div></div>
    <div class="info-row"><div class="info-label">Horaires :</div><div>${f.heureDebut} - ${f.heureFin}</div></div>
    <div class="info-row"><div class="info-label">Stagiaires :</div><div>${f.stagiaires.length}</div></div>`;}

  function displayPresenceList(stagiaires){const c=document.getElementById('presenceList'); c.innerHTML=''; stagiaires.forEach((s,i)=>{const d=document.createElement('div'); d.className='stagiaire-item'; d.innerHTML=`
    <div class="stagiaire-header"><strong>${s.nom}</strong> <span style="color:var(--muted)">${s.email}</span></div>
    <div class="form-group" style="margin-top:12px">
      <label>Pr√©sence *</label>
      <div class="presence-radio-group">
        <label class="presence-item"><input type="radio" name="presence${i}" value="Present" required><label>‚úÖ Pr√©sent</label></label>
        <label class="presence-item"><input type="radio" name="presence${i}" value="Partielle" required><label>‚è±Ô∏è Partielle</label></label>
        <label class="presence-item"><input type="radio" name="presence${i}" value="Absent" required><label>‚ùå Absent</label></label>
      </div>
    </div>
    <div class="form-group">
      <label>Commentaire formateur</label>
      <textarea id="commentaire${i}" maxlength="150" rows="2" placeholder="Optionnel (max 150 caract√®res)"></textarea>
    </div>`; c.appendChild(d);});}

  function generateEmail(f){const base=window.location.origin+window.location.pathname;
    emailSubjectGlobal=`√âvaluation de votre formation "${f.theme}"`;
    emailBodyGlobal=`Bonjour,\n\nNous esp√©rons que la formation "${f.theme}" anim√©e par ${f.nomFormateur} vous a √©t√© utile.\n\nNous vous invitons √† compl√©ter notre enqu√™te de satisfaction en cliquant sur votre lien personnalis√© ci-dessous :\n\n[LIEN]\n\nCela ne vous prendra que quelques minutes et vos retours sont essentiels pour am√©liorer nos formations.\n\nMerci pour votre participation !\n\nCordialement,\nL'√©quipe WeN√©goce`;}

  async function handlePresenceSubmit(){const formation=formationsData.find(f=>f.id===currentFormationId); if(!formation) return; let hasError=false;
    formation.stagiaires.forEach((s,i)=>{const p=document.querySelector(`input[name="presence${i}"]:checked`); if(!p){hasError=true; return;} s.presence=p.value; const com=document.getElementById('commentaire'+i); if(com) s.commentaire=com.value.trim();});
    if(hasError){alert('‚ö†Ô∏è Veuillez s√©lectionner la pr√©sence pour tous les stagiaires'); return;}
    saveFormations();

    if(ENABLE_SHAREPOINT_SYNC && FM_ENDPOINTS.createPresence){
      try{for(const s of formation.stagiaires){const payload={FormationID:currentFormationId,StagiaireID:s.id,Nom:s.nom,Email:s.email,Presence:s.presence,Commentaire:s.commentaire||''}; await postJson(FM_ENDPOINTS.createPresence,payload);}
      console.log('Pr√©sences envoy√©es √† SharePoint');}catch(err){console.error('Erreur SharePoint createPresence:',err);}}

    document.getElementById('postFormationSection').style.display='none'; const links=document.getElementById('emailLinks'); links.innerHTML='';
    formation.stagiaires.forEach(s=>{if(s.presence!=='Absent'){const link=`${window.location.origin}${window.location.pathname}?fid=${formation.id}&stid=${s.id}`;
      const preview=`<div class="card" style="padding:18px;margin-bottom:18px"><h4 style="color:var(--brand);margin:0 0 12px">üìß ${s.nom}</h4><div class="email-preview"><strong>√Ä :</strong> ${s.email}<br><strong>Objet :</strong> ${emailSubjectGlobal}<br><br>${emailBodyGlobal.replace('[LIEN]',`<a href="${link}" class="email-link">${link}</a>`)}</div><button class="btn" onclick="sendIndividualEmail('${formation.id}','${s.id}')" style="margin-top:12px">üì§ Envoyer cet email</button><button class="btn-edit" onclick="openEmailModal()" style="margin-top:12px;margin-left:10px">‚úèÔ∏è Modifier le mod√®le</button></div>`;
      links.innerHTML += preview;}});
    document.getElementById('linksGenerated').style.display='block';}

  function sendIndividualEmail(fid,sid){alert('üìß Fonctionnalit√© d\'envoi d\'email en cours d\'impl√©mentation.\nUtilisez votre client email pour copier/coller le lien.');}
  function saveEmailChanges(){emailSubjectGlobal=document.getElementById('emailSubjectEdit').value; emailBodyGlobal=document.getElementById('emailBodyEdit').value; closeEmailModal(); alert('‚úÖ Mod√®le d\'email mis √† jour');}
  function openReminderModal(fid,sidx){const f=formationsData.find(x=>x.id===fid); if(!f) return; const s=f.stagiaires.find((x,i)=>i===sidx); if(!s) return; document.getElementById('reminderInfo').innerHTML=`<div class="info-row"><div class="info-label">Stagiaire :</div><div>${s.nom}</div></div><div class="info-row"><div class="info-label">Email :</div><div>${s.email}</div></div><div class="info-row"><div class="info-label">Formation :</div><div>${f.theme}</div></div>`; document.getElementById('reminderSubjectEdit').value=`Relance : ${emailSubjectGlobal}`; document.getElementById('reminderBodyEdit').value=`Bonjour ${s.nom},\n\nNous n'avons pas encore re√ßu votre √©valuation concernant la formation "${f.theme}".\n\nNous vous rappelons que votre retour est important pour nous aider √† am√©liorer nos formations.\n\nVoici √† nouveau votre lien personnalis√© :\n[LIEN]\n\nMerci par avance.\n\nCordialement,\nL'√©quipe WeN√©goce`; document.getElementById('reminderModal').style.display='flex';}
  function closeReminderModal(){document.getElementById('reminderModal').style.display='none'}
  function sendReminder(){alert('üìß Relance envoy√©e !'); closeReminderModal();}

  function initStarRatings(){['q1','q2','q3'].forEach(q=>{const c=document.getElementById(q+'Stars'); if(!c) return; for(let i=1;i<=5;i++){const s=document.createElement('span'); s.className='star'; s.textContent='‚òÖ'; s.dataset.value=i; s.addEventListener('click',function(){document.getElementById(q).value=this.dataset.value; c.querySelectorAll('.star').forEach((st,idx)=>st.classList.toggle('active',idx<i));}); c.appendChild(s);}});}
  function initCharCounters(){['q6','q7'].forEach(id=>{const t=document.getElementById(id); if(!t) return; const count=document.getElementById(id+'Count'); t.addEventListener('input',()=>{const r=100-t.value.length; count.textContent=r;});});}

  function handleSatisfactionSubmit(){const q4=document.querySelector('input[name="q4"]:checked'); const q5=document.querySelector('input[name="q5"]:checked'); if(!q4||!q5){alert('‚ö†Ô∏è Veuillez r√©pondre √† toutes les questions obligatoires (*)'); return;} const q1=parseInt(document.getElementById('q1').value||'0',10); const q2=parseInt(document.getElementById('q2').value||'0',10); const q3=parseInt(document.getElementById('q3').value||'0',10); let q4s=0; switch(q4.value){case 'Pas du tout':q4s=0;break;case 'Un peu':q4s=1;break;case 'Moyennement':q4s=2;break;case 'Assez':q4s=3;break;case 'Tout √† fait':q4s=5;break;} let q5s=0; switch(q5.value){case 'Trop courte':q5s=0;break;case 'Adapt√©e':q5s=5;break;case 'Trop longue':q5s=3;break;} const total=q1+q2+q3+q4s+q5s; const note=(total/5).toFixed(2); const url=new URL(window.location.href); const formationId=url.searchParams.get('fid'); const stagiaireId=url.searchParams.get('stid'); const satisfaction={q1,q2,q3,q4:q4.value,q5:q5.value,q6:document.getElementById('q6').value,q7:document.getElementById('q7').value,noteGlobale:note,dateEnvoi:new Date().toISOString()}; if(ENABLE_SHAREPOINT_SYNC && FM_ENDPOINTS.manager){ const payload={action:'SaveSatisfaction', FormationID:formationId, StagiaireID:stagiaireId, Q1_Attentes:q1, Q2_Objectifs:q2, Q3_Formateur:q3, Q4_Aise:q4.value, Q5_Duree:q5.value, Q6_Suggestions:satisfaction.q6||'', Q7_Commentaire:satisfaction.q7||'', NoteGlobale:parseFloat(note), DateReponse:satisfaction.dateEnvoi}; postJson(FM_ENDPOINTS.manager,payload).then(()=>{const msg= note<3 ? 'Nous allons revenir vers vous pour comprendre cette √©valuation.' : (note<=4.5 ? 'Merci, votre retour va nous permettre de nous am√©liorer.' : 'Merci ! Cette bonne note nous encourage √† continuer.'); displayThankYouMessage(note,msg);}).catch(err=>{console.error('Erreur envoi satisfaction:',err); displayThankYouMessage(note,'Votre r√©ponse est enregistr√©e localement. Une erreur est survenue c√¥t√© serveur.');}); } else { displayThankYouMessage(note,'Votre r√©ponse est enregistr√©e localement (mode hors-ligne).'); } }

  function displayThankYouMessage(note,message){document.getElementById('infoFormation').style.display='none'; document.getElementById('satisfactionForm').style.display='none'; const t=document.getElementById('thankYouMessage'); t.innerHTML=`
    <div class="alert alert-success">
      <h3 style="margin-bottom:10px">‚úÖ Merci pour votre participation !</h3>
      <p style="font-size:18px;margin:10px 0"><strong>Votre avis compte beaucoup pour nous.</strong></p>
      <p style="font-size:20px;margin:10px 0;color:var(--brand)"><strong>Votre appr√©ciation globale est de ${note} sur 5.</strong></p>
      <p style="margin-top:10px">${message||''}</p>
    </div>`; t.style.display='block';}

  // ===== Stockage local & export =====
  function saveFormations(){localStorage.setItem('wenegoce_formations',JSON.stringify(formationsData));}
  function loadFormations(){const s=localStorage.getItem('wenegoce_formations'); if(!s) return; try{formationsData=JSON.parse(s)||[];}catch(e){console.error('Erreur chargement localStorage:',e); formationsData=[];}}
  function generateExcel(autoExport=false){if(formationsData.length===0){if(!autoExport) alert('‚ùå Aucune donn√©e √† exporter'); return;} const data=[]; formationsData.forEach(f=>{const row={'Date':new Date(f.date).toLocaleDateString('fr-FR'),'Client':f.raisonSociale,'Formation':f.theme,'R√©f√©rence JIRA':f.referenceJira||'','Formateur':f.nomFormateur,'Type':f.type,'Heure d√©but':f.heureDebut,'Heure fin':f.heureFin}; for(let i=0;i<10;i++){const s=f.stagiaires[i]; const p=`Stagiaire ${i+1} - `; if(s){row[p+'Nom']=s.nom; row[p+'Email']=s.email; row[p+'Pr√©sence']=s.presence||'Non renseign√©'; row[p+'Commentaire formateur']=s.commentaire||''; if(s.satisfaction){row[p+'Q1 (attentes 1-5)']=s.satisfaction.q1; row[p+'Q2 (objectifs 1-5)']=s.satisfaction.q2; row[p+'Q3 (formateur 1-5)']=s.satisfaction.q3; row[p+'Q4 (aisance)']=s.satisfaction.q4; row[p+'Q5 (dur√©e)']=s.satisfaction.q5; row[p+'Suggestions']=s.satisfaction.q6; row[p+'Commentaire']=s.satisfaction.q7; row[p+'Note globale /5']=s.satisfaction.noteGlobale; row[p+'Date r√©ponse']=new Date(s.satisfaction.dateEnvoi).toLocaleDateString('fr-FR');} else {row[p+'Q1 (attentes 1-5)']=''; row[p+'Q2 (objectifs 1-5)']=''; row[p+'Q3 (formateur 1-5)']=''; row[p+'Q4 (aisance)']=''; row[p+'Q5 (dur√©e)']=''; row[p+'Suggestions']=""; row[p+'Commentaire']=''; row[p+'Note globale /5']=''; row[p+'Date r√©ponse']='';}} else {row[p+'Nom']=''; row[p+'Email']=''; row[p+'Pr√©sence']=''; row[p+'Commentaire formateur']=''; row[p+'Q1 (attentes 1-5)']=''; row[p+'Q2 (objectifs 1-5)']=''; row[p+'Q3 (formateur 1-5)']=''; row[p+'Q4 (aisance)']=''; row[p+'Q5 (dur√©e)']=''; row[p+'Suggestions']=''; row[p+'Commentaire']=''; row[p+'Note globale /5']=''; row[p+'Date r√©ponse']='';}} data.push(row);}); const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Formations'); const file='wenegoce-formations-'+new Date().toISOString().split('T')[0]+'.xlsx'; XLSX.writeFile(wb,file); if(!autoExport) console.log('Export Excel g√©n√©r√© : '+file);}

  // ===== Onglet Formations =====
  async function loadFormationsTab(){const loading=document.getElementById('formationsLoading'); const list=document.getElementById('formationsList'); const empty=document.getElementById('formationsEmpty'); loading.style.display='block'; list.style.display='none'; empty.style.display='none'; let arr=[...formationsData]; const three=new Date(); three.setMonth(three.getMonth()-3); arr=arr.filter(f=>{const d=new Date(f.date); if(d<three) return false; return f.stagiaires.some(s=>(s.presence==='Present'||s.presence==='Partielle') && !s.satisfaction);}); setTimeout(()=>{loading.style.display='none'; if(arr.length===0) empty.style.display='block'; else {displayFormationsCards(arr); list.style.display='block';}},400);}
  function displayFormationsCards(list){const c=document.getElementById('formationsList'); c.innerHTML=''; list.forEach(f=>c.appendChild(createFormationCard(f)));}
  function createFormationCard(f){const date=new Date(f.date).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}); const pending=f.stagiaires.filter(s=>(s.presence==='Present'||s.presence==='Partielle')&&!s.satisfaction); const card=document.createElement('div'); card.className='formation-card'; let stagList=''; pending.forEach((s,i)=>{stagList += `<div class="stagiaire-item" style="margin:12px 0;padding:12px;background:#f8f9fa;border-radius:10px"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${s.nom}</strong><br><small style="color:#666">${s.email}</small></div><button class="btn" onclick="openReminderModal('${f.id}', ${i})" style="background:var(--warning)">üìß Relancer le stagiaire</button></div></div>`;}); card.innerHTML=`
      <div class="formation-card-header" style="background:var(--brand);color:#fff;padding:14px;border-radius:12px 12px 0 0">
        <div style="margin-bottom:6px"><div style="font-size:14px;opacity:.9;font-weight:600">${f.raisonSociale}</div><div class="formation-card-title" style="font-size:18px;margin-top:2px">${f.theme}</div></div>
        <div class="formation-card-date" style="font-size:13px;opacity:.85;font-style:italic;border-top:1px solid rgba(255,255,255,.25);padding-top:6px;margin-top:6px">${date}</div>
      </div>
      <div class="formation-card-body" style="padding:14px">
        <h4 style="color:var(--brand);margin:0 0 10px">Stagiaires en attente de r√©ponse :</h4>
        ${stagList}
      </div>`; return card;}

  // ===== Routing lien stagiaire =====
  function checkURLParams(){const p=new URLSearchParams(window.location.search); const fid=p.get('fid'), sid=p.get('stid'); if(fid && sid){document.querySelectorAll('.tab').forEach(t=>{if(t.getAttribute('data-tab')!=='stagiaire') t.style.display='none';}); switchTab('stagiaire'); loadStagiaireView(fid,sid);}}

  // ===== Vue stagiaire (r√©cup via Azure manager si non local) =====
  async function loadStagiaireView(fid,sid){
    let formation=formationsData.find(f=>f.id===fid);
    if(!formation && FM_ENDPOINTS.manager){
      try{
        const raw=await postJson(FM_ENDPOINTS.manager,{formationId:fid, stagiaireId:sid});
        const data=(raw && raw.formation)?raw.formation:raw;
        formation=transformAzureFormation(data);
      }catch(e){
        console.error('Erreur r√©cup√©ration Azure manager:',e);
      }
    }
    if(!formation){
      document.getElementById('infoFormation').innerHTML=`<div class="alert" style="background:#f8d7da;border:1px solid #f5c6cb;color:#721c24">‚ùå Formation non trouv√©e ou lien invalide.</div>`;
      return;
    }
    const stagiaire=formation.stagiaires.find(s=>s.id===sid);
    if(!stagiaire){
      document.getElementById('infoFormation').innerHTML=`<div class="alert" style="background:#f8d7da;border:1px solid #f5c6cb;color:#721c24">‚ùå Stagiaire non trouv√© ou lien invalide.</div>`;
      return;
    }
    if(stagiaire.satisfaction){
      displayThankYouMessage(stagiaire.satisfaction.noteGlobale,'Merci ! Votre retour a bien √©t√© enregistr√©.');
      return;
    }
    const d=new Date(formation.date).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    document.getElementById('infoFormation').innerHTML=`
      <h3 style="color:var(--brand);margin-bottom:10px">‚úÖ Attestation de pr√©sence</h3>
      <div class="info-row"><div class="info-label">Formation :</div><div>${formation.theme}</div></div>
      <div class="info-row"><div class="info-label">Date :</div><div>${d}</div></div>
      <div class="info-row"><div class="info-label">Horaires :</div><div>${formation.heureDebut} - ${formation.heureFin}</div></div>
      <div class="info-row"><div class="info-label">Formateur :</div><div>${formation.nomFormateur}</div></div>
      <div class="info-row"><div class="info-label">Client :</div><div>${formation.raisonSociale}</div></div>
      <div class="info-row"><div class="info-label">Stagiaire :</div><div>${stagiaire.nom}</div></div>
      <div class="info-row"><div class="info-label">Statut :</div><div><strong style="color:${stagiaire.presence==='Present'?'#28a745':'#dc3545'}">${stagiaire.presence||'Non renseign√©'}</strong></div></div>`;
    if(stagiaire.presence!=='Absent'){
      const form=document.getElementById('satisfactionForm');
      form.style.display='block';
      form.onsubmit=function(e){e.preventDefault(); handleSatisfactionSubmit();};
    } else {
      document.getElementById('infoFormation').innerHTML += `<div class="alert alert-warning" style="margin-top:10px">‚ÑπÔ∏è L'enqu√™te de satisfaction est disponible uniquement pour les stagiaires pr√©sents ou partiels.</div>`;
    }
  }

  // ===== CORRECTION : Fonction transformAzureFormation avec fermeture correcte =====
  function transformAzureFormation(sp){
    if(!sp) return null;
    
    let stagiaires=[];
    if(sp.Stagiaires!==undefined){
      const raw=sp.Stagiaires;
      if(typeof raw==='string'){
        try{stagiaires=JSON.parse(raw)}catch{stagiaires=[]}
      } else if(Array.isArray(raw)){
        stagiaires=raw
      } else if(raw&&typeof raw==='object'){
        stagiaires=[raw]
      }
    } else if(sp.stagiaires){
      stagiaires=sp.stagiaires
    }
    
    let date=sp.DateFormation||sp.Date||sp.date;
    if(date && typeof date==='string' && date.includes('T')) date=date.split('T')[0];
    
    return {
      id:sp.FormationID||sp.id,
      raisonSociale:sp.RaisonSociale||sp.Client||sp.raisonSociale||'',
      theme:sp.Theme||sp.theme||'',
      referenceJira:sp.ReferenceJIRA||sp.ReferenceJira||sp.referenceJira||'',
      nomFormateur:sp.Formateur||sp.NomFormateur||sp.nomFormateur||'',
      date:date||'',
      type:sp.TypeFormation||sp.type||'',
      heureDebut:sp.HeureDebut||sp.heureDebut||'',
      heureFin:sp.HeureFin||sp.heureFin||'',
      stagiaires
    };
  }

  // ===== Modales email =====
  function openEmailModal(){document.getElementById('emailSubjectEdit').value=emailSubjectGlobal; document.getElementById('emailBodyEdit').value=emailBodyGlobal; document.getElementById('emailModal').style.display='flex';}
  function closeEmailModal(){document.getElementById('emailModal').style.display='none'}

  // Expose pour onClick inline
  window.switchTab=switchTab; window.addStagiaire=addStagiaire; window.removeStagiaire=removeStagiaire;
  window.openEmailModal=openEmailModal; window.closeEmailModal=closeEmailModal; window.saveEmailChanges=saveEmailChanges;
  window.openReminderModal=openReminderModal; window.closeReminderModal=closeReminderModal; window.sendReminder=sendReminder;
  window.sendIndividualEmail=sendIndividualEmail;
  </script>
</body>
</html>
