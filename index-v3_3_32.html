<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formation Manager - WeN√©goce</title>

  <!-- Favicon pour √©viter 404 console -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéì</text></svg>">

  <!-- MSAL via unpkg (plus fiable) -->
  <script src="https://unpkg.com/@azure/msal-browser@3.21.0/lib/msal-browser.min.js" crossorigin="anonymous"></script>
  
  <!-- Attendre le chargement de MSAL -->
  <script>
    window.__msalReady = new Promise(function(resolve) {
      if (typeof msal !== 'undefined') {
        resolve();
      } else {
        var checkMsal = setInterval(function() {
          if (typeof msal !== 'undefined') {
            clearInterval(checkMsal);
            resolve();
          }
        }, 50);
      }
    });
  </script>

  <!-- Styles V3.2 (look & feel WeN√©goce - inchang√©) -->
  <style>
    :root{
      --brand:#3270AF; /* primaire WeN√©goce */
      --brand-600:#2b66a3;
      --brand-50:#e7f3ff;
      --text:#1f2937;
      --muted:#6b7280;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e5e7eb;
      --success:#28a745;
      --warning:#ff9800;
      --danger:#dc3545;
      --radius:12px;
      --shadow:0 6px 14px rgba(0,0,0,.06), 0 2px 6px rgba(0,0,0,.04);
      --shadow-sm:0 2px 8px rgba(0,0,0,.06);
      --focus:0 0 0 3px rgba(50,112,175,.25);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:#F0F7FE;background-attachment:fixed;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;line-height:1.45}
    img{max-width:100%;height:auto}

    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .header{display:flex;gap:28px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;box-shadow:var(--shadow-sm)}

    /* Nouveau : User info et login button */
    .auth-section{display:flex;align-items:center;gap:12px;margin-left:auto}
    .user-info{display:flex;align-items:center;gap:10px;padding:0;background:transparent;border-radius:8px}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--brand);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:15px;box-shadow:0 2px 8px rgba(50,112,175,0.3)}
    .user-name{font-size:14px;color:var(--text);font-weight:600}
    .btn-login{background:var(--brand);color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;transition:.2s}
    .btn-login:hover{background:var(--brand-600)}
    .btn-logout{background:transparent;color:var(--brand);border:1px solid var(--brand);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;transition:.2s}
    .btn-logout:hover{background:var(--brand-50)}

    .tabs{display:flex;gap:10px;margin:18px 0 12px;flex-wrap:wrap}
    .tab{appearance:none;border:1px solid var(--border);background:var(--card);padding:10px 14px;border-radius:10px;cursor:pointer;transition:.2s box-shadow,.2s transform,.2s background;box-shadow:var(--shadow-sm);font-weight:600;color:var(--text)}
    .tab:hover{transform:translateY(-1px)}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#fff;box-shadow:var(--shadow)}

    .content .tab-content{display:none}
    .content .tab-content.active{display:block}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-sm)}

    .form-group{margin-bottom:16px}
    label{font-weight:600;display:block;margin-bottom:6px}
    input[type="text"],input[type="email"],input[type="date"],input[type="time"],textarea{
      width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;background:#fff;transition:.2s border,.2s box-shadow;font-size:14px
    }
    input:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:var(--focus)}
    input.valid{border-color:var(--success) !important}
    input.invalid{border-color:var(--danger) !important}

    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}

    .btn{background:var(--brand);color:#fff;border:none;padding:12px 16px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow-sm);transition:.2s transform,.2s box-shadow}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:#6b7280}
    .btn-success{background:var(--success)}
    .btn-edit{background:#0ea5e9;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn-remove{background:#ef4444;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer}

    .switch-container{display:flex;align-items:center;gap:10px}
    .switch{position:relative;width:52px;height:30px;display:inline-block}
    .switch input{display:none}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;transition:.2s;border-radius:999px}
    .slider:before{content:"";position:absolute;height:22px;width:22px;left:4px;top:4px;background:#fff;border-radius:999px;transition:.2s}
    .switch input:checked + .slider{background:var(--brand)}
    .switch input:checked + .slider:before{transform:translateX(22px)}
    .switch-label{font-weight:600;color:#6b7280}
    .switch-label.active{color:var(--brand)}

    .alert{padding:14px 16px;border-radius:10px;border:1px solid var(--border);background:#fff}
    .alert-info{background:#eef6ff;border-color:#dbeafe;color:#1e3a8a}
    .alert-success{background:#ecfdf5;border-color:#d1fae5;color:#065f46}
    .alert-warning{background:#fff7ed;border-color:#ffedd5;color:#7c2d12}

    .info-display{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 12px}
    .info-row{display:grid;grid-template-columns:220px 1fr;gap:12px;padding:8px 4px;border-bottom:1px dashed #edf2f7}
    .info-row:last-child{border-bottom:none}
    .info-label{color:var(--muted);font-weight:600}

    .stagiaire-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:var(--shadow-sm)}
    .stagiaire-header{display:flex;align-items:center;justify-content:space-between}
    .stagiaire-number{font-weight:700;color:var(--brand)}

    .radio-group{display:flex;gap:14px;flex-wrap:wrap}
    .radio-item{display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 10px;border-radius:10px;background:#fff}
    .radio-item input[type="radio"]{accent-color:var(--brand)}

    .stars{display:flex;gap:6px;font-size:32px;cursor:pointer;user-select:none}
    .star{color:#d1d5db;transition:.15s}
    .star.active,.star:hover{color:#fbbf24}

    .presence-radio-group{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
    .presence-item{flex:1;min-width:140px;border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer;transition:.2s;background:#fff}
    .presence-item:hover{border-color:var(--brand);transform:scale(1.02)}
    .presence-item input[type="radio"]{margin-right:8px;accent-color:var(--brand)}
    .presence-item input[type="radio"]:checked + label{font-weight:600;color:var(--brand)}

    .email-preview{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin:12px 0;font-family:inherit}
    .email-link{display:block;padding:12px;background:var(--brand);color:#fff;text-decoration:none;border-radius:8px;text-align:center;margin:10px 0;font-weight:600;transition:.2s}
    .email-link:hover{background:var(--brand-600);transform:translateY(-1px)}

    .formation-card{border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px;box-shadow:var(--shadow-sm);background:var(--card);overflow:hidden;transition:.2s}
    .formation-card:hover{box-shadow:var(--shadow)}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:1000;align-items:center;justify-content:center}
    .modal-content{background:var(--card);border-radius:var(--radius);max-width:600px;width:90%;max-height:90vh;overflow:auto;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    .modal-header{background:var(--brand);color:#fff;padding:16px 18px;display:flex;justify-content:space-between;align-items:center;border-radius:var(--radius) var(--radius) 0 0}
    .modal-header h3{margin:0}
    .modal-body{padding:18px}
    .btn-icon{background:transparent;border:none;font-size:22px;cursor:pointer;color:inherit;padding:0;transition:.2s}
    .btn-icon:hover{opacity:.8}

    textarea{resize:vertical;font-family:inherit}
    small{display:block;margin-top:4px;color:var(--muted)}
    .error-message{color:var(--danger);font-size:13px;margin-top:4px}

    .loading-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.95);display:none;align-items:center;justify-content:center;z-index:2000;flex-direction:column;gap:16px}
    .loading-screen.active{display:flex}
    .spinner{width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)}}

    .version-info{text-align:center;padding:16px;color:var(--muted);font-size:13px;border-top:1px solid var(--border);margin-top:32px}
    .version-number{font-weight:700;color:var(--brand);font-size:14px;margin-bottom:4px}
    .version-date{margin-bottom:8px}
    .copyright{font-size:12px;line-height:1.5}

    @media(max-width:768px){
      .row{grid-template-columns:1fr}
      .info-row{grid-template-columns:1fr;gap:4px}
      .header{flex-direction:column;text-align:center}
      .auth-section{margin-left:0;width:100%;justify-content:center}
    }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="spinner"></div>
    <div style="color:var(--brand);font-weight:600">Chargement...</div>
  </div>

  <div class="container">
    <!-- Logo WeN√©goce au-dessus du header -->
    <div style="margin-bottom: 12px;">
      <img src="https://back.wenegoce.fr/uploads/0406_Logo_We_Negoce_avec_We_Soft_DEFINITIF_502368ceeb.png" alt="WeN√©goce" style="width: 216px; cursor: pointer; transition: transform 0.2s;" onclick="resetForm()" title="Retour au formulaire vierge">
    </div>

    <div class="header">
      <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
        <img src="https://back.wenegoce.fr/uploads/logo_Formation_Manager_521b78e5c4.png" alt="Formation Manager" style="height: 69.3px; cursor: pointer;" onclick="resetForm()" title="Retour au formulaire vierge">
      </div>
      <div class="auth-section" id="authSection">
        <!-- Sera rempli dynamiquement par JS -->
      </div>
    </div>

    <!-- Navigation tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="nouveau">‚ûï Cr√©er une formation</button>
      <button class="tab" data-tab="formations">üìã Historique</button>
      <button class="tab" data-tab="stagiaire" style="display:none">üë§ Espace Stagiaire</button>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- NOUVEAU -->
      <div id="nouveau" class="tab-content active">
        <div id="formSection">
          <form id="formateurForm" class="card" style="padding:18px;">
            <div class="form-group">
              <label>Raison sociale du client *</label>
              <input type="text" id="raisonSociale" placeholder="Ex: Entreprise XYZ" required>
            </div>
            <div class="form-group">
              <label>Th√®me de la formation *</label>
              <input type="text" id="theme" placeholder="Ex: Gestion de projet" required>
            </div>
            <div class="form-group">
              <label>R√©f√©rence JIRA (optionnel)</label>
              <input type="text" id="referenceJira" placeholder="Ex: TIC-123">
            </div>
            <div class="form-group">
              <label>Nom du formateur *</label>
              <input type="text" id="nomFormateur" placeholder="Ex: Jean Dupont" required>
              <small style="color:var(--muted);font-size:12px;display:block;margin-top:4px">
                üí° Votre nom est pr√©-rempli par d√©faut. Vous pouvez le modifier si besoin.
              </small>
            </div>
            <div class="row">
              <div class="form-group">
                <label>Date de la formation *</label>
                <input type="date" id="dateFormation" required>
              </div>
              <div class="form-group">
                <label>Type de formation *</label>
                <div class="switch-container">
                  <span class="switch-label active" id="labelPresentiel">Pr√©sentiel</span>
                  <label class="switch">
                    <input type="checkbox" id="typeFormationToggle">
                    <span class="slider"></span>
                  </label>
                  <span class="switch-label" id="labelVisio">Visio</span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="form-group">
                <label>Heure de d√©but *</label>
                <input type="time" id="heureDebut" value="09:00" required>
              </div>
              <div class="form-group">
                <label>Heure de fin *</label>
                <input type="time" id="heureFin" value="17:00" required>
              </div>
            </div>

            <h3 style="margin:22px 0 12px;color:var(--brand);">Stagiaires</h3>
            <div id="stagiairesList"></div>
            <button type="button" id="btnAddStagiaire" class="btn btn-secondary" style="margin-top:12px">‚ûï Ajouter un stagiaire</button>
            <div style="margin-top:18px">
              <button type="submit" class="btn">üíæ Enregistrer la formation</button>
            </div>
          </form>
        </div>
        
        <!-- Section de validation des pr√©sences (cach√©e par d√©faut) -->
        <div id="validationPresenceSection" style="display:none">
          <div class="card" style="padding:18px;">
            <div style="margin-bottom:16px">
              <h2 style="margin:0;color:var(--brand)">‚úÖ Valider les pr√©sences</h2>
            </div>
            
            <div id="formationInfoValidation" class="info-display" style="margin-bottom:20px"></div>
            
            <!-- Mod√®le d'email -->
            <div style="background:#e7f3ff;padding:20px;border-radius:8px;border-left:4px solid var(--brand);margin-bottom:20px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                <strong style="color:var(--brand)">üìß Mod√®le d'email</strong>
                <button class="btn-edit" onclick="openEmailModal()">‚úèÔ∏è Personnaliser l'email</button>
              </div>
              <div id="emailTemplatePreview" style="padding:15px;background:white;border-radius:8px">
                <div style="margin-bottom:10px"><strong>Objet :</strong> <span id="emailSubjectPreview"></span></div>
                <div style="white-space:pre-wrap;color:#666;font-size:14px" id="emailBodyPreview"></div>
              </div>
            </div>
            
            <h3 style="color:var(--brand);margin-bottom:12px">Liste des stagiaires</h3>
            <div id="stagiairePresenceList"></div>
            
            <div style="margin-top:20px">
              <button class="btn" onclick="envoyerTousEmails()">üìß Envoi tous les mails</button>
            </div>
          </div>
        </div>
      </div>

      <!-- FORMATIONS -->
      <div id="formations" class="tab-content">
        <div class="card" style="padding:18px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px">
            <h2 style="margin:0;color:var(--brand)">üìã Historique des formations</h2>
            <button class="btn" onclick="loadFormationsTab()">üîÑ Actualiser</button>
          </div>
          <div id="formationsList">Chargement...</div>
        </div>
      </div>

      <!-- STAGIAIRE -->
      <div id="stagiaire" class="tab-content">
        <!-- Section 1 : Attestation de pr√©sence -->
        <div class="card" style="padding:18px;margin-bottom:20px">
          <h2 style="color:var(--brand);margin-bottom:16px">üìú Attestation de pr√©sence</h2>
          <div id="attestationPresence" class="info-display">
            <!-- Sera rempli dynamiquement -->
          </div>
        </div>

        <!-- Section 2 : Enqu√™te de satisfaction -->
        <div class="card" style="padding:18px">
          <h2 style="color:var(--brand);margin-bottom:16px">‚≠ê Enqu√™te de satisfaction</h2>
          <form id="satisfactionForm">
            <!-- Question 1 : Attentes -->
            <div class="form-group">
              <label>La formation a-t-elle r√©pondu √† vos attentes ? *</label>
              <div id="starsAttentes" class="stars">
                <span class="star" data-value="1" data-group="attentes">‚òÖ</span>
                <span class="star" data-value="2" data-group="attentes">‚òÖ</span>
                <span class="star" data-value="3" data-group="attentes">‚òÖ</span>
                <span class="star" data-value="4" data-group="attentes">‚òÖ</span>
                <span class="star" data-value="5" data-group="attentes">‚òÖ</span>
              </div>
              <input type="hidden" id="noteAttentes" required>
            </div>

            <!-- Question 2 : Objectifs -->
            <div class="form-group">
              <label>Les objectifs de la formation √©taient-ils clairs et bien expliqu√©s ? *</label>
              <div id="starsObjectifs" class="stars">
                <span class="star" data-value="1" data-group="objectifs">‚òÖ</span>
                <span class="star" data-value="2" data-group="objectifs">‚òÖ</span>
                <span class="star" data-value="3" data-group="objectifs">‚òÖ</span>
                <span class="star" data-value="4" data-group="objectifs">‚òÖ</span>
                <span class="star" data-value="5" data-group="objectifs">‚òÖ</span>
              </div>
              <input type="hidden" id="noteObjectifs" required>
            </div>

            <!-- Question 3 : Formateur -->
            <div class="form-group">
              <label>Le formateur a-t-il su rendre la session claire, dynamique et adapt√©e √† votre niveau ? *</label>
              <div id="starsFormateur" class="stars">
                <span class="star" data-value="1" data-group="formateur">‚òÖ</span>
                <span class="star" data-value="2" data-group="formateur">‚òÖ</span>
                <span class="star" data-value="3" data-group="formateur">‚òÖ</span>
                <span class="star" data-value="4" data-group="formateur">‚òÖ</span>
                <span class="star" data-value="5" data-group="formateur">‚òÖ</span>
              </div>
              <input type="hidden" id="noteFormateur" required>
            </div>

            <!-- Question 4 : Utilisation logiciel -->
            <div class="form-group">
              <label>Vous sentez-vous √† l'aise pour utiliser le logiciel dans vos t√¢ches quotidiennes ? *</label>
              <div class="radio-group">
                <div class="radio-item"><input type="radio" name="utilisation" value="Pas du tout" id="util1"><label for="util1">Pas du tout</label></div>
                <div class="radio-item"><input type="radio" name="utilisation" value="Un peu" id="util2"><label for="util2">Un peu</label></div>
                <div class="radio-item"><input type="radio" name="utilisation" value="Moyennement" id="util3"><label for="util3">Moyennement</label></div>
                <div class="radio-item"><input type="radio" name="utilisation" value="Assez" id="util4"><label for="util4">Assez</label></div>
                <div class="radio-item"><input type="radio" name="utilisation" value="Tout √† fait" id="util5"><label for="util5">Tout √† fait</label></div>
              </div>
            </div>

            <!-- Question 5 : Dur√©e -->
            <div class="form-group">
              <label>Concernant la dur√©e de la formation : *</label>
              <div class="radio-group">
                <div class="radio-item"><input type="radio" name="duree" value="Trop courte" id="duree1"><label for="duree1">Trop courte</label></div>
                <div class="radio-item"><input type="radio" name="duree" value="Adapt√©e" id="duree2"><label for="duree2">Adapt√©e</label></div>
                <div class="radio-item"><input type="radio" name="duree" value="Trop longue" id="duree3"><label for="duree3">Trop longue</label></div>
              </div>
            </div>

            <!-- Question 6 : Suggestions -->
            <div class="form-group">
              <label>Quelles sont vos suggestions pour am√©liorer cette formation ?</label>
              <textarea id="suggestions" rows="3" placeholder="Vos suggestions..." maxlength="100"></textarea>
              <small id="charCountSuggestions">0/100 caract√®res</small>
            </div>

            <!-- Question 7 : Commentaire final -->
            <div class="form-group">
              <label>Un dernier commentaire ?</label>
              <textarea id="commentaireFinal" rows="3" placeholder="Votre commentaire..." maxlength="100"></textarea>
              <small id="charCountCommentaire">0/100 caract√®res</small>
            </div>

            <button type="submit" class="btn">üì§ Envoyer mon √©valuation</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Version -->
    <div class="version-info">
      <div class="version-number">Formation Manager v3.3.32</div>
      <div class="version-date">Mis √† jour le 18 novembre 2025</div>
      <div class="copyright">
        ¬© 2025 WeN√©goce - Solution de gestion des formations et √©valuations<br>
        D√©velopp√© avec ‚ù§Ô∏è pour simplifier le suivi des formations
      </div>
    </div>
  </div>

  <!-- Modale email -->
  <div id="emailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úèÔ∏è Personnaliser l'email</h3>
        <button class="btn-icon" onclick="closeEmailModal()">‚úñ</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Objet de l'email</label>
          <input type="text" id="emailSubjectEdit" placeholder="Objet de l'email">
        </div>
        <div class="form-group">
          <label>Corps de l'email</label>
          <textarea id="emailBodyEdit" rows="10" placeholder="Corps de l'email"></textarea>
          <small>Astuce: Utilisez [LIEN] dans le texte pour ins√©rer automatiquement le lien personnalis√© du stagiaire.</small>
        </div>
        <div style="text-align:right;margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btn-secondary" onclick="closeEmailModal()">Annuler</button>
          <button class="btn" onclick="saveEmailChanges()">üíæ Sauvegarder</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modale Relance -->
  <div id="reminderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üìß Envoyer une relance</h3>
        <button class="btn-icon" onclick="closeReminderModal()">‚úñ</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Objet de la relance</label>
          <input type="text" id="reminderSubject" placeholder="Ex: Rappel - √âvaluation de formation en attente">
        </div>
        <div class="form-group">
          <label>Message de relance</label>
          <textarea id="reminderBody" rows="8" placeholder="Votre message de relance..."></textarea>
          <small>Note: Le lien personnalis√© sera automatiquement ins√©r√© √† la fin du message.</small>
        </div>
        <div class="alert alert-info" style="margin-top:10px">‚ÑπÔ∏è <strong>Note :</strong> Le lien personnalis√© sera automatiquement ins√©r√© √† la place de [LIEN]</div>
        <div style="text-align:right;margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btn-secondary" onclick="closeReminderModal()">Annuler</button>
          <button class="btn" onclick="sendReminder()">üìß Envoyer la relance</button>
        </div>
      </div>
    </div>
  </div>

  <!-- XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Helpers g√©n√©riques -->
  <script>
    function toDateISOFromInput(d){
      if(!d) return null; try{
        if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d+"T00:00:00Z";
        if(/^\d{2}\/\d{2}\/\d{4}$/.test(d)){const [dd,mm,yyyy]=d.split('/');return `${yyyy}-${mm}-${dd}T00:00:00Z`;}
      }catch(e){}
      return null;
    }
  </script>

  <!-- ============================= -->
  <!--   MSAL AUTHENTICATION V3.2    -->
  <!-- ============================= -->
  <script>
  // Configuration MSAL
  const msalConfig = {
    auth: {
      clientId: 'e270fde7-2324-487e-8cb4-c249dbafa968',
      authority: 'https://login.microsoftonline.com/bc9934d3-8db6-47e6-a844-a32a407400c2',
      redirectUri: window.location.origin + window.location.pathname
    },
    cache: {
      cacheLocation: 'localStorage',
      storeAuthStateInCookie: false
    }
  };

  const loginRequest = {
    scopes: ['User.Read']
  };

  // R√¥les d'application autoris√©s (insensible √† la casse)
  const GROUPS = {
    TRAINER: 'FM.trainer',
    ADMIN: 'FM.Admin'
  };

  let msalInstance;
  let currentUser = null;

  // Initialisation MSAL
  async function initMSAL() {
    try {
      // Attendre que MSAL soit charg√©
      await window.__msalReady;
      
      msalInstance = new msal.PublicClientApplication(msalConfig);
      await msalInstance.initialize();
      
      // G√©rer le retour de redirection
      try {
        const response = await msalInstance.handleRedirectPromise();
        if (response && response.account) {
          console.log('Connexion r√©ussie via redirection');
          currentUser = response.account;
          msalInstance.setActiveAccount(currentUser);
          await checkUserAccess();
        } else {
          // V√©rifier si un utilisateur est d√©j√† connect√© (session existante)
          const accounts = msalInstance.getAllAccounts();
          if (accounts.length > 0) {
            console.log('Session existante trouv√©e');
            currentUser = accounts[0];
            msalInstance.setActiveAccount(currentUser);
          }
        }
      } catch (redirectError) {
        console.error('Erreur lors de la gestion de la redirection:', redirectError);
      }
      
      updateAuthUI();
    } catch (error) {
      console.error('Erreur initialisation MSAL:', error);
      hideLoading();
    }
  }

  // V√©rifier l'acc√®s utilisateur via les r√¥les d'application
  async function checkUserAccess() {
    if (!currentUser) {
      console.log('checkUserAccess: Pas d\'utilisateur connect√©');
      return false;
    }
    
    console.log('checkUserAccess: V√©rification pour', currentUser.username);
    
    try {
      // R√©cup√©rer les r√¥les depuis le token ID
      const roles = currentUser.idTokenClaims?.roles || [];
      
      console.log('R√¥les trouv√©s:', roles);
      
      // V√©rification insensible √† la casse
      const hasAccess = roles.some(role => {
        if (!role) return false;
        const roleLower = role.toLowerCase();
        return roleLower === 'fm.trainer' || roleLower === 'fm.admin';
      });
      
      console.log('Acc√®s autoris√©:', hasAccess);
      
      if (!hasAccess) {
        showAccessDenied();
        return false;
      }

      // Stocker le r√¥le admin
      currentUser.isAdmin = roles.some(role => {
        if (!role) return false;
        return role.toLowerCase() === 'fm.admin';
      });
      
      console.log('Est admin:', currentUser.isAdmin);
      return true;
      
    } catch (error) {
      console.error('Erreur v√©rification acc√®s:', error);
      return false;
    }
  }

  // Connexion
  async function login() {
    try {
      console.log('Tentative de connexion...');
      showLoading();
      
      await msalInstance.loginRedirect(loginRequest);
    } catch (error) {
      console.error('Erreur connexion:', error);
      hideLoading();
      alert('‚ùå Erreur lors de la connexion: ' + error.message);
    }
  }

  // D√©connexion
  async function logout() {
    try {
      showLoading();
      currentUser = null;
      await msalInstance.logoutRedirect({
        postLogoutRedirectUri: window.location.origin + window.location.pathname
      });
    } catch (error) {
      console.error('Erreur d√©connexion:', error);
      hideLoading();
    }
  }

  // Mise √† jour de l'interface d'authentification
  function updateAuthUI() {
    const authSection = document.getElementById('authSection');
    
    if (currentUser) {
      const userName = currentUser.name || currentUser.username || 'Utilisateur';
      const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
      
      authSection.innerHTML = `
        <div class="user-info">
          <div class="user-avatar">${initials}</div>
        </div>
        <button class="btn-logout" onclick="logout()">D√©connexion</button>
      `;
    } else {
      authSection.innerHTML = `
        <button class="btn-login" onclick="login()">Se connecter</button>
      `;
    }
  }

  // Message d'acc√®s refus√©
  function showAccessDenied() {
    const container = document.querySelector('.container');
    const content = container.querySelector('.content');
    if (content) content.style.display = 'none';
    
    // Masquer les onglets
    const tabs = document.querySelector('.tabs');
    if (tabs) tabs.style.display = 'none';
    
    const message = document.createElement('div');
    message.style.cssText = 'text-align:center;padding:60px 20px;background:var(--card);border-radius:var(--radius);margin-top:24px;box-shadow:var(--shadow)';
    message.innerHTML = `
      <div style="font-size:64px;margin-bottom:20px">üö´</div>
      <h2 style="color:var(--danger);margin-bottom:12px">Acc√®s refus√©</h2>
      <p style="color:var(--muted);margin-bottom:24px">
        Votre compte n'a pas les autorisations n√©cessaires pour acc√©der √† Formation Manager.<br>
        Veuillez contacter votre administrateur pour obtenir l'acc√®s.
      </p>
      <button class="btn" onclick="logout()">Se d√©connecter</button>
    `;
    container.appendChild(message);
    
    // D√©placer le bloc version apr√®s le message d'acc√®s refus√©
    const versionInfo = document.querySelector('.version-info');
    if (versionInfo) {
      container.appendChild(versionInfo);
    }
  }

  // Fonction pour pr√©-remplir le nom du formateur avec l'utilisateur connect√©
  function prefillFormateurName() {
    if (currentUser) {
      const formateurInput = document.getElementById('nomFormateur');
      if (formateurInput && !formateurInput.value) {
        const userName = currentUser.name || currentUser.username || '';
        if (userName) {
          formateurInput.value = userName;
          formateurInput.classList.add('valid');
        }
      }
    }
  }

  </script>

  <!-- APP LOGIC V3.3 -->
  <script>
  let stagiaireCount=0; const MAX_STAGIAIRES=50;
  const BASE_LINK='https://back.wenegoce.fr/api/formation-manager';
  const WEBHOOK_AZURE_CREATE='https://prod-01.francecentral.logic.azure.com:443/workflows/2ed0a1ded8c04bdb919956463f324d76/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=xdDuSi6kyJazxW0euPSUkEowfVgIrgxfAQ6a6Ogejg0';
  const WEBHOOK_GET_STAGIAIRE='https://prod-07.francecentral.logic.azure.com:443/workflows/d7804bad29a449098fb480041298d62c/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=8cWaq9BKOuc-UQvo6RliDdU6kdmHfTrPGClxtmQAZHI';
  const WEBHOOK_AZURE_SATISFACTION='https://prod-20.francecentral.logic.azure.com:443/workflows/bad15f005ef64adab56e14fd436b8a1f/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=6iHn4hVguX6pLJFyTTvbq4ujoMwF0dnCgRfy7k7hiKA';
  const WEBHOOK_AZURE_UPDATE_PRESENCE='https://prod-02.francecentral.logic.azure.com:443/workflows/a108ca6c917a4197ba14e2674ff31b44/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=zOjl38vl1AXhyV25ZGW_01wVLwXZwftceAYxyk8gjro';
  const SHAREPOINT_LIST_URL='https://wenegoce.sharepoint.com/sites/FormationManager/Lists/Formations/AllItems.aspx';
  let emailSubjectGlobal="Votre formation chez WeN√©goce - Confirmation de pr√©sence";
  let emailBodyGlobal="Bonjour,\n\nNous vous remercions d'avoir particip√© √† la formation [Theme] du [Date].\n\nEn cliquant sur le lien ci-apr√®s vous acc√®derez :\n* √† une attestation de pr√©sence,\n* √† une enqu√™te de satisfaction tr√®s rapide.\n\n[LIEN]\n\nVotre avis compte pour nous et nous vous remercions de votre participation.\n\nCordialement,\n\nL'√©quipe WeN√©goce";

  function showLoading(){document.getElementById('loadingScreen').classList.add('active')}
  function hideLoading(){document.getElementById('loadingScreen').classList.remove('active')}

  // Fonction requiresAuth : retourne true si l'authentification est n√©cessaire
  function requiresAuth() {
    const params = new URLSearchParams(window.location.search);
    const fid = params.get('fid');
    const sid = params.get('sid');
    
    // Si fid et sid existent, l'utilisateur acc√®de √† l'onglet stagiaire ‚Üí pas besoin d'auth
    if (fid && sid) {
      return false;
    }
    
    // Sinon, l'authentification est requise
    return true;
  }

  // Au chargement
  document.addEventListener('DOMContentLoaded', async function(){
    showLoading();
    
    // Initialiser MSAL
    await initMSAL();
    
    // V√©rifier si l'authentification est requise
    if (requiresAuth()) {
      // Si pas d'utilisateur connect√©, demander la connexion
      if (!currentUser) {
        hideLoading();
        
        // Masquer le contenu principal
        const content = document.querySelector('.content');
        if (content) content.style.display = 'none';
        
        // Masquer les onglets
        const tabs = document.querySelector('.tabs');
        if (tabs) tabs.style.display = 'none';
        
        // Afficher message de connexion
        const container = document.querySelector('.container');
        const message = document.createElement('div');
        message.style.cssText = 'text-align:center;padding:60px 20px;background:var(--card);border-radius:var(--radius);margin-top:24px;box-shadow:var(--shadow)';
        message.innerHTML = `
          <div style="font-size:64px;margin-bottom:20px">üîê</div>
          <h2 style="color:var(--brand);margin-bottom:12px">Authentification requise</h2>
          <p style="color:var(--muted);margin-bottom:24px">
            Veuillez vous connecter avec votre compte Microsoft 365 pour acc√©der √† l'application.
          </p>
          <button class="btn" onclick="login()" style="font-size:16px;padding:14px 28px">Se connecter</button>
        `;
        container.appendChild(message);
        
        // D√©placer le bloc version apr√®s le message d'authentification
        const versionInfo = document.querySelector('.version-info');
        if (versionInfo) {
          container.appendChild(versionInfo);
        }
        
        return;
      }
      
      // L'utilisateur est connect√©, v√©rifier les droits d'acc√®s
      const hasAccess = await checkUserAccess();
      if (!hasAccess) {
        hideLoading();
        return;
      }
    }
    
    // Initialiser l'application
    loadFormations(); 
    addStagiaire(); // Ajouter le premier stagiaire automatiquement
    initStarRatings(); 
    initCharCounters(); 
    checkURLParams(); 
    initEventListeners(); 
    initTypeFormationToggle(); 
    setTodayDate();
    prefillFormateurName(); // Pr√©-remplir le formateur
    
    hideLoading();
  });

  // ===== UI helpers =====
  function setTodayDate(){
    const el=document.getElementById('dateFormation'); 
    if(el && !el.value){
      const d=new Date(),
      y=d.getFullYear(),
      m=String(d.getMonth()+1).padStart(2,'0'),
      da=String(d.getDate()).padStart(2,'0'); 
      el.value=`${y}-${m}-${da}`;
      // Valider imm√©diatement
      validateDateFormation();
    }
  }

  function switchTab(name){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); 
    const t=document.querySelector(`.tab[data-tab="${name}"]`),c=document.getElementById(name); 
    if(t)t.classList.add('active'); 
    if(c)c.classList.add('active'); 
    
    if(name==='formations') {
      loadFormationsTab();
    } else if(name==='nouveau') {
      prefillFormateurName();
    }
  }

  function resetForm() {
    // Afficher le formulaire et masquer la section de validation
    document.getElementById('formSection').style.display = 'block';
    document.getElementById('validationPresenceSection').style.display = 'none';
    formationEnCours = null;
    
    // R√©initialiser le formulaire
    document.getElementById('formateurForm').reset();
    
    // Vider la liste des stagiaires
    document.getElementById('stagiairesList').innerHTML = '';
    stagiaireCount = 0;
    
    // Ajouter un stagiaire vide
    addStagiaire();
    
    // R√©initialiser la date et le formateur
    setTodayDate();
    prefillFormateurName();
    
    // Retourner √† l'onglet "nouveau"
    switchTab('nouveau');
  }

  function initEventListeners(){
    document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click',function(){switchTab(this.getAttribute('data-tab'));}));
    const btnAdd=document.getElementById('btnAddStagiaire'); 
    if(btnAdd) btnAdd.addEventListener('click',e=>{e.preventDefault(); addStagiaire();});
    const formateurForm=document.getElementById('formateurForm'); 
    if(formateurForm) formateurForm.addEventListener('submit',e=>{e.preventDefault(); handleFormateurSubmit();});
    
    // Validation en temps r√©el pour tous les champs obligatoires
    ['raisonSociale','theme','nomFormateur','dateFormation','heureDebut','heureFin'].forEach(id=>{
      const f=document.getElementById(id); 
      if(!f) return; 
      f.addEventListener('blur',()=>validateRequiredField(f)); 
      f.addEventListener('input',()=>{
        if(f.value.trim()) {
          validateRequiredField(f);
        } else {
          clearError(f);
        }
      });
    });
    
    const hd=document.getElementById('heureDebut'), hf=document.getElementById('heureFin'); 
    if(hd) hd.addEventListener('change',validateHeures); 
    if(hf){
      hf.addEventListener('change',validateHeures); 
      hf.addEventListener('blur',validateHeures);
    } 
    
    const df=document.getElementById('dateFormation'); 
    if(df) df.addEventListener('change',validateDateFormation);
    
    const presenceForm=document.getElementById('presenceForm'); 
    if(presenceForm) presenceForm.addEventListener('submit',e=>{e.preventDefault(); handlePresenceSubmit();});
    
    const satisfactionForm=document.getElementById('satisfactionForm'); 
    if(satisfactionForm) satisfactionForm.addEventListener('submit',e=>{e.preventDefault(); handleSatisfactionSubmit();});
    
    const jira=document.getElementById('referenceJira'); 
    if(jira) jira.addEventListener('blur',function(){
      if(this.value.trim()) validateJiraReference(this);
    });
  }

  // ===== Validations am√©lior√©es =====
  function showError(input,msg){
    input.classList.remove('valid');
    input.classList.add('invalid');
    const ex=input.parentElement.querySelector('.error-message'); 
    if(ex) ex.remove(); 
    const s=document.createElement('small'); 
    s.className='error-message'; 
    s.textContent=msg; 
    input.parentElement.appendChild(s);
  }

  function clearError(input){
    const ex=input.parentElement.querySelector('.error-message'); 
    if(ex) ex.remove(); 
    input.classList.remove('valid');
    input.classList.remove('invalid');
  }

  function validateRequiredField(input){ 
    if(!input.value.trim()) {
      showError(input,'Ce champ est obligatoire');
      return false;
    } else {
      clearError(input); 
      input.classList.add('valid');
      return true;
    }
  }

  function validateEmail(input){
    const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; 
    if(input.value.trim() && !re.test(input.value)) {
      showError(input,'Format email invalide');
      return false;
    } else if(input.value.trim()){
      clearError(input); 
      input.classList.add('valid');
      return true;
    }
    return true;
  }

  function validateJiraReference(input){
    const r=/^(TIC|SMC|SNC)-\d+$/i; 
    if(input.value.trim() && !r.test(input.value)) {
      showError(input,'Format JIRA invalide (ex: TIC-123)');
      return false;
    } else if(input.value.trim()){
      clearError(input); 
      input.classList.add('valid');
      return true;
    }
    return true;
  }

  function validateDateFormation(){
    const el=document.getElementById('dateFormation'); 
    const d=new Date(el.value), today=new Date(); 
    today.setHours(0,0,0,0); 
    const min=new Date(); 
    min.setDate(today.getDate()-7); 
    
    if(d<min){
      showError(el,'La date ne peut pas √™tre ant√©rieure √† plus de 7 jours');
      return false;
    } else {
      clearError(el); 
      el.classList.add('valid');
      return true;
    }
  }

  function validateHeures(){
    const hd=document.getElementById('heureDebut'), hf=document.getElementById('heureFin'); 
    if(hd.value && hf.value){
      const [a,b]=hd.value.split(':').map(Number), [c,d]=hf.value.split(':').map(Number); 
      if((c*60+d) <= (a*60+b)) {
        showError(hf,"L'heure de fin doit √™tre apr√®s l'heure de d√©but");
        return false;
      } else {
        clearError(hf); 
        hf.classList.add('valid');
        hd.classList.add('valid');
        return true;
      }
    }
    return true;
  }

  function initTypeFormationToggle(){
    const t=document.getElementById('typeFormationToggle'), 
    lp=document.getElementById('labelPresentiel'), 
    lv=document.getElementById('labelVisio'); 
    if(!t) return; 
    t.addEventListener('change',function(){ 
      if(this.checked){
        lp.classList.remove('active'); 
        lv.classList.add('active');
      } else {
        lp.classList.add('active'); 
        lv.classList.remove('active');
      }
    })
  }

  // ===== Gestion stagiaires =====
  function addStagiaire(){ 
    if(stagiaireCount>=MAX_STAGIAIRES){
      alert('‚ö†Ô∏è Maximum de '+MAX_STAGIAIRES+' stagiaires atteint'); 
      return;
    } 
    stagiaireCount++; 
    const c=document.getElementById('stagiairesList'); 
    const d=document.createElement('div'); 
    d.className='stagiaire-item'; 
    d.id='stagiaire-'+stagiaireCount; 
    d.innerHTML=`
    <div class="stagiaire-header">
      <span class="stagiaire-number">Stagiaire ${stagiaireCount}</span>
      <button type="button" class="btn-remove" onclick="removeStagiaire(${stagiaireCount})">üóëÔ∏è Supprimer</button>
    </div>
    <div class="row">
      <div class="form-group">
        <label>Nom complet *</label>
        <input type="text" id="nomStagiaire${stagiaireCount}" required>
      </div>
      <div class="form-group">
        <label>Email *</label>
        <input type="email" id="emailStagiaire${stagiaireCount}" required>
      </div>
    </div>`; 
    c.appendChild(d);
    
    // Ajouter les validations sur les nouveaux champs
    const nomInput=document.getElementById('nomStagiaire'+stagiaireCount);
    if(nomInput){
      nomInput.addEventListener('blur',function(){validateRequiredField(this)}); 
      nomInput.addEventListener('input',function(){
        if(this.value.trim()) validateRequiredField(this);
      });
    }
    
    const emailInput=document.getElementById('emailStagiaire'+stagiaireCount); 
    if(emailInput){
      emailInput.addEventListener('blur',function(){validateEmail(this)}); 
      emailInput.addEventListener('input',function(){
        if(this.value.trim()) validateEmail(this);
      });
    }
  }

  function removeStagiaire(id){
    const it=document.getElementById('stagiaire-'+id); 
    if(it){
      it.remove(); 
      stagiaireCount--;
    }
  }

  // ===== Submit formation -> Azure =====
  async function handleFormateurSubmit(){
    // Valider tous les champs obligatoires
    const raisonSociale=document.getElementById('raisonSociale');
    const theme=document.getElementById('theme');
    const nomFormateur=document.getElementById('nomFormateur');
    const dateFormation=document.getElementById('dateFormation');
    const heureDebut=document.getElementById('heureDebut');
    const heureFin=document.getElementById('heureFin');
    
    let isValid = true;
    
    // Validation des champs principaux
    if(!validateRequiredField(raisonSociale)) isValid = false;
    if(!validateRequiredField(theme)) isValid = false;
    if(!validateRequiredField(nomFormateur)) isValid = false;
    if(!validateRequiredField(dateFormation)) isValid = false;
    if(!validateDateFormation()) isValid = false;
    if(!validateRequiredField(heureDebut)) isValid = false;
    if(!validateRequiredField(heureFin)) isValid = false;
    if(!validateHeures()) isValid = false;
    
    // Validation de la r√©f√©rence JIRA si remplie
    const referenceJira=document.getElementById('referenceJira');
    if(referenceJira.value.trim() && !validateJiraReference(referenceJira)) isValid = false;
    
    // Validation des stagiaires
    const stagiaires=[];
    for(let i=1; i<=stagiaireCount; i++){
      const nomSt=document.getElementById('nomStagiaire'+i);
      const emailSt=document.getElementById('emailStagiaire'+i);
      
      if(nomSt && emailSt){
        if(!validateRequiredField(nomSt)) isValid = false;
        if(!validateEmail(emailSt)) isValid = false;
        
        if(nomSt.value.trim() && emailSt.value.trim()){
          stagiaires.push({
            id: 'ST-' + Date.now() + '-' + i,
            nom: nomSt.value.trim(),
            email: emailSt.value.trim()
          });
        }
      }
    }
    
    if(!isValid){
      alert('‚ö†Ô∏è Veuillez corriger les erreurs dans le formulaire avant de continuer.');
      return;
    }
    
    if(stagiaires.length === 0){
      alert('‚ö†Ô∏è Veuillez ajouter au moins un stagiaire.');
      return;
    }
    
    const typeFormation=document.getElementById('typeFormationToggle').checked ? 'Visio':'Pr√©sentiel';

    const payload={
      FormationID: 'FM-' + Date.now(),
      Client: raisonSociale.value.trim(),
      Theme: theme.value.trim(),
      ReferenceJIRA: referenceJira.value.trim(),
      Formateur: nomFormateur.value.trim(),
      Date: toDateISOFromInput(dateFormation.value),
      TypeFormation: typeFormation,
      HeureDebut: heureDebut.value,
      HeureFin: heureFin.value,
      Statut: 'Planifi√©e',
      Stagiaires: JSON.stringify(stagiaires.map(s=>({
        StagiaireID: s.id,
        Nom: s.nom,
        Email: s.email,
        Presence: '',
        Commentaire: '',
        Satisfaction: null
      })))
    };

    showLoading();
    try{
      const res = await fetch(WEBHOOK_AZURE_CREATE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if(!res.ok){
        const txt = await res.text();
        throw new Error('Erreur Azure: ' + res.status + ' - ' + txt);
      }
      
      // Afficher la page de validation des pr√©sences
      afficherValidationPresences(payload);
      
    } catch(err){
      console.error(err);
      alert('‚ùå Erreur lors de l\'enregistrement: ' + err.message);
    } finally {
      hideLoading();
    }
  }

  // ===== Chargement formations depuis SharePoint =====
  let formationsCacheSP = [];
  
  async function loadFormations() {
    try {
      // Pour l'instant, on utilise un tableau vide car on n'a pas d'acc√®s direct √† SharePoint
      formationsCacheSP = [];
    } catch(err) {
      console.error('Erreur chargement formations:', err);
    }
  }

  function loadFormationsTab() {
    const list = document.getElementById('formationsList');
    
    if(formationsCacheSP.length === 0) {
      list.innerHTML = `
        <div class="alert alert-info">
          <p style="margin:0">üìã Aucune formation enregistr√©e pour le moment.</p>
          <p style="margin:8px 0 0 0;font-size:13px">
            Les formations que vous cr√©ez appara√Ætront automatiquement dans SharePoint: 
            <a href="${SHAREPOINT_LIST_URL}" target="_blank" style="color:var(--brand)">
              Ouvrir SharePoint
            </a>
          </p>
        </div>`;
      return;
    }
    
    // Afficher les formations
    let html = '';
    formationsCacheSP.forEach(f => {
      const dateStr = new Date(f.date).toLocaleDateString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      html += `
        <div class="formation-card">
          <div style="padding:16px">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
              <div>
                <h3 style="margin:0 0 6px 0;color:var(--brand)">${f.theme}</h3>
                <div style="color:var(--muted);font-size:14px">${f.raisonSociale}</div>
              </div>
              <span style="background:var(--brand-50);color:var(--brand);padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600">${f.type}</span>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:12px;font-size:13px">
              <div><strong>üìÖ Date:</strong> ${dateStr}</div>
              <div><strong>üïê Horaires:</strong> ${f.heureDebut} - ${f.heureFin}</div>
              <div><strong>üë®‚Äçüè´ Formateur:</strong> ${f.nomFormateur}</div>
              <div><strong>üë• Stagiaires:</strong> ${f.stagiaires.length}</div>
            </div>
          </div>
        </div>`;
    });
    
    list.innerHTML = html;
  }

  // ===== Satisfaction =====
  function initStarRatings() {
    // G√©rer les 3 groupes d'√©toiles s√©par√©ment
    const starGroups = ['attentes', 'objectifs', 'formateur'];
    
    starGroups.forEach(groupName => {
      const container = document.getElementById('stars' + groupName.charAt(0).toUpperCase() + groupName.slice(1));
      const noteInput = document.getElementById('note' + groupName.charAt(0).toUpperCase() + groupName.slice(1));
      
      if (!container || !noteInput) return;
      
      const stars = container.querySelectorAll('.star[data-group="' + groupName + '"]');
      
      stars.forEach(star => {
        star.addEventListener('click', function() {
          const value = this.getAttribute('data-value');
          noteInput.value = value;
          updateStarsGroup(groupName, value);
        });
        
        star.addEventListener('mouseenter', function() {
          const value = this.getAttribute('data-value');
          updateStarsGroup(groupName, value);
        });
      });
      
      container.addEventListener('mouseleave', function() {
        const currentValue = noteInput.value;
        updateStarsGroup(groupName, currentValue);
      });
    });
  }

  function updateStarsGroup(groupName, value) {
    const stars = document.querySelectorAll('.star[data-group="' + groupName + '"]');
    stars.forEach(star => {
      if (star.getAttribute('data-value') <= value) {
        star.classList.add('active');
      } else {
        star.classList.remove('active');
      }
    });
  }

  function initCharCounters() {
    const suggestions = document.getElementById('suggestions');
    const commentaireFinal = document.getElementById('commentaireFinal');
    
    if(suggestions) {
      suggestions.addEventListener('input', function() {
        document.getElementById('charCountSuggestions').textContent = 
          this.value.length + '/100 caract√®res';
      });
    }
    
    if(commentaireFinal) {
      commentaireFinal.addEventListener('input', function() {
        document.getElementById('charCountCommentaire').textContent = 
          this.value.length + '/100 caract√®res';
      });
    }
  }

  async function handleSatisfactionSubmit() {
    // R√©cup√©rer toutes les valeurs du formulaire
    const noteAttentes = document.getElementById('noteAttentes').value;
    const noteObjectifs = document.getElementById('noteObjectifs').value;
    const noteFormateur = document.getElementById('noteFormateur').value;
    const utilisation = document.querySelector('input[name="utilisation"]:checked');
    const duree = document.querySelector('input[name="duree"]:checked');
    const suggestions = document.getElementById('suggestions').value.trim();
    const commentaireFinal = document.getElementById('commentaireFinal').value.trim();
    
    // Validations
    if(!noteAttentes) {
      alert('‚ö†Ô∏è Veuillez √©valuer si la formation a r√©pondu √† vos attentes.');
      return;
    }
    
    if(!noteObjectifs) {
      alert('‚ö†Ô∏è Veuillez √©valuer si les objectifs √©taient clairs.');
      return;
    }
    
    if(!noteFormateur) {
      alert('‚ö†Ô∏è Veuillez √©valuer la qualit√© du formateur.');
      return;
    }
    
    if(!utilisation) {
      alert('‚ö†Ô∏è Veuillez indiquer votre niveau d\'aisance avec le logiciel.');
      return;
    }
    
    if(!duree) {
      alert('‚ö†Ô∏è Veuillez indiquer votre avis sur la dur√©e de la formation.');
      return;
    }
    
    const params = new URLSearchParams(window.location.search);
    const fid = params.get('fid');
    const sid = params.get('sid');
    
    // Convertir "utilisation" en nombre (1-5)
    // "Pas du tout" = 1, "Un peu" = 2, "Moyennement" = 3, "Assez" = 4, "Tout √† fait" = 5
    const utilisationMap = {
      "Pas du tout": 1,
      "Un peu": 2,
      "Moyennement": 3,
      "Assez": 4,
      "Tout √† fait": 5
    };
    const q4Value = utilisationMap[utilisation.value] || 3;
    
    // Convertir "duree" en nombre (1-3)
    // "Trop courte" = 1, "Adapt√©e" = 2, "Trop longue" = 3
    const dureeMap = {
      "Trop courte": 1,
      "Adapt√©e": 2,
      "Trop longue": 3
    };
    const q5Value = dureeMap[duree.value] || 2;
    
    // R√©cup√©rer le nom du stagiaire (stock√© globalement lors du chargement)
    const nomStagiaire = window.currentStagiaireNom || "Stagiaire";
    
    const payload = {
      FormationID: fid,
      StagiaireID: sid,
      NomStagiaire: nomStagiaire,
      Q1: parseInt(noteAttentes),
      Q2: parseInt(noteObjectifs),
      Q3: parseInt(noteFormateur),
      Q4: q4Value,
      Q5: q5Value,
      Suggestions: suggestions,
      CommentairesStagiaire: commentaireFinal
    };
    
    console.log('Payload satisfaction:', payload);
    
    showLoading();
    try {
      const res = await fetch(WEBHOOK_AZURE_SATISFACTION, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if(!res.ok) {
        const errorText = await res.text();
        throw new Error('Erreur lors de l\'envoi: ' + errorText);
      }
      
      // Calculer la moyenne des notes pour l'affichage
      const noteMoyenne = Math.round((parseInt(noteAttentes) + parseInt(noteObjectifs) + parseInt(noteFormateur)) / 3);
      displayThankYouMessage(noteMoyenne, 'Merci pour votre retour !');
    } catch(err) {
      console.error(err);
      alert('‚ùå Erreur lors de l\'envoi: ' + err.message);
    } finally {
      hideLoading();
    }
  }

  function displayThankYouMessage(note, message) {
    const emoji = note >= 4 ? 'üéâ' : note >= 3 ? 'üòä' : 'üí≠';
    
    // Afficher le message de remerciement apr√®s l'attestation
    const thankYouHTML = `
      <div class="alert alert-success" style="margin-top:16px;text-align:center">
        <div style="font-size:48px;margin-bottom:10px">${emoji}</div>
        <h3 style="color:var(--success);margin:0 0 8px 0">${message}</h3>
        <p style="margin:0">Votre √©valuation a bien √©t√© enregistr√©e. Merci pour votre participation √† cette formation.</p>
      </div>`;
    
    // Ajouter le message apr√®s l'attestation
    document.getElementById('attestationPresence').innerHTML += thankYouHTML;
    
    // Masquer le formulaire de satisfaction
    const satisfactionCard = document.getElementById('satisfactionForm').closest('.card');
    if (satisfactionCard) {
      satisfactionCard.style.display = 'none';
    }
  }

  // ===== Pr√©sence =====
  async function handlePresenceSubmit() {
    const presence = document.querySelector('input[name="presence"]:checked');
    const commentaire = document.getElementById('commentaireFormateur').value.trim();
    
    if(!presence) {
      alert('‚ö†Ô∏è Veuillez s√©lectionner un statut de pr√©sence.');
      return;
    }
    
    const params = new URLSearchParams(window.location.search);
    const fid = params.get('fid');
    const sid = params.get('sid');
    
    const payload = {
      FormationID: fid,
      StagiaireID: sid,
      Presence: presence.value,
      Commentaire: commentaire
    };
    
    showLoading();
    try {
      const res = await fetch(WEBHOOK_AZURE_UPDATE_PRESENCE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if(!res.ok) throw new Error('Erreur lors de la mise √† jour');
      
      alert('‚úÖ Pr√©sence enregistr√©e avec succ√®s !');
      window.location.reload();
    } catch(err) {
      console.error(err);
      alert('‚ùå Erreur: ' + err.message);
    } finally {
      hideLoading();
    }
  }

  // ===== Email =====
  function saveEmailChanges() {
    emailSubjectGlobal = document.getElementById('emailSubjectEdit').value;
    emailBodyGlobal = document.getElementById('emailBodyEdit').value;
    updateEmailPreview();
    closeEmailModal();
  }

  async function sendIndividualEmail(fid, sid, email) {
    const link = `${window.location.origin}${window.location.pathname}?fid=${fid}&sid=${sid}`;
    const body = emailBodyGlobal.replace('[LIEN]', link);
    
    const payload = {
      To: email,
      Subject: emailSubjectGlobal,
      Body: body
    };
    
    showLoading();
    try {
      const res = await fetch(WEBHOOK_AZURE_SEND_EMAIL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if(!res.ok) throw new Error('Erreur envoi email');
      
      alert('‚úÖ Email envoy√© √† ' + email);
    } catch(err) {
      console.error(err);
      alert('‚ùå Erreur: ' + err.message);
    } finally {
      hideLoading();
    }
  }

  // ===== Relance =====
  let currentReminder = null;
  
  function openReminderModal(fid, sid, email) {
    currentReminder = { fid, sid, email };
    document.getElementById('reminderSubject').value = 'Rappel - √âvaluation de formation en attente';
    document.getElementById('reminderBody').value = 'Bonjour,\n\nNous n\'avons pas encore re√ßu votre √©valuation de la formation.\n\nMerci de bien vouloir y r√©pondre en cliquant sur le lien suivant :\n\n[LIEN]\n\nCordialement,\nL\'√©quipe WeN√©goce';
    document.getElementById('reminderModal').style.display = 'flex';
  }
  
  function closeReminderModal() {
    document.getElementById('reminderModal').style.display = 'none';
    currentReminder = null;
  }
  
  async function sendReminder() {
    if(!currentReminder) return;
    
    const subject = document.getElementById('reminderSubject').value;
    const body = document.getElementById('reminderBody').value;
    const link = `${window.location.origin}${window.location.pathname}?fid=${currentReminder.fid}&sid=${currentReminder.sid}`;
    const finalBody = body.replace('[LIEN]', link);
    
    const payload = {
      To: currentReminder.email,
      Subject: subject,
      Body: finalBody
    };
    
    showLoading();
    try {
      const res = await fetch(WEBHOOK_AZURE_SEND_EMAIL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if(!res.ok) throw new Error('Erreur envoi relance');
      
      alert('‚úÖ Relance envoy√©e √† ' + currentReminder.email);
      closeReminderModal();
    } catch(err) {
      console.error(err);
      alert('‚ùå Erreur: ' + err.message);
    } finally {
      hideLoading();
    }
  }

  // ===== V√©rification des param√®tres URL =====
  function checkURLParams() {
    const params = new URLSearchParams(window.location.search);
    const fid = params.get('fid');
    const sid = params.get('sid');
    
    if(fid && sid) {
      // Masquer tous les onglets sauf stagiaire
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        const tabName = tab.getAttribute('data-tab');
        if (tabName !== 'stagiaire') {
          tab.style.display = 'none';
        } else {
          tab.style.display = 'inline-block';
        }
      });
      
      // Passer √† l'onglet stagiaire
      switchTab('stagiaire');
      loadStagiaireView(fid, sid);
    }
  }

  function loadStagiaireView(fid, sid) {
    showLoading();
    
    // Appeler FM-GetStagiaire pour r√©cup√©rer les donn√©es
    fetch(WEBHOOK_GET_STAGIAIRE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        FormationID: fid,
        StagiaireID: sid
      })
    })
    .then(res => {
      if (!res.ok) throw new Error('Erreur lors du chargement des donn√©es');
      return res.json();
    })
    .then(data => {
      console.log('Donn√©es re√ßues de FM-GetStagiaire:', data);
      
      // Trouver le stagiaire dans le tableau
      let stagiaire = null;
      if (data.Stagiaires && Array.isArray(data.Stagiaires)) {
        stagiaire = data.Stagiaires.find(s => s.StagiaireID === sid || s.id === sid);
      }
      
      if (!stagiaire) {
        console.warn('Stagiaire non trouv√© dans les donn√©es, utilisation du premier');
        stagiaire = data.Stagiaires && data.Stagiaires.length > 0 ? data.Stagiaires[0] : {};
      }
      
      // Construire l'objet de donn√©es pour l'affichage
      const formationData = {
        Client: data.Client || data.RaisonSociale || "Non renseign√©",
        NomStagiaire: stagiaire.Nom || stagiaire.NomStagiaire || stagiaire.nom || "Non renseign√©",
        Theme: data.Theme || "Non renseign√©",
        Date: data.Date || "Non renseign√©e",
        HeureDebut: data.HeureDebut || "Non renseign√©e",
        HeureFin: data.HeureFin || "Non renseign√©e",
        Presence: stagiaire.Presence || stagiaire.presence || "En attente",
        CommentaireFormateur: stagiaire.Commentaire || stagiaire.CommentaireFormateur || stagiaire.commentaire || ""
      };
      
      // Afficher l'attestation de pr√©sence
      displayAttestation(formationData, fid, sid);
      hideLoading();
    })
    .catch(err => {
      console.error('Erreur chargement formation:', err);
      document.getElementById('attestationPresence').innerHTML = `
        <div class="alert alert-warning">
          ‚ö†Ô∏è Erreur lors du chargement des donn√©es. Veuillez r√©essayer plus tard.
          <br><small>D√©tail: ${err.message}</small>
        </div>`;
      hideLoading();
    });
  }
  
  function displayAttestation(data, fid, sid) {
    // Formater la date si elle existe
    let dateFormatted = data.Date;
    if (data.Date && data.Date !== "Chargement...") {
      try {
        const dateObj = new Date(data.Date);
        dateFormatted = dateObj.toLocaleDateString('fr-FR', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      } catch(e) {
        dateFormatted = data.Date;
      }
    }
    
    // D√©terminer l'emoji de pr√©sence
    let presenceEmoji = "‚è≥";
    let presenceColor = "#6b7280";
    if (data.Presence === "Present") {
      presenceEmoji = "‚úÖ";
      presenceColor = "var(--success)";
    } else if (data.Presence === "Partielle") {
      presenceEmoji = "‚è±Ô∏è";
      presenceColor = "var(--warning)";
    } else if (data.Presence === "Absent") {
      presenceEmoji = "‚ùå";
      presenceColor = "var(--danger)";
    }
    
    document.getElementById('attestationPresence').innerHTML = `
      <div class="info-row">
        <div class="info-label">Client :</div>
        <div><strong>${data.Client || "Non renseign√©"}</strong></div>
      </div>
      <div class="info-row">
        <div class="info-label">Nom du stagiaire :</div>
        <div><strong>${data.NomStagiaire || "Non renseign√©"}</strong></div>
      </div>
      <div class="info-row">
        <div class="info-label">Th√®me de la formation :</div>
        <div><strong>${data.Theme || "Non renseign√©"}</strong></div>
      </div>
      <div class="info-row">
        <div class="info-label">Date de la formation :</div>
        <div>${dateFormatted || "Non renseign√©e"}</div>
      </div>
      <div class="info-row">
        <div class="info-label">Heure de d√©but :</div>
        <div>${data.HeureDebut || "Non renseign√©e"}</div>
      </div>
      <div class="info-row">
        <div class="info-label">Heure de fin :</div>
        <div>${data.HeureFin || "Non renseign√©e"}</div>
      </div>
      <div class="info-row">
        <div class="info-label">Pr√©sence :</div>
        <div style="color:${presenceColor};font-weight:bold">${presenceEmoji} ${data.Presence || "En attente"}</div>
      </div>
      ${data.CommentaireFormateur ? `
      <div class="info-row">
        <div class="info-label">Commentaire formateur :</div>
        <div style="font-style:italic">${data.CommentaireFormateur}</div>
      </div>
      ` : ''}
      <div style="margin-top:16px;padding:12px;background:var(--brand-50);border-radius:8px;font-size:13px">
        <strong>‚ÑπÔ∏è Note :</strong> Cette attestation de pr√©sence est g√©n√©r√©e automatiquement suite √† votre participation √† la formation. 
        Les informations de pr√©sence ont √©t√© valid√©es par le formateur.
      </div>
    `;
    
    // Sauvegarder les IDs et le nom pour l'envoi du formulaire de satisfaction
    window.currentFormationID = fid;
    window.currentStagiaireID = sid;
    window.currentStagiaireNom = data.NomStagiaire || "Stagiaire";
  }

  // ===== CORRECTION : Fonction transformAzureFormation avec fermeture correcte =====
  function transformAzureFormation(sp){
    if(!sp) return null;

    // R√©cup√©ration des stagiaires (formats vari√©s)
    let stagiaires = [];
    if(sp.Stagiaires !== undefined){
      const raw = sp.Stagiaires;
      if(typeof raw === 'string'){
        try{ stagiaires = JSON.parse(raw); }catch{ stagiaires = []; }
      } else if(Array.isArray(raw)){
        stagiaires = raw;
      } else if(raw && typeof raw === 'object'){
        stagiaires = [raw];
      }
    } else if(sp.stagiaires){
      stagiaires = sp.stagiaires;
    }

    // Normalisation de la date
    let date = sp.DateFormation || sp.Date || sp.date;
    if(date && typeof date === 'string' && date.includes('T')){
      date = date.split('T')[0];
    }

    // Normalisation du type de formation (Pr√©sentiel / Visio)
    let type = sp.TypeFormation || sp.type || '';
    if(type && typeof type === 'object'){
      if(type.Value) type = type.Value;
    } else if(typeof type === 'string' && type.trim().startsWith('{')){
      try{
        const obj = JSON.parse(type);
        if(obj.Value) type = obj.Value;
      }catch{}
    }

    // Normalisation des stagiaires (pr√©sence, commentaire, etc.)
    stagiaires = (stagiaires || []).map(s => {
      let presence = s.presence || s.Presence || s.statut || s.Statut || '';
      if(presence && typeof presence === 'object'){
        if(presence.Value) presence = presence.Value;
      } else if(typeof presence === 'string' && presence.trim().startsWith('{')){
        try{
          const obj = JSON.parse(presence);
          if(obj.Value) presence = obj.Value;
        }catch{}
      }

      if(typeof presence === 'string'){
        const pl = presence.toLowerCase();
        if(pl.startsWith('pr√©sent') || pl === 'present') presence = 'Present';
        else if(pl.startsWith('absent')) presence = 'Absent';
        else if(pl.startsWith('partiel')) presence = 'Partielle';
      }

      return {
        id: s.id || s.StagiaireID || s.stagiaireId || '',
        nom: s.nom || s.Nom || s.NomStagiaire || '',
        email: s.email || s.Email || s.mail || '',
        presence,
        commentaire: s.commentaire || s.Commentaire || s.CommentaireFormateur || '',
        satisfaction: s.satisfaction || null
      };
    });

    return {
      id: sp.FormationID || sp.id,
      raisonSociale: sp.RaisonSociale || sp.Client || sp.raisonSociale || '',
      theme: sp.Theme || sp.theme || '',
      referenceJira: sp.ReferenceJIRA || sp.ReferenceJira || sp.referenceJira || '',
      nomFormateur: sp.Formateur || sp.NomFormateur || sp.nomFormateur || '',
      date: date || '',
      type,
      heureDebut: sp.HeureDebut || sp.heureDebut || '',
      heureFin: sp.HeureFin || sp.heureFin || '',
      stagiaires
    };
  }

  // ===== Modales email =====
  function openEmailModal(){
    document.getElementById('emailSubjectEdit').value=emailSubjectGlobal; 
    document.getElementById('emailBodyEdit').value=emailBodyGlobal; 
    document.getElementById('emailModal').style.display='flex';
  }
  
  function closeEmailModal(){
    document.getElementById('emailModal').style.display='none'
  }

  // Mettre √† jour le preview du mod√®le d'email
  function updateEmailPreview() {
    const subjectPreview = document.getElementById('emailSubjectPreview');
    const bodyPreview = document.getElementById('emailBodyPreview');
    
    if (subjectPreview) {
      subjectPreview.textContent = emailSubjectGlobal;
    }
    
    if (bodyPreview && formationEnCours) {
      // Formater la date de la formation
      const dateFormation = new Date(formationEnCours.Date).toLocaleDateString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      // Remplacer [Theme], [Date] et [LIEN] dans le preview
      const previewBody = emailBodyGlobal
        .replace('[Theme]', formationEnCours.Theme)
        .replace('[Date]', dateFormation)
        .replace('[LIEN]', 'üîó Lien personnalis√© du stagiaire');
      
      bodyPreview.textContent = previewBody;
    }
  }

  // ===== Validation des pr√©sences =====
  let formationEnCours = null;

  function afficherValidationPresences(payload) {
    // Sauvegarder la formation en cours
    formationEnCours = payload;
    
    // Masquer le formulaire
    document.getElementById('formSection').style.display = 'none';
    
    // Afficher la section de validation
    document.getElementById('validationPresenceSection').style.display = 'block';
    
    // Masquer l'onglet "Cr√©er une formation"
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      const tabName = tab.getAttribute('data-tab');
      if (tabName === 'nouveau') {
        tab.style.display = 'none';
      }
    });
    
    // Afficher les infos de la formation
    const dateStr = new Date(payload.Date).toLocaleDateString('fr-FR', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    document.getElementById('formationInfoValidation').innerHTML = `
      <div class="info-row"><div class="info-label">Client :</div><div><strong>${payload.Client}</strong></div></div>
      <div class="info-row"><div class="info-label">Th√®me :</div><div><strong>${payload.Theme}</strong></div></div>
      <div class="info-row"><div class="info-label">Formateur :</div><div>${payload.Formateur}</div></div>
      <div class="info-row"><div class="info-label">Date :</div><div>${dateStr}</div></div>
      <div class="info-row"><div class="info-label">Horaires :</div><div>${payload.HeureDebut} - ${payload.HeureFin}</div></div>
      <div class="info-row"><div class="info-label">Type :</div><div>${payload.TypeFormation}</div></div>
    `;
    
    // R√©cup√©rer les stagiaires depuis le JSON stringifi√©
    const stagiaires = JSON.parse(payload.Stagiaires);
    
    // Afficher la liste des stagiaires
    let html = '';
    stagiaires.forEach((st, index) => {
      html += `
        <div class="stagiaire-item" id="validation-stagiaire-${index}">
          <div class="stagiaire-header">
            <span class="stagiaire-number">${st.Nom}</span>
            <button class="btn-edit" onclick="envoyerEmailStagiaire(${index})">üìß Envoi du mail</button>
          </div>
          <div style="margin-top:10px">
            <div style="color:var(--muted);font-size:14px;margin-bottom:8px">üìß ${st.Email}</div>
            <div class="form-group">
              <label>Pr√©sence</label>
              <div class="presence-radio-group">
                <div class="presence-item">
                  <input type="radio" name="presence-${index}" value="Present" id="present-${index}" onchange="marquerPresence(${index}, 'Present')">
                  <label for="present-${index}">‚úÖ Pr√©sent</label>
                </div>
                <div class="presence-item">
                  <input type="radio" name="presence-${index}" value="Partielle" id="partielle-${index}" onchange="marquerPresence(${index}, 'Partielle')">
                  <label for="partielle-${index}">‚è±Ô∏è Partielle</label>
                </div>
                <div class="presence-item">
                  <input type="radio" name="presence-${index}" value="Absent" id="absent-${index}" onchange="marquerPresence(${index}, 'Absent')">
                  <label for="absent-${index}">‚ùå Absent</label>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Commentaire (optionnel)</label>
              <textarea id="commentaire-${index}" rows="2" placeholder="Ex: D√©part anticip√©..." onchange="marquerCommentaire(${index})"></textarea>
            </div>
          </div>
        </div>
      `;
    });
    
    document.getElementById('stagiairePresenceList').innerHTML = html;
    
    // Mettre √† jour le preview du mod√®le d'email
    updateEmailPreview();
  }

  function marquerPresence(index, presence) {
    if (!formationEnCours) return;
    
    const stagiaires = JSON.parse(formationEnCours.Stagiaires);
    stagiaires[index].Presence = presence;
    formationEnCours.Stagiaires = JSON.stringify(stagiaires);
    
    console.log('Pr√©sence marqu√©e:', stagiaires[index].Nom, '-', presence);
  }

  function marquerCommentaire(index) {
    if (!formationEnCours) return;
    
    const commentaire = document.getElementById('commentaire-' + index).value.trim();
    const stagiaires = JSON.parse(formationEnCours.Stagiaires);
    stagiaires[index].Commentaire = commentaire;
    formationEnCours.Stagiaires = JSON.stringify(stagiaires);
    
    console.log('Commentaire ajout√© pour:', stagiaires[index].Nom);
  }

  function envoyerEmailStagiaire(index) {
    if (!formationEnCours) return;
    
    const stagiaires = JSON.parse(formationEnCours.Stagiaires);
    const stagiaire = stagiaires[index];
    
    const link = `${window.location.origin}${window.location.pathname}?fid=${formationEnCours.FormationID}&sid=${stagiaire.StagiaireID}`;
    
    // Formater la date de la formation
    const dateFormation = new Date(formationEnCours.Date).toLocaleDateString('fr-FR', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    // Remplacer [LIEN], [Theme] et [Date] dans le corps de l'email
    const body = emailBodyGlobal
      .replace('[LIEN]', link)
      .replace('[Theme]', formationEnCours.Theme)
      .replace('[Date]', dateFormation);
    
    // Ouvrir le client de messagerie
    const mailtoLink = `mailto:${stagiaire.Email}?subject=${encodeURIComponent(emailSubjectGlobal)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoLink;
  }

  function envoyerTousEmails() {
    if (!formationEnCours) return;
    
    const stagiaires = JSON.parse(formationEnCours.Stagiaires);
    
    // Formater la date de la formation
    const dateFormation = new Date(formationEnCours.Date).toLocaleDateString('fr-FR', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    // Ouvrir le client de messagerie pour chaque stagiaire
    stagiaires.forEach((stagiaire, index) => {
      const link = `${window.location.origin}${window.location.pathname}?fid=${formationEnCours.FormationID}&sid=${stagiaire.StagiaireID}`;
      
      // Remplacer [LIEN], [Theme] et [Date] dans le corps de l'email
      const body = emailBodyGlobal
        .replace('[LIEN]', link)
        .replace('[Theme]', formationEnCours.Theme)
        .replace('[Date]', dateFormation);
      
      const mailtoLink = `mailto:${stagiaire.Email}?subject=${encodeURIComponent(emailSubjectGlobal)}&body=${encodeURIComponent(body)}`;
      
      // Ouvrir avec un petit d√©lai pour √©viter le blocage de pop-ups
      setTimeout(() => {
        window.open(mailtoLink, '_blank');
      }, index * 500); // 500ms de d√©lai entre chaque ouverture
    });
  }

  function retourFormulaire() {
    document.getElementById('validationPresenceSection').style.display = 'none';
    document.getElementById('formSection').style.display = 'block';
    formationEnCours = null;
  }

  function terminerValidation() {
    // R√©initialiser compl√®tement
    document.getElementById('validationPresenceSection').style.display = 'none';
    document.getElementById('formSection').style.display = 'block';
    formationEnCours = null;
    
    // R√©initialiser le formulaire
    resetForm();
    
    alert('‚úÖ Validation termin√©e ! La formation a √©t√© enregistr√©e.');
  }

  // Expose pour onClick inline
  window.switchTab=switchTab; 
  window.addStagiaire=addStagiaire; 
  window.removeStagiaire=removeStagiaire;
  window.openEmailModal=openEmailModal; 
  window.closeEmailModal=closeEmailModal; 
  window.saveEmailChanges=saveEmailChanges;
  window.openReminderModal=openReminderModal; 
  window.closeReminderModal=closeReminderModal; 
  window.sendReminder=sendReminder;
  window.sendIndividualEmail=sendIndividualEmail;
  window.resetForm=resetForm;
  window.marquerPresence=marquerPresence;
  window.marquerCommentaire=marquerCommentaire;
  window.envoyerEmailStagiaire=envoyerEmailStagiaire;
  window.envoyerTousEmails=envoyerTousEmails;
  window.retourFormulaire=retourFormulaire;
  window.terminerValidation=terminerValidation;
  </script>
</body>
</html>
