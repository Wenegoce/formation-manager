<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Formation Manager - WeN√©goce</title>

  <!-- Favicon silencieux -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéì</text></svg>">

  <!-- XLSX uniquement (plus de Make) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

  <style>
    /* styles minimaux utiles (laisse tes styles existants au besoin) */
    .container{max-width:980px;margin:0 auto;padding:20px}
    .tabs{display:flex;gap:8px;margin:16px 0}
    .tab{border:1px solid #ddd;border-radius:8px;padding:8px 12px;background:#f7f7f7;cursor:pointer}
    .tab.active{background:#3270AF;color:#fff;border-color:#3270AF}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .btn{background:#3270AF;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn-secondary{background:#6c757d}
    .btn-remove{background:#f44336;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer}
    .alert{border-radius:8px;padding:12px 14px}
    .alert-info{background:#e7f3ff;border:1px solid #cfe2ff;color:#084298}
    .alert-success{background:#d1e7dd;border:1px solid #badbcc;color:#0f5132}
    .info-display .info-row{display:grid;grid-template-columns:180px 1fr;gap:10px;margin:6px 0}
    .info-label{font-weight:600;color:#555}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .form-group{margin:12px 0}
    .formation-card{border:1px solid #e0e0e0;border-radius:10px;overflow:hidden;margin-bottom:16px}
    .stars .star{font-size:22px;cursor:pointer;opacity:.4}
    .stars .star.active{opacity:1}
    .switch-container{display:flex;align-items:center;gap:8px}
    .switch{position:relative;display:inline-block;width:48px;height:24px}
    .switch input{display:none}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;border-radius:24px;transition:.2s}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;top:3px;background:white;border-radius:50%;transition:.2s}
    input:checked + .slider{background:#3270AF}
    input:checked + .slider:before{transform:translateX(24px)}
    .switch-label.active{font-weight:600}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1000}
    .modal-content{max-width:720px;margin:60px auto;background:#fff;border-radius:10px;overflow:hidden}
    .modal-header{display:flex;justify-content:space-between;align-items:center;background:#3270AF;color:#fff;padding:12px 16px}
    .modal-body{padding:18px}
    .btn-icon{background:transparent;border:0;font-size:18px;cursor:pointer}
  </style>

  <script>
  // ========================================
  // CONFIG AZURE (unique)
  // ========================================
  const FM_ENDPOINTS = {
    createFormation: "https://prod-01.francecentral.logic.azure.com:443/workflows/2ed0a1ded8c04bdb919956463f324d76/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=xdDuSi6kyJazxW0euPSUkEowfVgIrgxfAQ6a6Ogejg0",
    createPresence : "https://prod-02.francecentral.logic.azure.com:443/workflows/a108ca6c917a4197ba14e2674ff31b44/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=zOjl38vl1AXhyV25ZGW_01wVLwXZwftceAYxyk8gjro",
    manager        : "https://prod-20.francecentral.logic.azure.com:443/workflows/bad15f005ef64adab56e14fd436b8a1f/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=6iHn4hVguX6pLJFyTTvbq4ujoMwF0dnCgRfy7k7hiKA"
  };
  const ENABLE_SHAREPOINT_SYNC = true;

  // ========================================
  // HELPERS (uniques)
  // ========================================
  function toDateISOFromInput(d){
    if(!d) return null;
    try{
      if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d+"T00:00:00Z";
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(d)){
        const [dd,mm,yyyy]=d.split('/');
        return `${yyyy}-${mm}-${dd}T00:00:00Z`;
      }
    }catch(e){}
    return null;
  }

  async function postJson(url, data){
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(data)
    });
    if(!(res.ok || res.status===202)){
      const txt = await res.text().catch(()=> "");
      throw new Error(`HTTP ${res.status} ${res.statusText} ‚Äî ${txt}`);
    }
    try{ return await res.json(); } catch{ return await res.text().catch(()=>null); }
  }

  // ========================================
  // √âTAT GLOBAL
  // ========================================
  let stagiaireCount = 0;
  let formationsData = [];
  let currentFormationId = null;
  const MAX_STAGIAIRES = 10;
  let emailSubjectGlobal = '';
  let emailBodyGlobal = '';
  let currentFormationData = null;

  // ========================================
  // BOOT
  // ========================================
  document.addEventListener('DOMContentLoaded', () => {
    loadFormations();
    addStagiaire();
    initStarRatings();
    initCharCounters();
    checkURLParams();
    initEventListeners();
    initTypeFormationToggle();
    setTodayDate();
  });

  // ========================================
  // UI BASIQUE
  // ========================================
  function setTodayDate(){
    const el = document.getElementById('dateFormation');
    if(el && !el.value){
      const t=new Date(), yyyy=t.getFullYear(), mm=String(t.getMonth()+1).padStart(2,'0'), dd=String(t.getDate()).padStart(2,'0');
      el.value = `${yyyy}-${mm}-${dd}`;
    }
  }

  function switchTab(tabName){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
    const activeContent = document.getElementById(tabName);
    if(activeTab) activeTab.classList.add('active');
    if(activeContent) activeContent.classList.add('active');
    if(tabName==='formations') loadFormationsTab();
  }

  function initEventListeners(){
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=> switchTab(btn.getAttribute('data-tab')));
    });

    const btnAdd = document.getElementById('btnAddStagiaire');
    if(btnAdd) btnAdd.addEventListener('click', e=>{ e.preventDefault(); addStagiaire(); });

    const formateurForm = document.getElementById('formateurForm');
    if(formateurForm) formateurForm.addEventListener('submit', e=>{ e.preventDefault(); handleFormateurSubmit(); });

    const obligatoires = ['raisonSociale','themeFormation','nomFormateur','dateFormation','heureDebut','heureFin'];
    obligatoires.forEach(id=>{
      const f = document.getElementById(id);
      if(!f) return;
      f.addEventListener('blur', ()=> validateRequiredField(f));
      f.addEventListener('input', ()=> { if(f.value.trim()) clearError(f); });
    });

    const heureDebut = document.getElementById('heureDebut');
    const heureFin   = document.getElementById('heureFin');
    if(heureDebut) heureDebut.addEventListener('change', validateHeures);
    if(heureFin){
      heureFin.addEventListener('change', validateHeures);
      heureFin.addEventListener('blur', validateHeures);
    }

    const dateFormationInput = document.getElementById('dateFormation');
    if(dateFormationInput) dateFormationInput.addEventListener('change', validateDateFormation);

    const presenceForm = document.getElementById('presenceForm');
    if(presenceForm) presenceForm.addEventListener('submit', e=>{ e.preventDefault(); handlePresenceSubmit(); });

    const satisfactionForm = document.getElementById('satisfactionForm');
    if(satisfactionForm) satisfactionForm.addEventListener('submit', e=>{ e.preventDefault(); /* branch√©e dynamiquement dans loadStagiaireView */ });

    const referenceJira = document.getElementById('referenceJira');
    if(referenceJira) referenceJira.addEventListener('blur', ()=>{ if(referenceJira.value.trim()) validateJiraReference(referenceJira); });
  }

  function initTypeFormationToggle(){
    const toggle = document.getElementById('typeFormationToggle');
    const labelPresentiel = document.getElementById('labelPresentiel');
    const labelVisio = document.getElementById('labelVisio');
    if(!toggle) return;
    toggle.addEventListener('change', function(){
      if(this.checked){ labelPresentiel.classList.remove('active'); labelVisio.classList.add('active'); }
      else{ labelPresentiel.classList.add('active'); labelVisio.classList.remove('active'); }
    });
  }

  // ========================================
  // VALIDATIONS
  // ========================================
  function showError(input, msg){
    input.style.borderColor='#dc3545';
    const ex = input.parentElement.querySelector('.error-message'); if(ex) ex.remove();
    const small = document.createElement('small');
    small.className='error-message'; small.style.color='#dc3545'; small.style.display='block'; small.style.marginTop='5px';
    small.textContent=msg; input.parentElement.appendChild(small);
  }
  function clearError(input){
    const ex = input.parentElement.querySelector('.error-message'); if(ex) ex.remove();
    input.style.borderColor='#e0e0e0';
  }
  function validateRequiredField(input){
    if(!input.value.trim()) showError(input,'Ce champ est obligatoire');
    else{ clearError(input); input.style.borderColor='#28a745'; }
  }
  function validateEmail(input){
    const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if(input.value.trim() && !re.test(input.value)) showError(input,'Format email invalide');
    else if(input.value.trim()){ clearError(input); input.style.borderColor='#28a745'; }
  }
  function validateJiraReference(input){
    const re=/^(TIC|SMC|SNC)-\d+$/i;
    if(input.value.trim() && !re.test(input.value)) showError(input,'Format JIRA invalide (ex: TIC-123)');
    else if(input.value.trim()){ clearError(input); input.style.borderColor='#28a745'; }
  }
  function validateDateFormation(){
    const el = document.getElementById('dateFormation');
    const selected = new Date(el.value);
    const today = new Date(); today.setHours(0,0,0,0);
    const min = new Date(); min.setDate(today.getDate()-7);
    if(selected < min) showError(el,'La formation est trop ancienne. Date minimum : '+min.toLocaleDateString('fr-FR'));
    else{ clearError(el); el.style.borderColor='#28a745'; }
  }
  function validateHeures(){
    const d = document.getElementById('heureDebut'), f = document.getElementById('heureFin');
    if(!(d.value && f.value)) return;
    const [hd,md]=d.value.split(':').map(Number), [hf,mf]=f.value.split(':').map(Number);
    if((hf*60+mf) <= (hd*60+md)) showError(f,'L‚Äôheure de fin doit √™tre apr√®s l‚Äôheure de d√©but');
    else{ clearError(f); f.style.borderColor='#28a745'; }
  }

  // ========================================
  // ONGLET FORMATEUR ‚Äî saisie stagiaires
  // ========================================
  function addStagiaire(){
    if(stagiaireCount >= MAX_STAGIAIRES){ alert('‚ö†Ô∏è Maximum de '+MAX_STAGIAIRES+' stagiaires atteint'); return; }
    stagiaireCount++;
    const container = document.getElementById('stagiairesList');
    const item = document.createElement('div');
    item.className='stagiaire-item'; item.id='stagiaire-'+stagiaireCount;
    item.innerHTML = `
      <div class="stagiaire-header">
        <span class="stagiaire-number">Stagiaire ${stagiaireCount}</span>
        <button type="button" class="btn-remove" onclick="removeStagiaire(${stagiaireCount})">üóëÔ∏è Supprimer</button>
      </div>
      <div class="row">
        <div class="form-group">
          <label>Nom complet *</label>
          <input type="text" id="nomStagiaire${stagiaireCount}" required>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="emailStagiaire${stagiaireCount}" required>
        </div>
      </div>`;
    container.appendChild(item);
    const emailInput = document.getElementById('emailStagiaire'+stagiaireCount);
    if(emailInput){
      emailInput.addEventListener('blur', ()=> validateEmail(emailInput));
      emailInput.addEventListener('input', ()=> { if(emailInput.value.trim()) clearError(emailInput); });
    }
  }
  function removeStagiaire(id){
    const el=document.getElementById('stagiaire-'+id);
    if(el){ el.remove(); stagiaireCount--; }
  }

  // anti-doublon & normalisation email
  function normalizeEmail(e){ return e.trim().toLowerCase(); }

  async function handleFormateurSubmit(){
    const raisonSociale = document.getElementById('raisonSociale').value.trim();
    const theme         = document.getElementById('themeFormation').value.trim();
    const referenceJira = document.getElementById('referenceJira').value.trim();
    const nomFormateur  = document.getElementById('nomFormateur').value.trim();
    const dateFormation = document.getElementById('dateFormation').value;
    const typeFormation = document.getElementById('typeFormationToggle').checked ? 'Visio' : 'Pr√©sentiel';
    const heureDebut    = document.getElementById('heureDebut').value;
    const heureFin      = document.getElementById('heureFin').value;

    if(!raisonSociale||!theme||!nomFormateur||!dateFormation||!heureDebut||!heureFin){
      alert('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires'); return;
    }
    if(referenceJira && !/^(TIC|SMC|SNC)-\d+$/i.test(referenceJira)){
      alert('‚ö†Ô∏è Format JIRA invalide. Utilisez TIC-123 / SMC-456 / SNC-789'); return;
    }
    const d = new Date(dateFormation), today=new Date(); today.setHours(0,0,0,0);
    const min = new Date(); min.setDate(today.getDate()-7);
    if(d < min){ alert('‚ö†Ô∏è La date de formation est trop ancienne (plus de 7 jours)'); return; }
    const [hd,md]=heureDebut.split(':').map(Number), [hf,mf]=heureFin.split(':').map(Number);
    if((hf*60+mf) <= (hd*60+md)){ alert('‚ö†Ô∏è L‚Äôheure de fin doit √™tre apr√®s l‚Äôheure de d√©but'); return; }

    const stagiaires = [];
    let hasError=false;
    const seen = new Set();
    for(let i=1;i<=stagiaireCount;i++){
      const nomInput   = document.getElementById('nomStagiaire'+i);
      const emailInput = document.getElementById('emailStagiaire'+i);
      if(!nomInput || !emailInput) continue;
      const nom = nomInput.value.trim();
      const emailRaw = emailInput.value;
      if(!nom){ showError(nomInput,'Ce champ est obligatoire'); hasError=true; }
      if(!emailRaw){ showError(emailInput,'Ce champ est obligatoire'); hasError=true; }
      else{
        const email = normalizeEmail(emailRaw);
        if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showError(emailInput,'Format email invalide'); hasError=true; }
        else if(seen.has(email)){ showError(emailInput,'Email d√©j√† pr√©sent dans la liste'); hasError=true; }
        else{
          seen.add(email);
          const id='STG-'+Date.now()+'-'+Math.random().toString(36).slice(2,11);
          stagiaires.push({ id, nom, email, lien:null, presence:null, commentaire:'', satisfaction:null });
        }
      }
    }
    if(hasError){ alert('‚ö†Ô∏è Corrige les erreurs signal√©es'); return; }
    if(stagiaires.length===0){ alert('‚ö†Ô∏è Ajoute au moins un stagiaire'); return; }

    currentFormationId = 'FRM-'+Date.now()+'-'+Math.random().toString(36).slice(2,11);
    currentFormationData = {
      id: currentFormationId,
      raisonSociale, theme, referenceJira, nomFormateur,
      date: dateFormation, type: typeFormation, heureDebut, heureFin,
      stagiaires
    };
    const baseUrl = window.location.origin + window.location.pathname;
    currentFormationData.stagiaires.forEach(s=> s.lien = `${baseUrl}?fid=${currentFormationId}&stid=${s.id}`);

    const submit = document.querySelector('#formateurForm button[type="submit"]');
    const txt = submit.innerHTML; submit.disabled=true; submit.innerHTML='‚è≥ Enregistrement en cours...';

    try{
      if(ENABLE_SHAREPOINT_SYNC){
        const payload = {
          FormationID: currentFormationId,
          Theme: theme,
          Formateur: nomFormateur,
          Client: raisonSociale,
          DateISO: toDateISOFromInput(dateFormation),
          HeureDebut: heureDebut,
          HeureFin: heureFin,
          TypeFormation: typeFormation,
          Statut: "Planifi√©e",
          ReferenceJIRA: referenceJira || "",
          Stagiaires: currentFormationData.stagiaires
        };
        await postJson(FM_ENDPOINTS.createFormation, payload);
      }
      formationsData.push(currentFormationData); saveFormations();
      document.getElementById('preparationForm').style.display='none';
      document.getElementById('postFormationSection').style.display='block';
      displayFormationInfo(); displayPresenceForm(); window.scrollTo(0,0);
    } catch(err){
      alert('‚ùå Erreur lors de l‚Äôenregistrement de la formation.\n'+err.message);
      console.error(err);
    } finally{
      submit.disabled=false; submit.innerHTML=txt;
    }
  }

  function displayFormationInfo(){
    const f=currentFormationData, info=document.getElementById('formationInfo');
    info.innerHTML = `
      <div class="info-row"><div class="info-label">Client :</div><div>${f.raisonSociale}</div></div>
      <div class="info-row"><div class="info-label">Formation :</div><div>${f.theme}</div></div>
      ${f.referenceJira?`<div class="info-row"><div class="info-label">R√©f√©rence JIRA :</div><div>${f.referenceJira}</div></div>`:''}
      <div class="info-row"><div class="info-label">Formateur :</div><div>${f.nomFormateur}</div></div>
      <div class="info-row"><div class="info-label">Date :</div><div>${new Date(f.date).toLocaleDateString('fr-FR')}</div></div>
      <div class="info-row"><div class="info-label">Type :</div><div>${f.type}</div></div>
      <div class="info-row"><div class="info-label">Horaires :</div><div>${f.heureDebut} - ${f.heureFin}</div></div>
      <div class="info-row"><div class="info-label">Nombre de stagiaires :</div><div>${f.stagiaires.length}</div></div>`;
  }

  function displayPresenceForm(){
    const c=document.getElementById('presenceList'); c.innerHTML='';
    currentFormationData.stagiaires.forEach((s,idx)=>{
      const div=document.createElement('div'); div.className='stagiaire-item';
      div.innerHTML=`
        <div class="stagiaire-header"><span class="stagiaire-number">${s.nom}</span></div>
        <div class="form-group">
          <label>Pr√©sence *</label>
          <div class="radio-group">
            <label class="radio-item"><input type="radio" name="presence${idx}" value="Present" required><span>‚úÖ Present</span></label>
            <label class="radio-item"><input type="radio" name="presence${idx}" value="Absent" required><span>‚ùå Absent</span></label>
            <label class="radio-item"><input type="radio" name="presence${idx}" value="Partielle" required><span>‚ö†Ô∏è Partielle</span></label>
          </div>
        </div>
        <div class="form-group">
          <label>Commentaire du formateur</label>
          <textarea id="commentaire${idx}" rows="2" placeholder="Observations particuli√®res sur ce stagiaire..."></textarea>
        </div>`;
      c.appendChild(div);
    });
  }

  function handlePresenceSubmit(){
    currentFormationData.stagiaires.forEach((s,idx)=>{
      const inputs = document.getElementsByName('presence'+idx);
      const com = document.getElementById('commentaire'+idx);
      let val=null; inputs.forEach(i=>{ if(i.checked) val=i.value; });
      s.presence = val; s.commentaire = com?com.value.trim():'';
    });
    saveFormations();
    document.getElementById('postFormationSection').style.display='none';
    generateEmailLinks(); window.scrollTo(0,0);
  }

  // ========================================
  // ENVOI EMAILS + PUSH PR√âSENCES
  // ========================================
  function generateEmailLinks(){
    const f=currentFormationData, container=document.getElementById('emailLinks');

    if(ENABLE_SHAREPOINT_SYNC){
      const payload = {
        FormationID: currentFormationId,
        Stagiaires: f.stagiaires.map(s=>({
          id:s.id, nom:s.nom, email:s.email, presence:s.presence ?? null, commentaire:s.commentaire ?? ''
        }))
      };
      postJson(FM_ENDPOINTS.createPresence, payload).then(()=> {
        console.log('Pr√©sences ‚Üí Azure OK');
      }).catch(err=> console.error('Push pr√©sences KO:',err));
    }

    const dateFr = new Date(f.date).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    emailSubjectGlobal = `Votre formation ${f.theme} - attestation et enqu√™te de satisfaction`;
    emailBodyGlobal =
      `Bonjour,\n\n`+
      `Vous avez particip√© √† la formation ¬´ ${f.theme} ¬ª anim√©e par ${f.nomFormateur} le ${dateFr}.\n\n`+
      `Afin de finaliser votre dossier, nous vous invitons √† cliquer sur le lien ci-dessous. Vous y trouverez :\n`+
      `‚Ä¢ votre attestation de pr√©sence,\n`+
      `‚Ä¢ ainsi qu'une br√®ve enqu√™te de satisfaction (moins d'une minute √† remplir).\n\n`+
      `üëâ [LIEN]\n\n`+
      `Nous vous remercions pour votre participation et restons √† votre disposition pour toute question compl√©mentaire.\n\n`+
      `Bien cordialement,`;

    container.innerHTML = `
      <h2 style="margin-bottom:20px;color:#3270AF;">üìß Envoi des liens aux stagiaires</h2>
      <div class="alert alert-success" style="margin-bottom:20px;">‚úÖ Les pr√©sences ont √©t√© enregistr√©es avec succ√®s !</div>
      <div style="background:#e7f3ff;padding:20px;border-radius:8px;border-left:4px solid #3270AF;margin-bottom:20px;">
        <strong style="color:#3270AF;">üìß Mod√®le d'email</strong>
        <button class="btn" style="margin-left:10px;background:#0d6efd" onclick="openEmailModal()">‚úèÔ∏è Personnaliser</button>
        <div style="margin-top:12px;padding:15px;background:#fff;border-radius:8px;">
          <div style="margin-bottom:10px;"><strong>Objet :</strong> ${emailSubjectGlobal}</div>
          <div style="white-space:pre-wrap;color:#555;">${emailBodyGlobal.replace('[LIEN]','üîó Lien personnalis√© du stagiaire')}</div>
        </div>
      </div>
      <div style="margin-bottom:20px;padding:15px;background:#e7f3ff;border-radius:8px;border-left:4px solid #3270AF;">
        <strong style="color:#3270AF;">üìß Envoi individuel</strong><br>
        <small style="color:#666;">Chaque stagiaire re√ßoit uniquement son lien</small>
        <div id="individualEmailsList" style="margin-top:12px;"></div>
      </div>`;

    const list=document.getElementById('individualEmailsList');
    f.stagiaires.forEach(s=>{
      const div=document.createElement('div');
      div.style.cssText='background:#fff;padding:15px;border-radius:8px;margin-bottom:10px;border:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;';
      div.innerHTML = `
        <div>
          <strong style="color:#333;">${s.nom}</strong><br>
          <small style="color:#666;">${s.email}</small><br>
          <small style="color:#999;">Pr√©sence : <strong style="color:${s.presence==='Present'?'#28a745':'#666'};">${s.presence || '‚Äî'}</strong></small>
        </div>
        <button class="btn" style="margin:0;padding:10px 20px;font-size:14px;" onclick="sendIndividualEmail('${s.id}')">üìß Envoyer</button>`;
      list.appendChild(div);
    });

    document.getElementById('linksGenerated').style.display='block';
  }

  function openEmailModal(){
    document.getElementById('emailSubjectEdit').value = emailSubjectGlobal;
    document.getElementById('emailBodyEdit').value   = emailBodyGlobal;
    document.getElementById('emailModal').style.display='block';
  }
  function closeEmailModal(){ document.getElementById('emailModal').style.display='none'; }
  function saveEmailChanges(){
    emailSubjectGlobal = document.getElementById('emailSubjectEdit').value;
    emailBodyGlobal    = document.getElementById('emailBodyEdit').value;
    closeEmailModal(); generateEmailLinks();
  }
  function sendIndividualEmail(stagiaireId){
    const f=currentFormationData;
    const s=f.stagiaires.find(x=>x.id===stagiaireId);
    if(!s){ alert('‚ùå Erreur : Stagiaire non trouv√©'); return; }
    const subject = encodeURIComponent(emailSubjectGlobal);
    const body    = encodeURIComponent(emailBodyGlobal.replace('[LIEN]', s.lien));
    window.location.href = `mailto:${s.email}?subject=${subject}&body=${body}`;
  }

  // ========================================
  // RELANCE
  // ========================================
  let currentReminderFormationId=null, currentReminderStagiaireId=null;
  function openReminderModal(formationId, stagiaireIndex){
    const f = formationsData.find(x=>x.id===formationId); if(!f) return;
    const enAttente = f.stagiaires.filter(s=> (s.presence==='Present' || s.presence==='Partielle') && !s.satisfaction);
    const s = enAttente[stagiaireIndex]; if(!s) return;
    currentReminderFormationId=formationId; currentReminderStagiaireId=s.id;

    const dateFr = new Date(f.date).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    document.getElementById('reminderInfo').innerHTML = `
      <div class="info-row"><div class="info-label">Formation :</div><div>${f.theme}</div></div>
      <div class="info-row"><div class="info-label">Date :</div><div>${dateFr}</div></div>
      <div class="info-row"><div class="info-label">Stagiaire :</div><div>${s.nom}</div></div>
      <div class="info-row"><div class="info-label">Email :</div><div>${s.email}</div></div>`;
    document.getElementById('reminderSubjectEdit').value = `Relance - Enqu√™te de satisfaction formation ${f.theme}`;
    document.getElementById('reminderBodyEdit').value =
      `Bonjour,\n\nLa mesure de votre satisfaction est importante pour √©valuer la formation ${f.theme} du ${dateFr}.\n\n`+
      `Merci de r√©pondre au questionnaire en cliquant sur le lien : [LIEN]\n\nTr√®s cordialement`;
    document.getElementById('reminderModal').style.display='block';
  }
  function closeReminderModal(){ document.getElementById('reminderModal').style.display='none'; currentReminderFormationId=null; currentReminderStagiaireId=null; }
  function sendReminder(){
    if(!currentReminderFormationId || !currentReminderStagiaireId) return;
    const f = formationsData.find(x=>x.id===currentReminderFormationId); if(!f) return;
    const s = f.stagiaires.find(x=>x.id===currentReminderStagiaireId); if(!s) return;
    const subject = document.getElementById('reminderSubjectEdit').value;
    const body    = document.getElementById('reminderBodyEdit').value.replace('[LIEN]', s.lien);
    const mailto  = `mailto:${s.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailto; closeReminderModal();
  }

  // ========================================
  // ONGLET STAGIAIRE ‚Äî ROUTAGE + R√âCUP
  // ========================================
  function checkURLParams(){
    const p=new URLSearchParams(window.location.search);
    const formationId=p.get('fid'), stagiaireId=p.get('stid');
    if(formationId && stagiaireId){
      document.querySelectorAll('.tab').forEach(tab=>{ if(tab.getAttribute('data-tab')!=='stagiaire') tab.style.display='none'; });
      switchTab('stagiaire'); loadStagiaireView(formationId, stagiaireId);
    }
  }

  async function loadStagiaireView(formationId, stagiaireId){
    let formation = formationsData.find(f=>f.id===formationId);
    if(!formation && FM_ENDPOINTS.manager){
      try{
        const raw = await postJson(FM_ENDPOINTS.manager, { formationId, stagiaireId });
        const obj = raw && raw.formation ? raw.formation : raw;
        formation = transformAzureFormation(obj);
      }catch(e){ console.error('R√©cup Azure manager:', e); }
    }
    if(!formation){
      document.getElementById('infoFormation').innerHTML =
        `<div class="alert" style="background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;">‚ùå Formation non trouv√©e ou lien invalide.</div>`;
      return;
    }
    const stagiaire = formation.stagiaires.find(s=>s.id===stagiaireId);
    if(!stagiaire){
      document.getElementById('infoFormation').innerHTML =
        `<div class="alert" style="background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;">‚ùå Stagiaire non trouv√© ou lien invalide.</div>`;
      return;
    }
    if(stagiaire.satisfaction){
      displayThankYouMessage(stagiaire.satisfaction.noteGlobale,'Merci ! Votre retour a bien √©t√© enregistr√©.');
      return;
    }
    const dateFr = new Date(formation.date).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    document.getElementById('infoFormation').innerHTML = `
      <h3 style="color:#3270AF;margin-bottom:15px;">‚úÖ Attestation de pr√©sence</h3>
      <div class="info-row"><div class="info-label">Formation :</div><div>${formation.theme}</div></div>
      <div class="info-row"><div class="info-label">Date :</div><div>${dateFr}</div></div>
      <div class="info-row"><div class="info-label">Horaires :</div><div>${formation.heureDebut} - ${formation.heureFin}</div></div>
      <div class="info-row"><div class="info-label">Formateur :</div><div>${formation.nomFormateur}</div></div>
      <div class="info-row"><div class="info-label">Client :</div><div>${formation.raisonSociale}</div></div>
      <div class="info-row"><div class="info-label">Stagiaire :</div><div>${stagiaire.nom}</div></div>
      <div class="info-row"><div class="info-label">Statut :</div>
        <div><strong style="color:${stagiaire.presence==='Present' ? '#28a745' : '#dc3545'};">${stagiaire.presence || 'Non renseign√©'}</strong></div></div>`;
    if(stagiaire.presence!=='Absent'){
      const form = document.getElementById('satisfactionForm');
      form.style.display='block';
      form.onsubmit = (e)=>{ e.preventDefault(); handleSatisfactionSubmit(formationId, stagiaireId); };
    } else {
      document.getElementById('infoFormation').innerHTML +=
        `<div class="alert alert-info" style="margin-top:20px;">‚ÑπÔ∏è Enqu√™te disponible uniquement pour les pr√©sents/partiels.</div>`;
    }
  }

  function transformAzureFormation(sp){
    if(!sp) return null;
    let stagiaires=[];
    if(sp.Stagiaires!==undefined){
      const raw=sp.Stagiaires;
      if(typeof raw==='string'){ try{ stagiaires=JSON.parse(raw); }catch{ stagiaires=[]; } }
      else if(Array.isArray(raw)) stagiaires=raw;
      else if(raw && typeof raw==='object') stagiaires=[raw];
    } else if(sp.stagiaires) stagiaires=sp.stagiaires;

    let dateFormation = sp.DateFormation || sp.Date || sp.date;
    if(dateFormation && typeof dateFormation==='string' && dateFormation.includes('T')) dateFormation = dateFormation.split('T')[0];

    return {
      id: sp.FormationID || sp.id,
      raisonSociale: sp.RaisonSociale || sp.Client || sp.raisonSociale || '',
      theme: sp.Theme || sp.ThemeFormation || sp.theme || '',
      referenceJira: sp.ReferenceJIRA || sp.ReferenceJira || sp.referenceJira || '',
      nomFormateur: sp.Formateur || sp.NomFormateur || sp.nomFormateur || '',
      date: dateFormation || '',
      type: sp.TypeFormation || sp.type || '',
      heureDebut: sp.HeureDebut || sp.heureDebut || '',
      heureFin: sp.HeureFin || sp.heureFin || '',
      stagiaires
    };
  }

  // ========================================
  // √âTOILES & COMPTEURS
  // ========================================
  function initStarRatings(){
    ['q1','q2','q3'].forEach(id=>{
      const c=document.getElementById(id+'Stars'); if(!c) return;
      for(let i=1;i<=5;i++){
        const s=document.createElement('span'); s.className='star'; s.innerHTML='‚òÖ'; s.dataset.value=i; s.dataset.question=id;
        s.addEventListener('click', function(){
          document.getElementById(this.dataset.question).value=this.dataset.value;
          updateStars(this.dataset.question, this.dataset.value);
        });
        c.appendChild(s);
      }
    });
  }
  function updateStars(qId, value){
    document.querySelectorAll('#'+qId+'Stars .star').forEach((star,idx)=>{
      if(idx < value) star.classList.add('active'); else star.classList.remove('active');
    });
  }
  function initCharCounters(){
    ['q6','q7'].forEach(id=>{
      const t=document.getElementById(id), c=document.getElementById(id+'Count');
      if(t && c){
        t.addEventListener('input', function(){
          const r=100-this.value.length; c.textContent=r; c.style.color=(r<20)?'#dc3545':'#666';
        });
      }
    });
  }

  // ========================================
  // SATISFACTION ‚Üí manager
  // ========================================
  function handleSatisfactionSubmit(formationId, stagiaireId){
    const q4 = document.querySelector('input[name="q4"]:checked');
    const q5 = document.querySelector('input[name="q5"]:checked');
    if(!q4 || !q5){ alert('‚ö†Ô∏è R√©pondre √† toutes les questions obligatoires (*)'); return; }

    const q1 = parseInt(document.getElementById('q1').value||'0',10);
    const q2 = parseInt(document.getElementById('q2').value||'0',10);
    const q3 = parseInt(document.getElementById('q3').value||'0',10);

    let q4Score = { 'Pas du tout':0,'Un peu':1,'Moyennement':2,'Assez':3,'Tout √† fait':5 }[q4.value] ?? 0;
    let q5Score = { 'Trop courte':0,'Adapt√©e':5,'Trop longue':3 }[q5.value] ?? 0;

    const total = q1+q2+q3+q4Score+q5Score;
    const noteGlobale = (total/5).toFixed(2);

    const satisfaction = {
      q1, q2, q3,
      q4: q4.value,
      q5: q5.value,
      q6: document.getElementById('q6').value,
      q7: document.getElementById('q7').value,
      noteGlobale,
      dateEnvoi: new Date().toISOString()
    };

    if(ENABLE_SHAREPOINT_SYNC && FM_ENDPOINTS.manager){
      const payload = {
        action: "SaveSatisfaction",
        FormationID: formationId,
        StagiaireID: stagiaireId,
        Q1_Attentes: satisfaction.q1,
        Q2_Objectifs: satisfaction.q2,
        Q3_Formateur: satisfaction.q3,
        Q4_Aise: satisfaction.q4,
        Q5_Duree: satisfaction.q5,
        Q6_Suggestions: satisfaction.q6 || '',
        Q7_Commentaire: satisfaction.q7 || '',
        NoteGlobale: parseFloat(satisfaction.noteGlobale),
        DateReponse: satisfaction.dateEnvoi
      };
      postJson(FM_ENDPOINTS.manager, payload)
        .then(()=>{
          const msg = noteGlobale < 3
            ? 'Nous allons revenir vers vous pour comprendre cette √©valuation.'
            : (noteGlobale <= 4.5 ? 'Merci, votre retour va nous permettre de nous am√©liorer.' : 'Merci ! Cette bonne note nous encourage √† continuer.');
          displayThankYouMessage(noteGlobale, msg);
        })
        .catch(err=>{
          console.error('Erreur manager:', err);
          displayThankYouMessage(noteGlobale, 'Votre r√©ponse est enregistr√©e localement. Une erreur est survenue c√¥t√© serveur.');
        });
    } else {
      displayThankYouMessage(noteGlobale, 'Votre r√©ponse est enregistr√©e localement (mode hors-ligne).');
    }
  }

  function displayThankYouMessage(noteGlobale, message){
    document.getElementById('infoFormation').style.display='none';
    document.getElementById('satisfactionForm').style.display='none';
    const t=document.getElementById('thankYouMessage');
    t.innerHTML = `
      <div class="alert alert-success">
        <h3 style="margin-bottom:15px;">‚úÖ Merci pour votre participation !</h3>
        <p style="font-size:18px;margin:15px 0;"><strong>Votre avis compte beaucoup pour nous.</strong></p>
        <p style="font-size:20px;margin:15px 0;color:#3270AF;"><strong>Votre appr√©ciation globale est de ${noteGlobale} sur 5.</strong></p>
        <p style="margin-top:15px;">${message||''}</p>
      </div>`;
    t.style.display='block';
  }

  // ========================================
  // ONGLET FORMATIONS
  // ========================================
  async function loadFormationsTab(){
    const loading=document.getElementById('formationsLoading');
    const list=document.getElementById('formationsList');
    const empty=document.getElementById('formationsEmpty');
    loading.style.display='block'; list.style.display='none'; empty.style.display='none';

    let formations=[...formationsData];
    const threshold=new Date(); threshold.setMonth(threshold.getMonth()-3);
    formations = formations.filter(f=>{
      const d=new Date(f.date); if(d<threshold) return false;
      return f.stagiaires.some(s=>(s.presence==='Present'||s.presence==='Partielle') && !s.satisfaction);
    });

    setTimeout(()=>{
      loading.style.display='none';
      if(formations.length===0) empty.style.display='block';
      else{ displayFormationsCards(formations); list.style.display='block'; }
    }, 400);
  }

  function displayFormationsCards(formations){
    const c=document.getElementById('formationsList'); c.innerHTML='';
    formations.forEach(f=> c.appendChild(createFormationCard(f)) );
  }

  function createFormationCard(formation){
    const dateFr=new Date(formation.date).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    const todo = formation.stagiaires.filter(s=>(s.presence==='Present'||s.presence==='Partielle') && !s.satisfaction);
    const card=document.createElement('div'); card.className='formation-card';
    let body='';
    todo.forEach((s,idx)=>{
      body+=`
        <div class="stagiaire-item" style="margin-bottom:15px;padding:12px;background:#f8f9fa;border-radius:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong>${s.nom}</strong><br><small style="color:#666;">${s.email}</small></div>
            <button class="btn" onclick="openReminderModal('${formation.id}', ${idx})" style="background:#ff9800;">üìß Relancer</button>
          </div>
        </div>`;
    });
    card.innerHTML=`
      <div style="background:#3270AF;color:#fff;padding:15px;border-radius:8px 8px 0 0;">
        <div style="font-size:14px;opacity:.9;">${formation.raisonSociale}</div>
        <div style="font-size:18px;font-weight:600;margin-top:4px;">${formation.theme}</div>
        <div style="font-size:13px;opacity:.85;margin-top:8px;border-top:1px solid rgba(255,255,255,.2);padding-top:8px;">${dateFr}</div>
      </div>
      <div style="padding:15px;">
        <h4 style="color:#3270AF;margin-bottom:12px;">Stagiaires en attente :</h4>
        ${body}
      </div>`;
    return card;
  }

  // ========================================
  // PERSISTANCE LOCALE + EXPORT
  // ========================================
  function saveFormations(){ localStorage.setItem('wenegoce_formations', JSON.stringify(formationsData)); }
  function loadFormations(){
    const s=localStorage.getItem('wenegoce_formations'); if(!s) return;
    try{ formationsData = JSON.parse(s)||[]; }catch(e){ console.error('LS load:',e); formationsData=[]; }
  }

  function generateExcel(auto=false){
    if(formationsData.length===0){ if(!auto) alert('‚ùå Aucune donn√©e √† exporter'); return; }
    const data=[];
    formationsData.forEach(f=>{
      const row = {
        'Date': new Date(f.date).toLocaleDateString('fr-FR'),
        'Client': f.raisonSociale,
        'Formation': f.theme,
        'R√©f√©rence JIRA': f.referenceJira || '',
        'Formateur': f.nomFormateur,
        'Type': f.type,
        'Heure d√©but': f.heureDebut,
        'Heure fin': f.heureFin
      };
      for(let i=0;i<MAX_STAGIAIRES;i++){
        const s=f.stagiaires[i], p=`Stagiaire ${i+1} - `;
        if(s){
          row[p+'Nom']=s.nom; row[p+'Email']=s.email; row[p+'Pr√©sence']=s.presence||'Non renseign√©'; row[p+'Commentaire formateur']=s.commentaire||'';
          if(s.satisfaction){
            row[p+'Q1 (attentes 1-5)']=s.satisfaction.q1;
            row[p+'Q2 (objectifs 1-5)']=s.satisfaction.q2;
            row[p+'Q3 (formateur 1-5)']=s.satisfaction.q3;
            row[p+'Q4 (aisance)']=s.satisfaction.q4;
            row[p+'Q5 (dur√©e)']=s.satisfaction.q5;
            row[p+'Suggestions']=s.satisfaction.q6;
            row[p+'Commentaire']=s.satisfaction.q7;
            row[p+'Note globale /5']=s.satisfaction.noteGlobale;
            row[p+'Date r√©ponse']=new Date(s.satisfaction.dateEnvoi).toLocaleDateString('fr-FR');
          } else {
            row[p+'Q1 (attentes 1-5)']=row[p+'Q2 (objectifs 1-5)']=row[p+'Q3 (formateur 1-5)']='';
            row[p+'Q4 (aisance)']=row[p+'Q5 (dur√©e)']='';
            row[p+'Suggestions']=row[p+'Commentaire']='';
            row[p+'Note globale /5']=row[p+'Date r√©ponse']='';
          }
        } else {
          row[p+'Nom']=row[p+'Email']=row[p+'Pr√©sence']=row[p+'Commentaire formateur']='';
          row[p+'Q1 (attentes 1-5)']=row[p+'Q2 (objectifs 1-5)']=row[p+'Q3 (formateur 1-5)']='';
          row[p+'Q4 (aisance)']=row[p+'Q5 (dur√©e)']='';
          row[p+'Suggestions']=row[p+'Commentaire']='';
          row[p+'Note globale /5']=row[p+'Date r√©ponse']='';
        }
      }
      data.push(row);
    });
    const ws=XLSX.utils.json_to_sheet(data), wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Formations');
    const file='wenegoce-formations-'+new Date().toISOString().split('T')[0]+'.xlsx';
    XLSX.writeFile(wb, file);
    if(!auto) console.log('Export Excel g√©n√©r√© : '+file);
  }
  </script>
</head>

<body>
  <div class="container">
    <div class="header" style="display:flex;gap:16px;align-items:center;">
      <div class="header-logo">
        <img src="https://back.wenegoce.fr/uploads/0406_Logo_We_Negoce_avec_We_Soft_DEFINITIF_502368ceeb.png" alt="WeN√©goce" style="height:44px;">
      </div>
      <div class="header-content">
        <h1>Formation Manager</h1>
        <p>Suivi des pr√©sences et enqu√™te de satisfaction stagiaires</p>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="formateur">üë®‚Äçüè´ Espace Formateur</button>
      <button class="tab" data-tab="formations">üìã Formations</button>
      <button class="tab" data-tab="stagiaire">üë§ Espace Stagiaire</button>
    </div>

    <div class="content">
      <div id="formateur" class="tab-content active">
        <h2 style="margin-bottom:20px;color:#3270AF;">Pr√©paration de la formation</h2>

        <div id="preparationForm">
          <form id="formateurForm">
            <div class="form-group">
              <label>Raison sociale du client *</label>
              <input type="text" id="raisonSociale" required>
            </div>
            <div class="form-group">
              <label>Th√®me de la formation *</label>
              <input type="text" id="themeFormation" required>
            </div>
            <div class="form-group">
              <label>R√©f√©rence JIRA</label>
              <input type="text" id="referenceJira" placeholder="TIC-123, SMC-456 ou SNC-789">
              <small style="color:#999;font-size:12px;">Format : TIC-/SMC-/SNC- + num√©ro (optionnel)</small>
            </div>
            <div class="form-group">
              <label>Nom du formateur *</label>
              <input type="text" id="nomFormateur" required>
            </div>

            <div class="row">
              <div class="form-group">
                <label>Date de la formation *</label>
                <input type="date" id="dateFormation" required>
              </div>
              <div class="form-group">
                <label>Type de formation *</label>
                <div class="switch-container">
                  <span class="switch-label active" id="labelPresentiel">üè¢ Pr√©sentiel</span>
                  <label class="switch">
                    <input type="checkbox" id="typeFormationToggle">
                    <span class="slider"></span>
                  </label>
                  <span class="switch-label" id="labelVisio">üíª Visio</span>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="form-group">
                <label>Heure de d√©but *</label>
                <input type="time" id="heureDebut" required>
              </div>
              <div class="form-group">
                <label>Heure de fin *</label>
                <input type="time" id="heureFin" required>
              </div>
            </div>

            <h3 style="margin:30px 0 15px;color:#3270AF;">Liste des stagiaires</h3>
            <div id="stagiairesList"></div>

            <div style="display:flex;gap:15px;margin-top:30px;flex-wrap:wrap;">
              <button type="button" class="btn btn-secondary" id="btnAddStagiaire">‚ûï Ajouter un stagiaire</button>
              <button type="submit" class="btn">üìù Feuille de pr√©sence</button>
            </div>
          </form>
        </div>

        <div id="postFormationSection" style="display:none;">
          <div class="alert alert-info">
            ‚ÑπÔ∏è <strong>Formation enregistr√©e !</strong> √Ä la fin de la session, compl√©tez les pr√©sences ci-dessous.
          </div>

          <div id="formationInfo" class="info-display" style="margin-bottom:20px;"></div>

          <h3 style="margin-bottom:12px;color:#3270AF;">Compl√©ter les pr√©sences</h3>
          <form id="presenceForm">
            <div id="presenceList"></div>
            <div style="margin-top:20px;">
              <button type="submit" class="btn">üìß G√©n√©rer et envoyer les liens stagiaires</button>
            </div>
          </form>
        </div>

        <div id="linksGenerated" style="display:none;margin-top:20px;">
          <div class="alert alert-success">‚úÖ Liens g√©n√©r√©s. Vous pouvez envoyer les emails.</div>
          <div id="emailLinks"></div>
        </div>
      </div>

      <div id="formations" class="tab-content">
        <h2 style="margin-bottom:16px;color:#3270AF;">üìã Mes Formations</h2>
        <div class="alert alert-info">‚ÑπÔ∏è S√©lectionnez une formation pour relancer les stagiaires en attente.</div>
        <div id="formationsLoading" style="text-align:center;padding:30px;color:#666;">üîÑ Chargement‚Ä¶</div>
        <div id="formationsList" style="display:none;"></div>
        <div id="formationsEmpty" style="display:none;text-align:center;padding:30px;color:#999;">üì≠ Aucune formation trouv√©e.</div>
      </div>

      <div id="stagiaire" class="tab-content">
        <div id="stagiaireView">
          <div class="alert alert-info">‚ÑπÔ∏è Page accessible via le lien envoy√© par email.</div>
          <h2 style="margin-bottom:16px;color:#3270AF;">Attestation de formation</h2>
          <div class="info-display" id="infoFormation">
            <p style="text-align:center;color:#666;">En attente du lien personnalis√©‚Ä¶</p>
          </div>

          <form id="satisfactionForm" style="display:none;">
            <h3 style="margin:24px 0 14px;color:#3270AF;">üìã Enqu√™te de satisfaction</h3>

            <div class="form-group">
              <label>La formation a-t-elle r√©pondu √† vos attentes ? *</label>
              <div class="stars" id="q1Stars"></div>
              <input type="hidden" id="q1" required>
            </div>

            <div class="form-group">
              <label>Les objectifs √©taient-ils clairs et bien expliqu√©s ? *</label>
              <div class="stars" id="q2Stars"></div>
              <input type="hidden" id="q2" required>
            </div>

            <div class="form-group">
              <label>Le formateur a-t-il su rendre la session claire et adapt√©e ? *</label>
              <div class="stars" id="q3Stars"></div>
              <input type="hidden" id="q3" required>
            </div>

            <div class="form-group">
              <label>Vous sentez-vous √† pr√©sent √† l'aise ? *</label>
              <div class="radio-group">
                <label class="radio-item"><input type="radio" name="q4" value="Pas du tout" required><span>Pas du tout</span></label>
                <label class="radio-item"><input type="radio" name="q4" value="Un peu" required><span>Un peu</span></label>
                <label class="radio-item"><input type="radio" name="q4" value="Moyennement" required><span>Moyennement</span></label>
                <label class="radio-item"><input type="radio" name="q4" value="Assez" required><span>Assez</span></label>
                <label class="radio-item"><input type="radio" name="q4" value="Tout √† fait" required><span>Tout √† fait</span></label>
              </div>
            </div>

            <div class="form-group">
              <label>Comment jugez-vous la dur√©e ? *</label>
              <div class="radio-group">
                <label class="radio-item"><input type="radio" name="q5" value="Trop courte" required><span>Trop courte</span></label>
                <label class="radio-item"><input type="radio" name="q5" value="Adapt√©e" required><span>Adapt√©e</span></label>
                <label class="radio-item"><input type="radio" name="q5" value="Trop longue" required><span>Trop longue</span></label>
              </div>
            </div>

            <div class="form-group">
              <label>Suggestions</label>
              <textarea id="q6" maxlength="100" rows="3" placeholder="Maximum 100 caract√®res"></textarea>
              <small style="color:#666;">Caract√®res restants: <span id="q6Count">100</span></small>
            </div>

            <div class="form-group">
              <label>Un dernier commentaire ?</label>
              <textarea id="q7" maxlength="100" rows="3" placeholder="Maximum 100 caract√®res"></textarea>
              <small style="color:#666;">Caract√®res restants: <span id="q7Count">100</span></small>
            </div>

            <button type="submit" class="btn" style="background:#198754">üì§ Envoyer mon √©valuation</button>
          </form>

          <div id="thankYouMessage" style="display:none;"></div>
        </div>
      </div>

      <div class="version-info" style="margin-top:24px;text-align:center;color:#666;">
        <div class="version-number">Version 2.5.14</div>
        <div class="version-date">12 novembre 2025</div>
        <div class="copyright">¬© 2025 WeN√©goce ‚Äî Tous droits r√©serv√©s</div>
      </div>
    </div>
  </div>

  <!-- Modale email -->
  <div id="emailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úèÔ∏è Modifier l'email</h3>
        <button class="btn-icon" onclick="closeEmailModal()" style="color:white;">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Objet *</label>
          <input type="text" id="emailSubjectEdit" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
        </div>
        <div class="form-group">
          <label>Corps *</label>
          <textarea id="emailBodyEdit" rows="10" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;"></textarea>
        </div>
        <div style="text-align:right;margin-top:12px;">
          <button class="btn" onclick="saveEmailChanges()">‚úì Termin√©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modale relance -->
  <div id="reminderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üìß Relancer le stagiaire</h3>
        <button class="btn-icon" onclick="closeReminderModal()" style="color:white;">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="reminderInfo" class="info-display" style="margin-bottom:12px;"></div>
        <div class="form-group">
          <label>Objet *</label>
          <input type="text" id="reminderSubjectEdit" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;">
        </div>
        <div class="form-group">
          <label>Corps *</label>
          <textarea id="reminderBodyEdit" rows="10" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;"></textarea>
        </div>
        <div class="alert alert-info" style="margin-top:10px;">‚ÑπÔ∏è Le lien personnalis√© remplace [LIEN]</div>
        <div style="text-align:right;margin-top:12px;">
          <button class="btn btn-secondary" onclick="closeReminderModal()" style="margin-right:8px;">Annuler</button>
          <button class="btn" onclick="sendReminder()">üìß Envoyer</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>