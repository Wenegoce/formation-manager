<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation Manager - WeN√©goce</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #F3FEFF 0%, #57976E 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: white;
            color: #333;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            border-bottom: 3px solid #3270AF;
        }

        .header-logo {
            flex-shrink: 0;
        }

        .header-logo img {
            height: 60px;
            width: auto;
        }

        .header-content {
            flex-grow: 1;
            text-align: right;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #3270AF;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            background: transparent;
            color: #666;
        }

        .tab.active {
            background: white;
            color: #3270AF;
            border-bottom: 3px solid #3270AF;
        }

        .tab:hover:not(.active) {
            background: #ebebeb;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3270AF;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stagiaire-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #3270AF;
        }

        .stagiaire-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stagiaire-number {
            background: #3270AF;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn {
            background: #3270AF;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            background: #265a8f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(50,112,175,0.3);
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Styles pour la validation des champs */
        .input-valid {
            border-color: #28a745 !important;
        }

        .input-invalid {
            border-color: #dc3545 !important;
        }

        .error-message {
            color: #dc3545;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .stars {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .star {
            font-size: 32px;
            cursor: pointer;
            color: #ddd;
            transition: color 0.2s;
        }

        .star.active, .star:hover {
            color: #ffc107;
        }

        .info-display {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3270AF;
        }

        .info-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            padding: 8px 0;
            border-bottom: 1px solid #cce5ff;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #3270AF;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: auto;
        }

        .switch-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .switch-label {
            font-weight: 600;
            color: #999;
            min-width: 110px;
            transition: color 0.3s;
        }

        .switch-label.active {
            color: #3270AF;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3270AF;
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .radio-item:has(input[type="radio"]:checked) {
            background-color: #3270AF !important;
            color: white !important;
            border-color: #3270AF !important;
        }

        .radio-item input[type="radio"]:checked {
            accent-color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #3270AF 0%, #265a8f 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }

        .modal-body {
            padding: 30px;
        }

        .btn-icon {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 24px;
            padding: 5px 10px;
            transition: transform 0.2s;
        }

        .btn-icon:hover {
            transform: scale(1.1);
        }

        .btn-edit {
            background: #3270AF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-edit:hover {
            background: #265a8f;
            transform: translateY(-2px);
        }

        /* Optimisations Mobile */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 8px;
            }

            .header {
                flex-direction: column;
                text-align: center;
                padding: 15px;
            }

            .header-logo img {
                height: 50px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 12px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                padding: 12px;
                font-size: 14px;
            }

            .content {
                padding: 15px;
            }

            /* Colonnes en ligne unique sur mobile */
            .row {
                grid-template-columns: 1fr;
                gap: 0;
            }

            /* Boutons backup/purge en colonne sur mobile */
            #export .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            #export > div[style*="grid"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            /* Liste formations : bouton de t√©l√©chargement en dessous sur mobile */
            .info-display {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            .info-display button {
                margin-top: 10px;
                width: 100%;
            }

            /* Augmenter la taille des champs tactiles */
            input, select, textarea {
                padding: 14px;
                font-size: 16px;
                min-height: 48px;
            }

            /* Boutons plus grands */
            .btn {
                padding: 16px 24px;
                font-size: 16px;
                width: 100%;
                margin-top: 15px;
            }

            .btn-secondary {
                margin-left: 0;
                margin-top: 10px;
            }

            .btn-remove {
                padding: 8px 14px;
                font-size: 14px;
            }

            /* Switch plus grand */
            .switch {
                width: 70px;
                height: 38px;
            }

            .switch-label {
                font-size: 14px;
                min-width: 90px;
            }

            .slider:before {
                height: 30px;
                width: 30px;
            }

            input:checked + .slider:before {
                transform: translateX(32px);
            }

            /* √âtoiles plus grandes */
            .star {
                font-size: 40px;
            }

            /* Radio items plus espac√©s */
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            .radio-item {
                padding: 12px 16px !important;
                width: 100%;
                justify-content: center;
            }

            /* Info display adapt√© */
            .info-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .info-label {
                font-weight: 700;
                margin-bottom: 2px;
            }

            /* Stagiaire items */
            .stagiaire-item {
                padding: 12px;
            }

            .stagiaire-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            /* Modal plein √©cran sur mobile */
            .modal-content {
                width: 95%;
                margin: 2% auto;
                max-height: 95vh;
                overflow-y: auto;
            }

            .modal-header {
                padding: 15px 20px;
            }

            .modal-header h3 {
                font-size: 18px;
            }

            .modal-body {
                padding: 20px;
            }

            /* Alert */
            .alert {
                padding: 12px;
                font-size: 14px;
            }

            /* Titres */
            h2 {
                font-size: 20px !important;
            }

            h3 {
                font-size: 18px !important;
            }

            h4 {
                font-size: 16px !important;
            }

            /* Formulaire de satisfaction */
            #satisfactionForm .form-group {
                margin-bottom: 25px;
            }

            /* Bouton test et envoi */
            .btn-edit {
                padding: 10px 14px;
                font-size: 13px;
            }

            /* Switch container */
            .switch-container {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            /* Petits textes plus lisibles */
            small {
                font-size: 13px !important;
            }

            /* Espacement des sections */
            .form-group {
                margin-bottom: 25px;
            }
        }

        /* Tr√®s petits √©crans (moins de 400px) */
        @media screen and (max-width: 400px) {
            .header h1 {
                font-size: 18px;
            }

            .tab {
                font-size: 12px;
                padding: 10px;
            }

            .btn {
                font-size: 14px;
                padding: 14px 20px;
            }

            .star {
                font-size: 36px;
                gap: 8px;
            }

            .stars {
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-logo">
                <img src="https://back.wenegoce.fr/uploads/0406_Logo_We_Negoce_avec_We_Soft_DEFINITIF_502368ceeb.png" alt="WeN√©goce">
            </div>
            <div class="header-content">
                <h1>Formation Manager</h1>
                <p>Suivi des pr√©sences et enqu√™te de satisfaction stagiaires</p>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="formateur">üë®‚Äçüè´ Espace Formateur</button>
            <button class="tab" data-tab="stagiaire">üë§ Espace Stagiaire</button>
            <button class="tab" data-tab="settings">‚öôÔ∏è Param√®tres</button>
            <button class="tab" data-tab="export">üì¶ Backup & Export</button>
        </div>

        <div class="content">
            <div id="formateur" class="tab-content active">
                <h2 style="margin-bottom: 20px; color: #3270AF;">Pr√©paration de la formation</h2>
                
                <div id="preparationForm">
                    <form id="formateurForm">
                        <div class="form-group">
                            <label>Raison sociale du client *</label>
                            <input type="text" id="raisonSociale" required>
                        </div>

                        <div class="form-group">
                            <label>Th√®me de la formation *</label>
                            <input type="text" id="themeFormation" required>
                        </div>

                        <div class="form-group">
                            <label>R√©f√©rence JIRA</label>
                            <input type="text" id="referenceJira" placeholder="TIC-123, SMC-456 ou SNC-789">
                            <small style="color: #999; font-size: 12px;">Format : TIC-, SMC- ou SNC- suivi d'un num√©ro (optionnel)</small>
                        </div>

                        <div class="row">
                            <div class="form-group">
                                <label>Nom du formateur *</label>
                                <input type="text" id="nomFormateur" required>
                            </div>
                            <div class="form-group">
                                <label>Email du formateur *</label>
                                <input type="text" id="emailFormateur" required placeholder="exemple@domaine.fr">
                                <small style="color: #999; font-size: 12px;">Format : nom@domaine.extension</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group">
                                <label>Date de la formation *</label>
                                <input type="date" id="dateFormation" required>
                            </div>
                            <div class="form-group">
                                <label>Type de formation *</label>
                                <div class="switch-container">
                                    <span class="switch-label active" id="labelPresentiel">üè¢ Pr√©sentiel</span>
                                    <label class="switch">
                                        <input type="checkbox" id="typeFormationToggle">
                                        <span class="slider"></span>
                                    </label>
                                    <span class="switch-label" id="labelVisio">üíª Visio</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="form-group">
                                <label>Heure de d√©but *</label>
                                <input type="time" id="heureDebut" required>
                            </div>
                            <div class="form-group">
                                <label>Heure de fin *</label>
                                <input type="time" id="heureFin" required>
                            </div>
                        </div>

                        <h3 style="margin: 30px 0 15px; color: #3270AF;">Liste des stagiaires</h3>
                        
                        <div id="stagiairesList"></div>

                        <button type="button" class="btn btn-secondary" id="btnAddStagiaire">
                            ‚ûï Ajouter un stagiaire
                        </button>

                        <div style="margin-top: 30px;">
                            <button type="submit" class="btn">üìù Enregistrer la formation</button>
                        </div>
                    </form>
                </div>

                <div id="postFormationSection" style="display: none;">
                    <div class="alert alert-info">
                        ‚ÑπÔ∏è <strong>Formation enregistr√©e !</strong> Une fois la formation termin√©e, compl√©tez la pr√©sence de chaque stagiaire ci-dessous.
                    </div>

                    <div id="formationInfo" class="info-display" style="margin-bottom: 30px;"></div>

                    <h3 style="margin-bottom: 20px; color: #3270AF;">Compl√©ter les pr√©sences</h3>
                    
                    <form id="presenceForm">
                        <div id="presenceList"></div>
                        <div style="margin-top: 30px;">
                            <button type="submit" class="btn">üìß G√©n√©rer et envoyer les liens stagiaires</button>
                        </div>
                    </form>
                </div>

                <div id="linksGenerated" style="display: none; margin-top: 30px;">
                    <div class="alert alert-success">
                        ‚úÖ Les liens ont √©t√© g√©n√©r√©s avec succ√®s ! Vous pouvez maintenant envoyer les emails aux stagiaires.
                    </div>
                    <div id="emailLinks"></div>
                </div>
            </div>

            <div id="stagiaire" class="tab-content">
                <div id="stagiaireView">
                    <div class="alert alert-info">
                        ‚ÑπÔ∏è Cette page est accessible via le lien envoy√© par email par votre formateur.
                    </div>

                    <h2 style="margin-bottom: 20px; color: #3270AF;">Attestation de formation</h2>
                    
                    <div class="info-display" id="infoFormation">
                        <p style="text-align: center; color: #666;">En attente du lien personnalis√©...</p>
                    </div>

                    <form id="satisfactionForm" style="display: none;">
                        <h3 style="margin: 30px 0 20px; color: #3270AF;">üìã Enqu√™te de satisfaction</h3>

                        <div class="form-group">
                            <label>La formation a-t-elle r√©pondu √† vos attentes ? *</label>
                            <div class="stars" id="q1Stars"></div>
                            <input type="hidden" id="q1" required>
                        </div>

                        <div class="form-group">
                            <label>Les objectifs de la formation √©taient-ils clairs et bien expliqu√©s ? *</label>
                            <div class="stars" id="q2Stars"></div>
                            <input type="hidden" id="q2" required>
                        </div>

                        <div class="form-group">
                            <label>Le formateur a-t-il su rendre la session claire, dynamique et adapt√©e √† votre niveau ? *</label>
                            <div class="stars" id="q3Stars"></div>
                            <input type="hidden" id="q3" required>
                        </div>

                        <div class="form-group">
                            <label>Vous sentez-vous √† pr√©sent √† l'aise pour utiliser les fonctions pr√©sent√©es lors de cette formation ? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="q4" value="Pas du tout" required> Pas du tout
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="q4" value="Un peu"> Un peu
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="q4" value="Moyennement"> Moyennement
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="q4" value="Assez"> Assez
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="q4" value="Tout √† fait"> Tout √† fait
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Comment jugez-vous la dur√©e de la formation ? *</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="q5" value="Trop courte" required> Trop courte
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="q5" value="Adapt√©e"> Adapt√©e
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="q5" value="Trop longue"> Trop longue
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Quelles sont vos suggestions pour am√©liorer cette formation ?</label>
                            <textarea id="q6" maxlength="100" rows="3" placeholder="Maximum 100 caract√®res"></textarea>
                            <small style="color: #666;">Caract√®res restants: <span id="q6Count">100</span></small>
                        </div>

                        <div class="form-group">
                            <label>Un dernier commentaire ?</label>
                            <textarea id="q7" maxlength="100" rows="3" placeholder="Maximum 100 caract√®res"></textarea>
                            <small style="color: #666;">Caract√®res restants: <span id="q7Count">100</span></small>
                        </div>

                        <button type="submit" class="btn btn-success">üì§ Envoyer mon √©valuation</button>
                    </form>

                    <div id="thankYouMessage" style="display: none;"></div>
                </div>
            </div>

            <div id="export" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #3270AF;">üì¶ Backup & Export</h2>
                
                <div class="alert alert-info">
                    ‚ÑπÔ∏è <strong>Envoi automatique √† SharePoint activ√©</strong><br>
                    Les donn√©es sont automatiquement envoy√©es √† SharePoint via webhook apr√®s chaque √©valuation stagiaire.<br>
                    Cet onglet vous permet de cr√©er un export de secours et de g√©rer vos donn√©es locales.
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                    <button class="btn btn-success" id="btnExport">
                        üì• T√©l√©charger tous les backups Excel
                    </button>
                    
                    <button class="btn" style="background: #ff6b6b;" id="btnPurge" onclick="purgeOldFormations()">
                        üóëÔ∏è Purger formations > 13 mois
                    </button>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="color: #3270AF; margin-bottom: 15px;">Formations enregistr√©es localement</h3>
                    <div id="formationsList"></div>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #3270AF;">‚öôÔ∏è Param√®tres & Configuration Power Automate</h2>
                
                <div class="alert alert-info">
                    ‚ÑπÔ∏è Configurez ici votre int√©gration Power Automate pour envoyer automatiquement les donn√©es vers SharePoint.
                </div>

                <div style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #3270AF; margin-bottom: 15px;">üîó Configuration du Webhook</h3>
                    
                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e9ecef;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">URL du Webhook Power Automate :</label>
                        <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #dee2e6; font-family: 'Courier New', monospace; font-size: 12px; word-break: break-all; margin-bottom: 10px;" id="webhookDisplay">Non configur√©e</div>
                        <button class="btn btn-secondary" onclick="copyWebhookURL()" style="margin: 0;">üìã Copier l'URL</button>
                    </div>

                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e9ecef;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Changer l'URL du Webhook :</label>
                        <textarea id="webhookInput" placeholder="https://prod-xxx.centralus.logic.azure.com/..." rows="3" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 12px; font-family: 'Courier New', monospace;"></textarea>
                        <button class="btn" onclick="updateWebhookURL()" style="margin-top: 10px;">üíæ Enregistrer l'URL</button>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 600;">
                            <input type="checkbox" id="enableSharePointSync" onchange="toggleSync()" style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Activer la synchronisation SharePoint</span>
                        </label>
                        <p style="font-size: 13px; color: #666; margin-top: 8px;">Les √©valuations seront automatiquement envoy√©es vers votre liste SharePoint.</p>
                    </div>
                </div>

                <div style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                    <h3 style="color: #3270AF; margin-bottom: 15px;">üìä Donn√©es & Stockage</h3>
                    
                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e9ecef;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Formations enregistr√©es :</label>
                        <div style="color: #666;"><strong id="formationCount">0</strong> formation(s)</div>
                        <p style="font-size: 13px; color: #999; margin-top: 8px;">üí° Pour g√©rer vos donn√©es, rendez-vous dans l'onglet "Backup & Export"</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Modifier l'email</h3>
                <button class="btn-icon" onclick="closeEmailModal()" style="color: white;">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Objet de l'email *</label>
                    <input type="text" id="emailSubjectEdit" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Corps du message *</label>
                    <textarea id="emailBodyEdit" rows="12" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: 'Segoe UI', sans-serif; line-height: 1.6;"></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn" onclick="saveEmailChanges()">
                        ‚úì Termin√©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let stagiaireCount = 0;
        let formationsData = [];
        let currentFormationId = null;
        const MAX_STAGIAIRES = 10;
        let emailSubjectGlobal = '';
        let emailBodyGlobal = '';
        let currentFormationData = null;
        
        // Webhook Power Automate - R√©cup√©r√© depuis localStorage
        let WEBHOOK_URL = localStorage.getItem('wenegoce_webhook') || '';
        let ENABLE_SHAREPOINT_SYNC = localStorage.getItem('wenegoce_sync_enabled') === 'true';

        document.addEventListener('DOMContentLoaded', function() {
            loadFormations();
            addStagiaire();
            initStarRatings();
            initCharCounters();
            checkURLParams();
            initEventListeners();
            initTypeFormationToggle();
            initializeSettings();
        });

        function initEventListeners() {
            document.querySelectorAll('.tab').forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });

            const btnAdd = document.getElementById('btnAddStagiaire');
            if (btnAdd) {
                btnAdd.addEventListener('click', function(e) {
                    e.preventDefault();
                    addStagiaire();
                });
            }

            const formateurForm = document.getElementById('formateurForm');
            if (formateurForm) {
                formateurForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleFormateurSubmit();
                });
            }

            const champsObligatoires = [
                'raisonSociale',
                'themeFormation',
                'nomFormateur',
                'dateFormation',
                'heureDebut',
                'heureFin'
            ];

            champsObligatoires.forEach(function(fieldId) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        validateRequiredField(this);
                    });
                    field.addEventListener('input', function() {
                        if (this.value.trim()) {
                            this.style.borderColor = '#e0e0e0';
                            this.style.backgroundColor = 'white';
                        }
                    });
                }
            });

            const heureDebut = document.getElementById('heureDebut');
            const heureFin = document.getElementById('heureFin');
            
            if (heureDebut) {
                heureDebut.addEventListener('change', function() {
                    validateHeures();
                });
            }
            
            if (heureFin) {
                heureFin.addEventListener('change', function() {
                    validateHeures();
                });
                heureFin.addEventListener('blur', function() {
                    validateHeures();
                });
            }

            const dateFormationInput = document.getElementById('dateFormation');
            if (dateFormationInput) {
                dateFormationInput.addEventListener('change', function() {
                    validateDateFormation(this);
                });
                dateFormationInput.addEventListener('blur', function() {
                    validateDateFormation(this);
                });
                dateFormationInput.addEventListener('input', function() {
                    resetFieldStyle(this);
                });
            }

            const emailFormateurInput = document.getElementById('emailFormateur');
            if (emailFormateurInput) {
                emailFormateurInput.addEventListener('blur', function() {
                    validateEmailField(this);
                });
                emailFormateurInput.addEventListener('input', function() {
                    resetFieldStyle(this);
                });
            }

            const referenceJiraInput = document.getElementById('referenceJira');
            if (referenceJiraInput) {
                referenceJiraInput.addEventListener('blur', function() {
                    validateJiraReference(this);
                });
                referenceJiraInput.addEventListener('input', function() {
                    resetFieldStyle(this);
                });
            }

            const presenceForm = document.getElementById('presenceForm');
            if (presenceForm) {
                presenceForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handlePresenceSubmit();
                });
            }

            const satisfactionForm = document.getElementById('satisfactionForm');
            if (satisfactionForm) {
                satisfactionForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleSatisfactionSubmit();
                });
            }

            const btnExport = document.getElementById('btnExport');
            if (btnExport) {
                btnExport.addEventListener('click', exportToExcel);
            }

            window.onclick = function(event) {
                const modal = document.getElementById('emailModal');
                if (event.target == modal) {
                    closeEmailModal();
                }
            }
        }

        function initTypeFormationToggle() {
            const toggle = document.getElementById('typeFormationToggle');
            const labelPresentiel = document.getElementById('labelPresentiel');
            const labelVisio = document.getElementById('labelVisio');

            if (toggle) {
                toggle.addEventListener('change', function() {
                    if (this.checked) {
                        labelPresentiel.classList.remove('active');
                        labelVisio.classList.add('active');
                    } else {
                        labelPresentiel.classList.add('active');
                        labelVisio.classList.remove('active');
                    }
                });
            }
        }

        function getTypeFormation() {
            const toggle = document.getElementById('typeFormationToggle');
            return toggle && toggle.checked ? 'Visioconf√©rence' : 'Pr√©sentiel';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'export') {
                displayFormationsList();
            }
        }

        // Fonction pour afficher un message d'erreur sous un champ
        function showError(input, message) {
            // Retirer les anciens messages d'erreur
            clearError(input);
            
            // Bordure rouge
            input.classList.add('input-invalid');
            input.classList.remove('input-valid');
            
            // Cr√©er le message d'erreur
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message show';
            errorDiv.textContent = message;
            
            // Ins√©rer apr√®s le champ (ou apr√®s le small si pr√©sent)
            const nextElement = input.nextElementSibling;
            if (nextElement && nextElement.tagName === 'SMALL') {
                nextElement.parentNode.insertBefore(errorDiv, nextElement.nextSibling);
            } else {
                input.parentNode.insertBefore(errorDiv, nextElement);
            }
            
            // Vider le champ
            input.value = '';
            
            // Mettre le focus sur le champ
            input.focus();
        }
        
        // Fonction pour effacer un message d'erreur
        function clearError(input) {
            input.classList.remove('input-invalid');
            const errorMsg = input.parentNode.querySelector('.error-message');
            if (errorMsg) {
                errorMsg.remove();
            }
        }
        
        // Fonction pour valider un champ (bordure verte)
        function markValid(input) {
            clearError(input);
            input.classList.add('input-valid');
            input.classList.remove('input-invalid');
        }
        
        // Fonction pour r√©initialiser un champ
        function resetFieldStyle(input) {
            input.classList.remove('input-valid', 'input-invalid');
            clearError(input);
        }

        function addStagiaire() {
            if (stagiaireCount >= MAX_STAGIAIRES) {
                // Pas d'alert, juste ne rien faire et d√©sactiver le bouton
                document.getElementById('btnAddStagiaire').style.display = 'none';
                return;
            }

            stagiaireCount++;
            const container = document.getElementById('stagiairesList');
            const div = document.createElement('div');
            div.className = 'stagiaire-item';
            div.id = 'stagiaire-' + stagiaireCount;
            div.innerHTML = `
                <div class="stagiaire-header">
                    <span class="stagiaire-number">Stagiaire ${stagiaireCount}</span>
                    <button type="button" class="btn-remove" data-stagiaire-id="${stagiaireCount}">‚úï Supprimer</button>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>Nom et Pr√©nom *</label>
                        <input type="text" id="nom-${stagiaireCount}" required class="required-field">
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="text" id="email-${stagiaireCount}" required placeholder="exemple@domaine.fr" class="email-stagiaire">
                        <small style="color: #999; font-size: 12px;">Format : nom@domaine.extension</small>
                    </div>
                </div>
            `;
            container.appendChild(div);

            const btnRemove = div.querySelector('.btn-remove');
            btnRemove.addEventListener('click', function() {
                removeStagiaire(this.getAttribute('data-stagiaire-id'));
            });

            const nomInput = div.querySelector('#nom-' + stagiaireCount);
            if (nomInput) {
                nomInput.addEventListener('blur', function() {
                    validateRequiredField(this);
                });
                nomInput.addEventListener('input', function() {
                    if (this.value.trim()) {
                        resetFieldStyle(this);
                    }
                });
            }

            const emailInput = div.querySelector('.email-stagiaire');
            if (emailInput) {
                emailInput.addEventListener('blur', function() {
                    validateEmailField(this);
                });
                emailInput.addEventListener('input', function() {
                    resetFieldStyle(this);
                });
            }

            if (stagiaireCount >= MAX_STAGIAIRES) {
                document.getElementById('btnAddStagiaire').style.display = 'none';
            }
        }

        function removeStagiaire(id) {
            const element = document.getElementById('stagiaire-' + id);
            if (element) {
                element.remove();
                stagiaireCount--;
                document.getElementById('btnAddStagiaire').style.display = 'inline-block';
            }
        }

        function validateRequiredField(input) {
            const value = input.value.trim();
            
            if (!value) {
                const label = input.previousElementSibling ? input.previousElementSibling.textContent.replace(' *', '') : 'Ce champ';
                showError(input, label + ' est obligatoire');
                return false;
            } else {
                markValid(input);
                return true;
            }
        }

        function validateHeures() {
            const heureDebut = document.getElementById('heureDebut');
            const heureFin = document.getElementById('heureFin');
            
            if (!heureDebut.value || !heureFin.value) {
                return true;
            }
            
            if (heureFin.value <= heureDebut.value) {
                showError(heureFin, 'L\'heure de fin (' + heureFin.value + ') doit √™tre post√©rieure √† l\'heure de d√©but (' + heureDebut.value + ')');
                return false;
            } else {
                markValid(heureDebut);
                markValid(heureFin);
                return true;
            }
        }

        function validateDateFormation(input) {
            const dateValue = input.value;
            
            if (!dateValue) {
                return true; // La validation du champ vide est g√©r√©e ailleurs
            }
            
            const selectedDate = new Date(dateValue);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset l'heure pour comparer juste les dates
            
            // Calculer la date minimum (7 jours avant aujourd'hui)
            const minDate = new Date(today);
            minDate.setDate(today.getDate() - 7);
            
            // La date ne doit pas √™tre ant√©rieure de plus de 7 jours
            if (selectedDate < minDate) {
                const minDateStr = minDate.toLocaleDateString('fr-FR');
                showError(input, 'La formation est trop ancienne. Date minimum accept√©e : ' + minDateStr);
                return false;
            } else {
                markValid(input);
                return true;
            }
        }

        function validateJiraReference(input) {
            const value = input.value.trim();
            
            if (!value) {
                resetFieldStyle(input);
                return true;
            }
            
            const validPrefixes = ['TIC-', 'SMC-', 'SNC-'];
            const hasValidPrefix = validPrefixes.some(prefix => value.toUpperCase().startsWith(prefix));
            
            if (!hasValidPrefix) {
                showError(input, 'La r√©f√©rence JIRA doit commencer par TIC-, SMC- ou SNC- (Exemples : TIC-123, SMC-456, SNC-789)');
                return false;
            }
            
            const parts = value.split('-');
            if (parts.length < 2 || !parts[1] || parts[1].trim() === '') {
                showError(input, 'La r√©f√©rence JIRA doit avoir un num√©ro apr√®s le pr√©fixe (Exemples : TIC-123, SMC-456, SNC-789)');
                return false;
            }
            
            markValid(input);
            return true;
        }

        function validateEmailField(input) {
            const email = input.value.trim();
            
            if (!email) {
                showError(input, 'L\'adresse email est obligatoire');
                return false;
            }
            
            if (!isValidEmail(email)) {
                showError(input, 'Email invalide (Format attendu : nom@domaine.fr)');
                return false;
            } else {
                markValid(input);
                return true;
            }
        }

        function isValidEmail(email) {
            if (!email || email.includes(' ')) return false;
            
            const parts = email.split('@');
            if (parts.length !== 2) return false;
            
            const localPart = parts[0];
            const domainPart = parts[1];
            
            if (!localPart || !domainPart) return false;
            
            const domainParts = domainPart.split('.');
            if (domainParts.length < 2) return false;
            
            const extension = domainParts[domainParts.length - 1];
            if (!extension || extension.length < 2) return false;
            
            for (let part of domainParts) {
                if (!part || part.length === 0) return false;
            }
            
            return true;
        }

        function handleFormateurSubmit() {
            const champsObligatoires = [
                { id: 'raisonSociale', nom: 'Raison sociale du client' },
                { id: 'themeFormation', nom: 'Th√®me de la formation' },
                { id: 'nomFormateur', nom: 'Nom du formateur' },
                { id: 'dateFormation', nom: 'Date de la formation' },
                { id: 'heureDebut', nom: 'Heure de d√©but' },
                { id: 'heureFin', nom: 'Heure de fin' }
            ];

            let hasError = false;
            for (let champ of champsObligatoires) {
                const input = document.getElementById(champ.id);
                if (!input.value.trim()) {
                    showError(input, champ.nom + ' est obligatoire');
                    hasError = true;
                    break; // Arr√™ter √† la premi√®re erreur
                }
            }
            
            if (hasError) return;

            if (!validateHeures()) {
                return;
            }

            // Valider la date de formation
            const dateFormationInput = document.getElementById('dateFormation');
            if (!validateDateFormation(dateFormationInput)) {
                return;
            }

            const referenceJiraInput = document.getElementById('referenceJira');
            if (referenceJiraInput.value.trim() && !validateJiraReference(referenceJiraInput)) {
                return;
            }

            const emailFormateur = document.getElementById('emailFormateur').value.trim();
            const emailFormateurInput = document.getElementById('emailFormateur');
            
            if (!emailFormateur) {
                showError(emailFormateurInput, 'L\'email du formateur est obligatoire');
                return;
            }
            
            if (!isValidEmail(emailFormateur)) {
                showError(emailFormateurInput, 'L\'adresse email du formateur n\'est pas valide (Exemple : nom@domaine.fr)');
                return;
            }

            const formation = {
                id: Date.now(),
                raisonSociale: document.getElementById('raisonSociale').value.trim(),
                theme: document.getElementById('themeFormation').value.trim(),
                referenceJira: referenceJiraInput.value.trim().toUpperCase() || null,
                nomFormateur: document.getElementById('nomFormateur').value.trim(),
                emailFormateur: emailFormateur,
                date: document.getElementById('dateFormation').value,
                heureDebut: document.getElementById('heureDebut').value,
                heureFin: document.getElementById('heureFin').value,
                type: getTypeFormation(),
                stagiaires: []
            };

            for (let i = 1; i <= MAX_STAGIAIRES; i++) {
                const nomInput = document.getElementById('nom-' + i);
                if (nomInput && nomInput.value.trim()) {
                    const emailInput = document.getElementById('email-' + i);
                    const nom = nomInput.value.trim();
                    const email = emailInput.value.trim();
                    
                    if (!email) {
                        showError(emailInput, 'L\'email du stagiaire "' + nom + '" est obligatoire');
                        return;
                    }
                    
                    if (!isValidEmail(email)) {
                        showError(emailInput, 'L\'adresse email du stagiaire "' + nom + '" n\'est pas valide (Exemple : nom@domaine.fr)');
                        return;
                    }
                    
                    formation.stagiaires.push({
                        nom: nom,
                        email: email,
                        presence: null,
                        commentaire: '',
                        satisfaction: null
                    });
                }
            }

            if (formation.stagiaires.length === 0) {
                // Cr√©er un message d'erreur global au-dessus du bouton "Ajouter un stagiaire"
                const stagiairesList = document.getElementById('stagiairesList');
                const existingAlert = stagiairesList.parentNode.querySelector('.alert-warning');
                if (!existingAlert) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning';
                    alertDiv.style.background = '#fff3cd';
                    alertDiv.style.color = '#856404';
                    alertDiv.style.border = '1px solid #ffeaa7';
                    alertDiv.innerHTML = '‚ö†Ô∏è Veuillez ajouter au moins un stagiaire';
                    stagiairesList.parentNode.insertBefore(alertDiv, stagiairesList);
                    
                    // Supprimer l'alerte apr√®s 5 secondes
                    setTimeout(() => alertDiv.remove(), 5000);
                }
                return;
            }

            formationsData.push(formation);
            currentFormationId = formation.id;
            saveFormations();

            showPostFormationSection(formation);
        }

        function showPostFormationSection(formation) {
            document.getElementById('preparationForm').style.display = 'none';
            document.getElementById('postFormationSection').style.display = 'block';

            document.getElementById('formationInfo').innerHTML = `
                <div class="info-row"><div class="info-label">Client :</div><div>${formation.raisonSociale}</div></div>
                <div class="info-row"><div class="info-label">Formation :</div><div>${formation.theme}</div></div>
                ${formation.referenceJira ? '<div class="info-row"><div class="info-label">R√©f√©rence JIRA :</div><div>' + formation.referenceJira + '</div></div>' : ''}
                <div class="info-row"><div class="info-label">Formateur :</div><div>${formation.nomFormateur}</div></div>
                <div class="info-row"><div class="info-label">Date :</div><div>${new Date(formation.date).toLocaleDateString('fr-FR')}</div></div>
                <div class="info-row"><div class="info-label">Horaires :</div><div>${formation.heureDebut} - ${formation.heureFin}</div></div>
                <div class="info-row"><div class="info-label">Type :</div><div>${formation.type}</div></div>
                <div class="info-row"><div class="info-label">Nombre de stagiaires :</div><div>${formation.stagiaires.length}</div></div>
            `;

            const presenceList = document.getElementById('presenceList');
            presenceList.innerHTML = '';

            formation.stagiaires.forEach((stagiaire, index) => {
                const div = document.createElement('div');
                div.className = 'stagiaire-item';
                div.innerHTML = `
                    <div class="stagiaire-header">
                        <span class="stagiaire-number">${stagiaire.nom}</span>
                    </div>
                    <div class="form-group">
                        <label>Pr√©sence *</label>
                        <div class="radio-group" style="margin-top: 10px;">
                            <label class="radio-item" style="padding: 10px 15px; background: #f8f9fa; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0;">
                                <input type="radio" name="presence-post-${index}" value="Oui" required> ‚úÖ Oui
                            </label>
                            <label class="radio-item" style="padding: 10px 15px; background: #f8f9fa; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0;">
                                <input type="radio" name="presence-post-${index}" value="Non"> ‚ùå Non
                            </label>
                            <label class="radio-item" style="padding: 10px 15px; background: #f8f9fa; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0;">
                                <input type="radio" name="presence-post-${index}" value="Partielle"> ‚ö†Ô∏è Partielle
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Commentaire</label>
                        <input type="text" id="commentaire-post-${index}" maxlength="150" placeholder="Optionnel (max 150 caract√®res)">
                        <small style="color: #666;">Caract√®res restants: <span id="commentaire-post-${index}-count">150</span></small>
                    </div>
                `;
                presenceList.appendChild(div);
                
                // Initialiser le compteur de caract√®res pour ce commentaire
                const commentaireInput = div.querySelector('#commentaire-post-' + index);
                if (commentaireInput) {
                    commentaireInput.addEventListener('input', function() {
                        const remaining = 150 - this.value.length;
                        const counter = document.getElementById('commentaire-post-' + index + '-count');
                        if (counter) {
                            counter.textContent = remaining;
                        }
                    });
                }
            });
        }

        function handlePresenceSubmit() {
            const formation = formationsData.find(f => f.id === currentFormationId);
            if (!formation) return;

            let allPresencesFilled = true;
            formation.stagiaires.forEach((stagiaire, index) => {
                const presenceRadio = document.querySelector('input[name="presence-post-' + index + '"]:checked');
                const commentaireInput = document.getElementById('commentaire-post-' + index);
                
                if (presenceRadio) {
                    stagiaire.presence = presenceRadio.value;
                    stagiaire.commentaire = commentaireInput ? commentaireInput.value : '';
                } else {
                    allPresencesFilled = false;
                }
            });

            if (!allPresencesFilled) {
                // Cr√©er un message d'erreur global en haut du formulaire
                const presenceForm = document.getElementById('presenceForm');
                const existingAlert = presenceForm.querySelector('.alert-warning');
                if (!existingAlert) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning';
                    alertDiv.style.background = '#fff3cd';
                    alertDiv.style.color = '#856404';
                    alertDiv.style.border = '1px solid #ffeaa7';
                    alertDiv.innerHTML = '‚ö†Ô∏è Veuillez indiquer la pr√©sence de tous les stagiaires';
                    presenceForm.insertBefore(alertDiv, presenceForm.firstChild);
                    
                    // Supprimer l'alerte apr√®s 5 secondes
                    setTimeout(() => alertDiv.remove(), 5000);
                }
                return;
            }

            saveFormations();
            generateLinks(formation);
            
            document.getElementById('postFormationSection').style.display = 'none';
        }

        function generateLinks(formation) {
            currentFormationData = formation;
            const container = document.getElementById('emailLinks');
            const dateFormation = new Date(formation.date).toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            
            emailSubjectGlobal = 'Votre formation WeN√©goce du ' + dateFormation;
            emailBodyGlobal = 'Bonjour,\n\n' +
                'Vous avez suivi le ' + dateFormation + ' une formation dont le th√®me √©tait ' + formation.theme + ' dispens√©e par ' + formation.nomFormateur + '.\n\n' +
                'En cliquant sur le lien ci-dessous vous aurez une attestation de pr√©sence et nous vous invitons √† r√©pondre √† un rapide questionnaire de satisfaction.\n\n' +
                '[Lien personnalis√©]\n\n' +
                'Nous vous souhaitons une bonne journ√©e,\n\n' +
                'Tr√®s Cordialement\n\n' +
                'L\'√©quipe WeN√©goce';
            
            container.innerHTML = '<h3 style="color: #3270AF; margin-bottom: 15px;">Envoi des liens aux stagiaires</h3>';

            container.innerHTML += `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #3270AF;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #3270AF; margin: 0;">üìß Aper√ßu de l'email</h4>
                        <button class="btn-edit" onclick="openEmailModal()">
                            ‚úèÔ∏è Modifier
                        </button>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;" id="emailPreview">
                        <p style="margin: 0 0 10px 0;"><strong>Objet :</strong> <span id="previewSubject">${emailSubjectGlobal}</span></p>
                        <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 15px 0;">
                        <div style="line-height: 1.6; color: #333; white-space: pre-wrap;" id="previewBody">${emailBodyGlobal}</div>
                    </div>
                </div>
            `;

            // Liste des stagiaires avec boutons individuels
            container.innerHTML += `
                <div style="margin-bottom: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #3270AF;">
                    <strong style="color: #3270AF;">üìß Envoi individuel par stagiaire</strong><br>
                    <small style="color: #666;">Chaque stagiaire recevra un email avec uniquement son lien personnel</small>
                    <div style="margin-top: 15px;" id="individualEmailsList"></div>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <strong style="color: #856404;">üß™ Mode Test</strong><br>
                    <small style="color: #856404;">Testez l'espace stagiaire pour voir ce que vos stagiaires verront</small><br>
                    <button class="btn btn-secondary" style="margin-top: 10px; background: #ffc107; color: #000;" onclick="testStagiaireView()">
                        üëÅÔ∏è Tester en tant que stagiaire
                    </button>
                </div>
            `;

            // Cr√©er la liste des boutons individuels
            const individualList = document.getElementById('individualEmailsList');
            formation.stagiaires.forEach((stagiaire, index) => {
                const link = window.location.origin + window.location.pathname + '?fid=' + formation.id + '&sid=' + index;
                
                const div = document.createElement('div');
                div.style.cssText = 'background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;';
                
                div.innerHTML = `
                    <div>
                        <strong style="color: #333;">${stagiaire.nom}</strong><br>
                        <small style="color: #666;">${stagiaire.email}</small>
                    </div>
                    <button class="btn" style="margin: 0; padding: 10px 20px; font-size: 14px;" onclick="sendIndividualEmail(${index})">
                        üìß Envoyer l'email
                    </button>
                `;
                
                individualList.appendChild(div);
            });

            document.getElementById('linksGenerated').style.display = 'block';
        }

        function testStagiaireView() {
            if (!currentFormationData) {
                // Ne rien faire si pas de formation, le bouton ne devrait pas √™tre visible de toute fa√ßon
                console.log('Aucune formation disponible pour le test');
                return;
            }
            
            switchTab('stagiaire');
            loadStagiaireView(currentFormationData.id, 0);
            window.scrollTo(0, 0);
        }

        function openEmailModal() {
            document.getElementById('emailSubjectEdit').value = emailSubjectGlobal;
            document.getElementById('emailBodyEdit').value = emailBodyGlobal;
            document.getElementById('emailModal').style.display = 'block';
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }

        function saveEmailChanges() {
            emailSubjectGlobal = document.getElementById('emailSubjectEdit').value;
            emailBodyGlobal = document.getElementById('emailBodyEdit').value;
            
            document.getElementById('previewSubject').textContent = emailSubjectGlobal;
            document.getElementById('previewBody').textContent = emailBodyGlobal;
            
            closeEmailModal();
        }

        function sendIndividualEmail(stagiaireIndex) {
            if (!currentFormationData) return;
            
            const formation = currentFormationData;
            const stagiaire = formation.stagiaires[stagiaireIndex];
            
            if (!stagiaire) {
                console.error('Stagiaire introuvable');
                return;
            }
            
            // Cr√©er le lien personnel unique pour ce stagiaire
            const personalLink = window.location.origin + window.location.pathname + '?fid=' + formation.id + '&sid=' + stagiaireIndex;
            
            // Remplacer [Lien personnalis√©] par le lien r√©el
            const emailBodyWithLink = emailBodyGlobal.replace('[Lien personnalis√©]', personalLink);
            
            // Cr√©er le lien mailto pour ce stagiaire UNIQUEMENT
            const mailtoLink = 'mailto:' + stagiaire.email + 
                '?subject=' + encodeURIComponent(emailSubjectGlobal) + 
                '&body=' + encodeURIComponent(emailBodyWithLink);
            
            window.location.href = mailtoLink;
        }

        function checkURLParams() {
            const params = new URLSearchParams(window.location.search);
            const fid = params.get('fid');
            const sid = params.get('sid');

            if (fid && sid) {
                // Mode stagiaire : masquer tous les onglets sauf celui du stagiaire
                document.querySelector('.tabs').style.display = 'none';
                
                // Masquer tous les contenus sauf l'espace stagiaire
                document.getElementById('formateur').style.display = 'none';
                document.getElementById('export').style.display = 'none';
                document.getElementById('settings').style.display = 'none';
                
                // Afficher uniquement l'espace stagiaire
                document.getElementById('stagiaire').classList.add('active');
                document.getElementById('stagiaire').style.display = 'block';
                
                // Charger les donn√©es du stagiaire
                loadStagiaireView(fid, sid);
            }
        }

        function loadStagiaireView(formationId, stagiaireIndex) {
            const formation = formationsData.find(f => f.id == formationId);
            if (!formation) {
                document.getElementById('infoFormation').innerHTML = '<p style="color: #dc3545;">‚ùå Formation introuvable</p>';
                return;
            }

            const stagiaire = formation.stagiaires[stagiaireIndex];
            if (!stagiaire) {
                document.getElementById('infoFormation').innerHTML = '<p style="color: #dc3545;">‚ùå Stagiaire introuvable</p>';
                return;
            }

            currentFormationId = formationId;
            document.getElementById('infoFormation').innerHTML = `
                <div class="info-row"><div class="info-label">Client :</div><div>${formation.raisonSociale}</div></div>
                <div class="info-row"><div class="info-label">Formation :</div><div>${formation.theme}</div></div>
                <div class="info-row"><div class="info-label">Formateur :</div><div>${formation.nomFormateur}</div></div>
                <div class="info-row"><div class="info-label">Date :</div><div>${new Date(formation.date).toLocaleDateString('fr-FR')}</div></div>
                <div class="info-row"><div class="info-label">Horaires :</div><div>${formation.heureDebut} - ${formation.heureFin}</div></div>
                <div class="info-row"><div class="info-label">Type :</div><div>${formation.type}</div></div>
                <div class="info-row"><div class="info-label">Votre pr√©sence :</div><div><strong>${stagiaire.presence || 'Non renseign√©'}</strong></div></div>
                ${stagiaire.commentaire ? '<div class="info-row"><div class="info-label">Commentaire :</div><div>' + stagiaire.commentaire + '</div></div>' : ''}
            `;

            if (stagiaire.satisfaction) {
                document.getElementById('satisfactionForm').style.display = 'none';
                document.getElementById('thankYouMessage').style.display = 'block';
            } else {
                document.getElementById('satisfactionForm').style.display = 'block';
                document.getElementById('satisfactionForm').dataset.formationId = formationId;
                document.getElementById('satisfactionForm').dataset.stagiaireIndex = stagiaireIndex;
            }
        }

        function initStarRatings() {
            ['q1', 'q2', 'q3'].forEach(qId => {
                const container = document.getElementById(qId + 'Stars');
                if (!container) return;
                
                for (let i = 1; i <= 5; i++) {
                    const star = document.createElement('span');
                    star.className = 'star';
                    star.innerHTML = '‚òÖ';
                    star.dataset.value = i;
                    star.dataset.question = qId;
                    star.addEventListener('click', function() {
                        document.getElementById(this.dataset.question).value = this.dataset.value;
                        updateStars(this.dataset.question, this.dataset.value);
                    });
                    container.appendChild(star);
                }
            });
        }

        function updateStars(qId, value) {
            const stars = document.querySelectorAll('#' + qId + 'Stars .star');
            stars.forEach((star, index) => {
                if (index < value) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function initCharCounters() {
            ['q6', 'q7'].forEach(id => {
                const textarea = document.getElementById(id);
                if (textarea) {
                    textarea.addEventListener('input', function() {
                        const remaining = 100 - this.value.length;
                        const counter = document.getElementById(id + 'Count');
                        if (counter) {
                            counter.textContent = remaining;
                        }
                    });
                }
            });
        }

        function handleSatisfactionSubmit() {
            const form = document.getElementById('satisfactionForm');
            const fid = form.dataset.formationId;
            const sid = form.dataset.stagiaireIndex;
            
            const formation = formationsData.find(f => f.id == fid);
            const stagiaire = formation.stagiaires[sid];

            const q4Radio = document.querySelector('input[name="q4"]:checked');
            const q5Radio = document.querySelector('input[name="q5"]:checked');

            if (!q4Radio || !q5Radio) {
                // Cr√©er un message d'erreur global en haut du formulaire
                const satisfactionForm = document.getElementById('satisfactionForm');
                const existingAlert = satisfactionForm.querySelector('.alert-warning');
                if (!existingAlert) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning';
                    alertDiv.style.background = '#fff3cd';
                    alertDiv.style.color = '#856404';
                    alertDiv.style.border = '1px solid #ffeaa7';
                    alertDiv.innerHTML = '‚ö†Ô∏è Veuillez r√©pondre √† toutes les questions obligatoires (questions avec *)';
                    satisfactionForm.insertBefore(alertDiv, satisfactionForm.firstChild);
                    
                    // Scroller vers le haut du formulaire pour voir l'alerte
                    satisfactionForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Supprimer l'alerte apr√®s 5 secondes
                    setTimeout(() => alertDiv.remove(), 5000);
                }
                return;
            }

            const q1Score = parseInt(document.getElementById('q1').value);
            const q2Score = parseInt(document.getElementById('q2').value);
            const q3Score = parseInt(document.getElementById('q3').value);
            
            let q4Score = 0;
            switch(q4Radio.value) {
                case 'Pas du tout': q4Score = 0; break;
                case 'Un peu': q4Score = 1; break;
                case 'Moyennement': q4Score = 2; break;
                case 'Assez': q4Score = 3; break;
                case 'Tout √† fait': q4Score = 5; break;
            }
            
            let q5Score = 0;
            switch(q5Radio.value) {
                case 'Trop courte': q5Score = 0; break;
                case 'Adapt√©e': q5Score = 5; break;
                case 'Trop longue': q5Score = 3; break;
            }
            
            const totalScore = q1Score + q2Score + q3Score + q4Score + q5Score;
            const noteGlobale = (totalScore / 5).toFixed(2);

            stagiaire.satisfaction = {
                q1: q1Score,
                q2: q2Score,
                q3: q3Score,
                q4: q4Radio.value,
                q5: q5Radio.value,
                q6: document.getElementById('q6').value,
                q7: document.getElementById('q7').value,
                noteGlobale: noteGlobale,
                dateEnvoi: new Date().toISOString()
            };

            saveFormations();
            
            let message = '';
            if (noteGlobale < 3) {
                message = 'Nous sommes d√©sol√©s de cette appr√©ciation, nous allons revenir vers vous pour comprendre cette √©valuation.';
            } else if (noteGlobale >= 3 && noteGlobale <= 4.5) {
                message = 'Merci pour cette appr√©ciation, votre retour va nous permettre de nous am√©liorer.';
            } else {
                message = 'Merci ! Cette bonne note nous encourage √† continuer √† travailler pour votre satisfaction.';
            }
            
            form.style.display = 'none';
            document.getElementById('thankYouMessage').innerHTML = `
                <div class="alert alert-success">
                    <h3 style="margin-bottom: 15px;">‚úÖ Merci pour votre participation !</h3>
                    <p style="font-size: 18px; margin: 15px 0;"><strong>Votre avis compte beaucoup pour nous.</strong></p>
                    <p style="font-size: 20px; margin: 15px 0; color: #3270AF;"><strong>Votre appr√©ciation globale est de ${noteGlobale} sur 5.</strong></p>
                    <p style="margin-top: 15px;">${message}</p>
                </div>
            `;
            document.getElementById('thankYouMessage').style.display = 'block';
            
            // Envoi vers SharePoint via Power Automate
            if (ENABLE_SHAREPOINT_SYNC) {
                sendToSharePoint(formation, stagiaire, sid);
            }
        }

        async function sendToSharePoint(formation, stagiaire, stagiaireIndex) {
            if (!WEBHOOK_URL || WEBHOOK_URL === '') {
                console.log('Webhook non configur√© - donn√©es non envoy√©es √† SharePoint');
                return;
            }

            try {
                // Pr√©parer les donn√©es √† envoyer
                const data = {
                    // Infos formation
                    date: new Date(formation.date).toLocaleDateString('fr-FR'),
                    client: formation.raisonSociale,
                    formation: formation.theme,
                    referenceJira: formation.referenceJira || '',
                    formateur: formation.nomFormateur,
                    emailFormateur: formation.emailFormateur,
                    type: formation.type,
                    heureDebut: formation.heureDebut,
                    heureFin: formation.heureFin,
                    
                    // Infos stagiaire
                    stagiaireNom: stagiaire.nom,
                    stagiaireEmail: stagiaire.email,
                    presence: stagiaire.presence || 'Non renseign√©',
                    commentaireFormateur: stagiaire.commentaire || '',
                    
                    // Satisfaction
                    q1: stagiaire.satisfaction.q1,
                    q2: stagiaire.satisfaction.q2,
                    q3: stagiaire.satisfaction.q3,
                    q4: stagiaire.satisfaction.q4,
                    q5: stagiaire.satisfaction.q5,
                    suggestions: stagiaire.satisfaction.q6,
                    commentaireStagiaire: stagiaire.satisfaction.q7,
                    noteGlobale: stagiaire.satisfaction.noteGlobale,
                    
                    // Horodatage
                    dateReponse: new Date(stagiaire.satisfaction.dateEnvoi).toLocaleDateString('fr-FR'),
                    heureReponse: new Date(stagiaire.satisfaction.dateEnvoi).toLocaleTimeString('fr-FR'),
                    
                    // M√©tadonn√©es
                    formationId: formation.id,
                    stagiaireIndex: stagiaireIndex
                };

                // Envoyer vers Power Automate
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    console.log('‚úÖ Donn√©es envoy√©es √† SharePoint avec succ√®s');
                } else {
                    console.error('‚ùå Erreur lors de l\'envoi √† SharePoint:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'envoi √† SharePoint:', error);
            }
        }

        function saveFormations() {
            localStorage.setItem('wenegoce_formations', JSON.stringify(formationsData));
        }

        function loadFormations() {
            const saved = localStorage.getItem('wenegoce_formations');
            if (saved) {
                formationsData = JSON.parse(saved);
            }
        }

        function displayFormationsList() {
            const container = document.getElementById('formationsList');
            if (formationsData.length === 0) {
                container.innerHTML = '<p style="color: #666;">Aucune formation enregistr√©e pour le moment.</p>';
                return;
            }

            container.innerHTML = '';
            formationsData.forEach((formation, index) => {
                const satisfactionCount = formation.stagiaires.filter(s => s.satisfaction).length;
                const div = document.createElement('div');
                div.className = 'info-display';
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                div.style.gap = '15px';
                div.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${formation.theme}</strong> - ${new Date(formation.date).toLocaleDateString('fr-FR')}<br>
                        <small>${formation.raisonSociale} | ${formation.stagiaires.length} stagiaire(s) | ${satisfactionCount} √©valuation(s) re√ßue(s)</small>
                    </div>
                    <button onclick="exportSingleFormationToExcel(${index})" style="background: #28a745; color: white; border: none; padding: 0; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; font-size: 20px; transition: all 0.3s; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='#218838'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#28a745'; this.style.transform='scale(1)'" title="T√©l√©charger cette formation">
                        üì•
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function exportSingleFormationToExcel(formationIndex) {
            const formation = formationsData[formationIndex];
            if (!formation) {
                console.error('Formation non trouv√©e');
                return;
            }

            const data = [];
            
            const row = {
                'Date': new Date(formation.date).toLocaleDateString('fr-FR'),
                'Client': formation.raisonSociale,
                'Formation': formation.theme,
                'R√©f√©rence JIRA': formation.referenceJira || '',
                'Formateur': formation.nomFormateur,
                'Email formateur': formation.emailFormateur,
                'Type': formation.type,
                'Heure d√©but': formation.heureDebut,
                'Heure fin': formation.heureFin
            };

            // Ajouter les colonnes pour chaque stagiaire (max 10)
            for (let i = 0; i < MAX_STAGIAIRES; i++) {
                const stagiaire = formation.stagiaires[i];
                const prefix = 'Stagiaire ' + (i + 1) + ' - ';
                
                if (stagiaire) {
                    row[prefix + 'Nom'] = stagiaire.nom;
                    row[prefix + 'Email'] = stagiaire.email;
                    row[prefix + 'Pr√©sence'] = stagiaire.presence || 'Non renseign√©';
                    row[prefix + 'Commentaire formateur'] = stagiaire.commentaire || '';
                    
                    if (stagiaire.satisfaction) {
                        row[prefix + 'Q1 (attentes 1-5)'] = stagiaire.satisfaction.q1;
                        row[prefix + 'Q2 (objectifs 1-5)'] = stagiaire.satisfaction.q2;
                        row[prefix + 'Q3 (formateur 1-5)'] = stagiaire.satisfaction.q3;
                        row[prefix + 'Q4 (aisance)'] = stagiaire.satisfaction.q4;
                        row[prefix + 'Q5 (dur√©e)'] = stagiaire.satisfaction.q5;
                        row[prefix + 'Suggestions'] = stagiaire.satisfaction.q6;
                        row[prefix + 'Commentaire'] = stagiaire.satisfaction.q7;
                        row[prefix + 'Note globale /5'] = stagiaire.satisfaction.noteGlobale;
                        const dateEnvoi = new Date(stagiaire.satisfaction.dateEnvoi);
                        row[prefix + 'Date r√©ponse'] = dateEnvoi.toLocaleDateString('fr-FR');
                        row[prefix + 'Heure r√©ponse'] = dateEnvoi.toLocaleTimeString('fr-FR');
                    } else {
                        row[prefix + 'Q1 (attentes 1-5)'] = '';
                        row[prefix + 'Q2 (objectifs 1-5)'] = '';
                        row[prefix + 'Q3 (formateur 1-5)'] = '';
                        row[prefix + 'Q4 (aisance)'] = '';
                        row[prefix + 'Q5 (dur√©e)'] = '';
                        row[prefix + 'Suggestions'] = '';
                        row[prefix + 'Commentaire'] = '';
                        row[prefix + 'Note globale /5'] = '';
                        row[prefix + 'Date r√©ponse'] = '';
                        row[prefix + 'Heure r√©ponse'] = '';
                    }
                } else {
                    // Colonnes vides si pas de stagiaire
                    row[prefix + 'Nom'] = '';
                    row[prefix + 'Email'] = '';
                    row[prefix + 'Pr√©sence'] = '';
                    row[prefix + 'Commentaire formateur'] = '';
                    row[prefix + 'Q1 (attentes 1-5)'] = '';
                    row[prefix + 'Q2 (objectifs 1-5)'] = '';
                    row[prefix + 'Q3 (formateur 1-5)'] = '';
                    row[prefix + 'Q4 (aisance)'] = '';
                    row[prefix + 'Q5 (dur√©e)'] = '';
                    row[prefix + 'Suggestions'] = '';
                    row[prefix + 'Commentaire'] = '';
                    row[prefix + 'Note globale /5'] = '';
                    row[prefix + 'Date r√©ponse'] = '';
                    row[prefix + 'Heure r√©ponse'] = '';
                }
            }

            data.push(row);

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Formation');
            
            // Nom de fichier avec la date et le th√®me de la formation
            const dateStr = new Date(formation.date).toISOString().split('T')[0];
            const themeClean = formation.theme.replace(/[^a-z0-9]/gi, '-').substring(0, 30);
            const fileName = 'formation-' + dateStr + '-' + themeClean + '.xlsx';
            XLSX.writeFile(wb, fileName);
            
            console.log('Export Excel g√©n√©r√© : ' + fileName);
        }

        function exportToExcel(autoExport = false) {
            if (formationsData.length === 0) {
                if (!autoExport) {
                    // Afficher un message dans le conteneur de la liste plut√¥t qu'un alert
                    const formationsList = document.getElementById('formationsList');
                    formationsList.innerHTML = '<div class="alert" style="background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;">‚ö†Ô∏è Aucune donn√©e √† exporter. Cr√©ez d\'abord une formation.</div>';
                }
                return;
            }

            const data = [];
            
            formationsData.forEach(formation => {
                const row = {
                    'Date': new Date(formation.date).toLocaleDateString('fr-FR'),
                    'Client': formation.raisonSociale,
                    'Formation': formation.theme,
                    'R√©f√©rence JIRA': formation.referenceJira || '',
                    'Formateur': formation.nomFormateur,
                    'Email formateur': formation.emailFormateur,
                    'Type': formation.type,
                    'Heure d√©but': formation.heureDebut,
                    'Heure fin': formation.heureFin
                };

                // Ajouter les colonnes pour chaque stagiaire (max 10)
                for (let i = 0; i < MAX_STAGIAIRES; i++) {
                    const stagiaire = formation.stagiaires[i];
                    const prefix = 'Stagiaire ' + (i + 1) + ' - ';
                    
                    if (stagiaire) {
                        row[prefix + 'Nom'] = stagiaire.nom;
                        row[prefix + 'Email'] = stagiaire.email;
                        row[prefix + 'Pr√©sence'] = stagiaire.presence || 'Non renseign√©';
                        row[prefix + 'Commentaire formateur'] = stagiaire.commentaire || '';
                        
                        if (stagiaire.satisfaction) {
                            row[prefix + 'Q1 (attentes 1-5)'] = stagiaire.satisfaction.q1;
                            row[prefix + 'Q2 (objectifs 1-5)'] = stagiaire.satisfaction.q2;
                            row[prefix + 'Q3 (formateur 1-5)'] = stagiaire.satisfaction.q3;
                            row[prefix + 'Q4 (aisance)'] = stagiaire.satisfaction.q4;
                            row[prefix + 'Q5 (dur√©e)'] = stagiaire.satisfaction.q5;
                            row[prefix + 'Suggestions'] = stagiaire.satisfaction.q6;
                            row[prefix + 'Commentaire'] = stagiaire.satisfaction.q7;
                            row[prefix + 'Note globale /5'] = stagiaire.satisfaction.noteGlobale;
                            const dateEnvoi = new Date(stagiaire.satisfaction.dateEnvoi);
                            row[prefix + 'Date r√©ponse'] = dateEnvoi.toLocaleDateString('fr-FR');
                            row[prefix + 'Heure r√©ponse'] = dateEnvoi.toLocaleTimeString('fr-FR');
                        } else {
                            row[prefix + 'Q1 (attentes 1-5)'] = '';
                            row[prefix + 'Q2 (objectifs 1-5)'] = '';
                            row[prefix + 'Q3 (formateur 1-5)'] = '';
                            row[prefix + 'Q4 (aisance)'] = '';
                            row[prefix + 'Q5 (dur√©e)'] = '';
                            row[prefix + 'Suggestions'] = '';
                            row[prefix + 'Commentaire'] = '';
                            row[prefix + 'Note globale /5'] = '';
                            row[prefix + 'Date r√©ponse'] = '';
                            row[prefix + 'Heure r√©ponse'] = '';
                        }
                    } else {
                        // Colonnes vides si pas de stagiaire
                        row[prefix + 'Nom'] = '';
                        row[prefix + 'Email'] = '';
                        row[prefix + 'Pr√©sence'] = '';
                        row[prefix + 'Commentaire formateur'] = '';
                        row[prefix + 'Q1 (attentes 1-5)'] = '';
                        row[prefix + 'Q2 (objectifs 1-5)'] = '';
                        row[prefix + 'Q3 (formateur 1-5)'] = '';
                        row[prefix + 'Q4 (aisance)'] = '';
                        row[prefix + 'Q5 (dur√©e)'] = '';
                        row[prefix + 'Suggestions'] = '';
                        row[prefix + 'Commentaire'] = '';
                        row[prefix + 'Note globale /5'] = '';
                        row[prefix + 'Date r√©ponse'] = '';
                        row[prefix + 'Heure r√©ponse'] = '';
                    }
                }

                data.push(row);
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Formations');
            
            const fileName = 'wenegoce-formations-' + new Date().toISOString().split('T')[0] + '.xlsx';
            XLSX.writeFile(wb, fileName);
            
            // Message uniquement si export manuel
            if (!autoExport) {
                console.log('Export Excel g√©n√©r√© : ' + fileName);
            }
        }

        // ========================================
        // GESTION DES PARAM√àTRES POWER AUTOMATE
        // ========================================
        function initializeSettings() {
            document.getElementById('enableSharePointSync').checked = ENABLE_SHAREPOINT_SYNC;
            document.getElementById('webhookInput').value = WEBHOOK_URL;
            updateWebhookDisplay();
            updateFormationCount();
        }

        function updateWebhookDisplay() {
            const display = document.getElementById('webhookDisplay');
            if (WEBHOOK_URL && WEBHOOK_URL !== '') {
                display.textContent = WEBHOOK_URL.substring(0, 100) + '...';
            } else {
                display.textContent = 'Non configur√©e';
            }
        }

        function showSettingsMessage(message, type = 'success') {
            const settingsContent = document.getElementById('settings');
            const existingMsg = settingsContent.querySelector('.settings-message');
            if (existingMsg) existingMsg.remove();
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'settings-message alert';
            if (type === 'success') {
                msgDiv.style.background = '#d4edda';
                msgDiv.style.color = '#155724';
                msgDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                msgDiv.style.background = '#f8d7da';
                msgDiv.style.color = '#721c24';
                msgDiv.style.border = '1px solid #f5c6cb';
            }
            msgDiv.innerHTML = message;
            
            const firstChild = settingsContent.querySelector('h2').nextElementSibling;
            settingsContent.insertBefore(msgDiv, firstChild);
            
            setTimeout(() => msgDiv.remove(), 3000);
        }

        function updateWebhookURL() {
            const newUrl = document.getElementById('webhookInput').value.trim();
            if (!newUrl) {
                showSettingsMessage('‚ùå L\'URL ne peut pas √™tre vide', 'error');
                return;
            }
            if (!newUrl.includes('https')) {
                showSettingsMessage('‚ùå L\'URL doit commencer par https://', 'error');
                return;
            }
            
            WEBHOOK_URL = newUrl;
            localStorage.setItem('wenegoce_webhook', WEBHOOK_URL);
            updateWebhookDisplay();
            showSettingsMessage('‚úÖ URL du webhook enregistr√©e', 'success');
        }

        function copyWebhookURL() {
            if (!WEBHOOK_URL) {
                showSettingsMessage('‚ùå Aucune URL configur√©e', 'error');
                return;
            }
            navigator.clipboard.writeText(WEBHOOK_URL);
            showSettingsMessage('‚úÖ URL copi√©e dans le presse-papiers', 'success');
        }

        function toggleSync() {
            ENABLE_SHAREPOINT_SYNC = document.getElementById('enableSharePointSync').checked;
            localStorage.setItem('wenegoce_sync_enabled', ENABLE_SHAREPOINT_SYNC);
        }

        function updateFormationCount() {
            document.getElementById('formationCount').textContent = formationsData.length;
        }

        function purgeOldFormations() {
            const today = new Date();
            const thirteenMonthsAgo = new Date(today);
            thirteenMonthsAgo.setMonth(today.getMonth() - 13);
            
            // Compter combien de formations seront supprim√©es
            const oldFormations = formationsData.filter(f => {
                const formationDate = new Date(f.date);
                return formationDate < thirteenMonthsAgo;
            });
            
            if (oldFormations.length === 0) {
                // Afficher un message dans la zone des formations
                const formationsList = document.getElementById('formationsList');
                const tempAlert = document.createElement('div');
                tempAlert.className = 'alert';
                tempAlert.style.background = '#d1ecf1';
                tempAlert.style.color = '#0c5460';
                tempAlert.style.border = '1px solid #bee5eb';
                tempAlert.innerHTML = '‚ÑπÔ∏è Aucune formation de plus de 13 mois √† purger.';
                formationsList.insertBefore(tempAlert, formationsList.firstChild);
                setTimeout(() => tempAlert.remove(), 3000);
                return;
            }
            
            const limitDateStr = thirteenMonthsAgo.toLocaleDateString('fr-FR');
            const confirmMsg = `‚ö†Ô∏è ATTENTION : Purge des donn√©es anciennes\n\n` +
                `Vous allez supprimer ${oldFormations.length} formation(s) datant d'avant le ${limitDateStr}.\n\n` +
                `Cette action est IRR√âVERSIBLE !\n\n` +
                `Les donn√©es sont normalement d√©j√† dans SharePoint.\n\n` +
                `Voulez-vous continuer ?`;
            
            if (confirm(confirmMsg)) {
                // Filtrer pour garder uniquement les formations r√©centes
                const recentFormations = formationsData.filter(f => {
                    const formationDate = new Date(f.date);
                    return formationDate >= thirteenMonthsAgo;
                });
                
                formationsData = recentFormations;
                saveFormations();
                updateFormationCount();
                displayFormationsList();
                
                // Afficher un message de succ√®s
                const formationsList = document.getElementById('formationsList');
                const successAlert = document.createElement('div');
                successAlert.className = 'alert';
                successAlert.style.background = '#d4edda';
                successAlert.style.color = '#155724';
                successAlert.style.border = '1px solid #c3e6cb';
                successAlert.innerHTML = `‚úÖ ${oldFormations.length} formation(s) purg√©e(s) avec succ√®s. ${formationsData.length} formation(s) conserv√©e(s).`;
                formationsList.insertBefore(successAlert, formationsList.firstChild);
                setTimeout(() => successAlert.remove(), 5000);
            }
        }
    </script>
</body>
</html>