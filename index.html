<<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formation Manager - WeN√©goce</title>

  <!-- Favicon pour √©viter 404 console -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéì</text></svg>">

  <!-- MSAL (fallback auto si 1er CDN HS) -->
  <script id="msal-browser-cdn"
    src="https://alcdn.msauth.net/browser/2.45.0/js/msal-browser.min.js"
    defer onerror="(function(){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.45.0/lib/msal-browser.min.js';s.defer=true;document.head.appendChild(s);})();"></script>
  <script>
    window.__msalReady = new Promise(function r(res){(function c(){if(window.msal){res();}else setTimeout(c,50);})();});
  </script>

  <!-- Styles V3.1 (look & feel WeN√©goce) -->
  <style>
    :root{
      --brand:#3270AF; /* primaire WeN√©goce */
      --brand-600:#2b66a3;
      --brand-50:#e7f3ff;
      --text:#1f2937;
      --muted:#6b7280;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e5e7eb;
      --success:#28a745;
      --warning:#ff9800;
      --danger:#dc3545;
      --radius:12px;
      --shadow:0 6px 14px rgba(0,0,0,.06), 0 2px 6px rgba(0,0,0,.04);
      --shadow-sm:0 2px 8px rgba(0,0,0,.06);
      --focus:0 0 0 3px rgba(50,112,175,.25);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;line-height:1.45}
    img{max-width:100%;height:auto}

    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .header{display:flex;gap:16px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;box-shadow:var(--shadow-sm)}
    .header-logo{width:80px;min-width:80px}
    .header-content h1{margin:2px 0 6px 0;font-size:28px}
    .header-content p{margin:0;color:var(--muted)}

    .tabs{display:flex;gap:10px;margin:18px 0 12px;flex-wrap:wrap}
    .tab{appearance:none;border:1px solid var(--border);background:var(--card);padding:10px 14px;border-radius:10px;cursor:pointer;transition:.2s box-shadow,.2s transform,.2s background;box-shadow:var(--shadow-sm);font-weight:600;color:var(--text)}
    .tab:hover{transform:translateY(-1px)}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#fff;box-shadow:var(--shadow)}

    .content .tab-content{display:none}
    .content .tab-content.active{display:block}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-sm)}

    .form-group{margin-bottom:16px}
    label{font-weight:600;display:block;margin-bottom:6px}
    input[type="text"],input[type="email"],input[type="date"],input[type="time"],textarea{
      width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;background:#fff;transition:.2s border,.2s box-shadow;font-size:14px
    }
    input:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:var(--focus)}

    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}

    .btn{background:var(--brand);color:#fff;border:none;padding:12px 16px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow-sm);transition:.2s transform,.2s box-shadow}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:#6b7280}
    .btn-success{background:var(--success)}
    .btn-edit{background:#0ea5e9;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn-remove{background:#ef4444;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer}

    .switch-container{display:flex;align-items:center;gap:10px}
    .switch{position:relative;width:52px;height:30px;display:inline-block}
    .switch input{display:none}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;transition:.2s;border-radius:999px}
    .slider:before{content:"";position:absolute;height:22px;width:22px;left:4px;top:4px;background:#fff;border-radius:999px;transition:.2s}
    .switch input:checked + .slider{background:var(--brand)}
    .switch input:checked + .slider:before{transform:translateX(22px)}
    .switch-label{font-weight:600;color:#6b7280}
    .switch-label.active{color:var(--brand)}

    .alert{padding:14px 16px;border-radius:10px;border:1px solid var(--border);background:#fff}
    .alert-info{background:#eef6ff;border-color:#dbeafe;color:#1e3a8a}
    .alert-success{background:#ecfdf5;border-color:#d1fae5;color:#065f46}
    .alert-warning{background:#fff7ed;border-color:#ffedd5;color:#7c2d12}

    .info-display{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px 12px}
    .info-row{display:grid;grid-template-columns:220px 1fr;gap:12px;padding:8px 4px;border-bottom:1px dashed #edf2f7}
    .info-row:last-child{border-bottom:none}
    .info-label{color:var(--muted);font-weight:600}

    .stagiaire-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:var(--shadow-sm)}
    .stagiaire-header{display:flex;align-items:center;justify-content:space-between}
    .stagiaire-number{font-weight:700;color:var(--brand)}

    .radio-group{display:flex;gap:14px;flex-wrap:wrap}
    .radio-item{display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 10px;border-radius:10px;background:#fff}

    .formation-card{overflow:hidden;border-radius:12px;border:1px solid var(--border);box-shadow:var(--shadow-sm);background:#fff;margin-bottom:14px}
    .formation-card-title{font-weight:700}

    .stars{font-size:22px;user-select:none}
    .star{cursor:pointer;display:inline-block;color:#d1d5db;transition:transform .1s ease}
    .star.active{color:#f59e0b}
    .star:hover{transform:scale(1.05)}

    .modal{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:40}
    .modal-content{width:min(760px,95vw);background:#fff;border-radius:14px;overflow:hidden;box-shadow:var(--shadow)}
    .modal-header{background:var(--brand);color:#fff;padding:14px 16px;display:flex;align-items:center;justify-content:space-between}
    .modal-body{padding:18px}
    .btn-icon{background:transparent;border:none;font-size:18px;cursor:pointer}

    .version-info{color:#6b7280;text-align:center}
    .version-number{font-weight:800}

    .error-message{color:var(--danger)}

    @media (max-width:768px){
      .row{grid-template-columns:1fr}
      .info-row{grid-template-columns:1fr}
      .header{flex-direction:column;align-items:flex-start}
      .tabs{gap:8px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header card">
      <div class="header-logo"><img src="https://back.wenegoce.fr/uploads/0406_Logo_We_Negoce_avec_We_Soft_DEFINITIF_502368ceeb.png" alt="WeN√©goce"></div>
      <div class="header-content">
        <h1>Formation Manager</h1>
        <p>Suivi des pr√©sences et enqu√™te de satisfaction stagiaires</p>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="formateur">üë®‚Äçüè´ Espace Formateur</button>
      <button class="tab" data-tab="formations">üìã Formations</button>
      <button class="tab" data-tab="stagiaire">üë§ Espace Stagiaire</button>
    </div>

    <div class="content">
      <!-- FORMATEUR -->
      <div id="formateur" class="tab-content active">
        <h2 style="margin-bottom:20px;color:var(--brand);">Pr√©paration de la formation</h2>
        <div id="preparationForm" class="card" style="padding:18px;">
          <form id="formateurForm">
            <div class="form-group">
              <label>Raison sociale du client *</label>
              <input type="text" id="raisonSociale" required>
            </div>
            <div class="form-group">
              <label>Th√®me de la formation *</label>
              <input type="text" id="themeFormation" required>
            </div>
            <div class="form-group">
              <label>R√©f√©rence JIRA</label>
              <input type="text" id="referenceJira" placeholder="TIC-123, SMC-456 ou SNC-789">
              <small style="color:#999">Format : TIC-, SMC- ou SNC- suivi d'un num√©ro (optionnel)</small>
            </div>
            <div class="form-group">
              <label>Nom du formateur *</label>
              <input type="text" id="nomFormateur" required>
            </div>
            <div class="row">
              <div class="form-group">
                <label>Date de la formation *</label>
                <input type="date" id="dateFormation" required>
              </div>
              <div class="form-group">
                <label>Type de formation *</label>
                <div class="switch-container">
                  <span class="switch-label active" id="labelPresentiel">üè¢ Pr√©sentiel</span>
                  <label class="switch">
                    <input type="checkbox" id="typeFormationToggle">
                    <span class="slider"></span>
                  </label>
                  <span class="switch-label" id="labelVisio">üíª Visio</span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="form-group">
                <label>Heure de d√©but *</label>
                <input type="time" id="heureDebut" required>
              </div>
              <div class="form-group">
                <label>Heure de fin *</label>
                <input type="time" id="heureFin" required>
              </div>
            </div>
            <h3 style="margin:30px 0 15px;color:var(--brand);">Liste des stagiaires</h3>
            <div id="stagiairesList"></div>
            <div style="display:flex;gap:15px;margin-top:20px;flex-wrap:wrap">
              <button type="button" class="btn btn-secondary" id="btnAddStagiaire">‚ûï Ajouter un stagiaire</button>
              <button type="submit" class="btn">üìù Feuille de pr√©sence</button>
            </div>
          </form>
        </div>

        <div id="postFormationSection" style="display:none;">
          <div class="alert alert-info" style="margin:12px 0 16px;">
            ‚ÑπÔ∏è <strong>Formation enregistr√©e !</strong> Une fois la formation termin√©e, compl√©tez la pr√©sence de chaque stagiaire ci-dessous.
          </div>
          <div id="formationInfo" class="info-display" style="margin-bottom:18px"></div>
          <h3 style="margin:12px 0 12px;color:var(--brand);">Compl√©ter les pr√©sences</h3>
          <form id="presenceForm" class="card" style="padding:18px;">
            <div id="presenceList"></div>
            <div style="margin-top:18px">
              <button type="submit" class="btn">üìß G√©n√©rer et envoyer les liens stagiaires</button>
            </div>
          </form>
        </div>

        <div id="linksGenerated" style="display:none;margin-top:18px;">
          <div class="alert alert-success">‚úÖ Les liens ont √©t√© g√©n√©r√©s avec succ√®s ! Vous pouvez maintenant envoyer les emails aux stagiaires.</div>
          <div id="emailLinks"></div>
        </div>
      </div>

      <!-- FORMATIONS -->
      <div id="formations" class="tab-content">
        <h2 style="margin-bottom:20px;color:var(--brand);">üìã Mes Formations</h2>
        <div class="alert alert-info">‚ÑπÔ∏è S√©lectionnez une formation pour envoyer les liens d'enqu√™te de satisfaction aux stagiaires.</div>
        <div id="formationsLoading" style="text-align:center;padding:30px;color:#666;">üîÑ Chargement des formations...</div>
        <div id="formationsList" style="display:none"></div>
        <div id="formationsEmpty" style="display:none;text-align:center;padding:40px;color:#999;">üì≠ Aucune formation trouv√©e.</div>
      </div>

      <!-- STAGIAIRE -->
      <div id="stagiaire" class="tab-content">
        <div id="stagiaireView">
          <div class="alert alert-info">‚ÑπÔ∏è Cette page est accessible via le lien envoy√© par email par votre formateur.</div>
          <h2 style="margin-bottom:16px;color:var(--brand);">Attestation de formation</h2>
          <div class="info-display" id="infoFormation"><p style="text-align:center;color:#666">En attente du lien personnalis√©...</p></div>

          <form id="satisfactionForm" style="display:none" class="card" >
            <div style="padding:18px">
              <h3 style="margin:0 0 12px;color:var(--brand);">üìã Enqu√™te de satisfaction</h3>
              <div class="form-group">
                <label>La formation a-t-elle r√©pondu √† vos attentes ? *</label>
                <div class="stars" id="q1Stars"></div>
                <input type="hidden" id="q1" required>
              </div>
              <div class="form-group">
                <label>Les objectifs de la formation √©taient-ils clairs et bien expliqu√©s ? *</label>
                <div class="stars" id="q2Stars"></div>
                <input type="hidden" id="q2" required>
              </div>
              <div class="form-group">
                <label>Le formateur a-t-il su rendre la session claire, dynamique et adapt√©e √† votre niveau ? *</label>
                <div class="stars" id="q3Stars"></div>
                <input type="hidden" id="q3" required>
              </div>
              <div class="form-group">
                <label>Vous sentez-vous √† pr√©sent √† l'aise pour utiliser les fonctions pr√©sent√©es lors de cette formation ? *</label>
                <div class="radio-group">
                  <label class="radio-item"><input type="radio" name="q4" value="Pas du tout" required><span>Pas du tout</span></label>
                  <label class="radio-item"><input type="radio" name="q4" value="Un peu" required><span>Un peu</span></label>
                  <label class="radio-item"><input type="radio" name="q4" value="Moyennement" required><span>Moyennement</span></label>
                  <label class="radio-item"><input type="radio" name="q4" value="Assez" required><span>Assez</span></label>
                  <label class="radio-item"><input type="radio" name="q4" value="Tout √† fait" required><span>Tout √† fait</span></label>
                </div>
              </div>
              <div class="form-group">
                <label>Comment jugez-vous la dur√©e de la formation ? *</label>
                <div class="radio-group">
                  <label class="radio-item"><input type="radio" name="q5" value="Trop courte" required><span>Trop courte</span></label>
                  <label class="radio-item"><input type="radio" name="q5" value="Adapt√©e" required><span>Adapt√©e</span></label>
                  <label class="radio-item"><input type="radio" name="q5" value="Trop longue" required><span>Trop longue</span></label>
                </div>
              </div>
              <div class="form-group">
                <label>Quelles sont vos suggestions pour am√©liorer cette formation ?</label>
                <textarea id="q6" maxlength="100" rows="3" placeholder="Maximum 100 caract√®res"></textarea>
                <small style="color:#666">Caract√®res restants: <span id="q6Count">100</span></small>
              </div>
              <div class="form-group">
                <label>Un dernier commentaire ?</label>
                <textarea id="q7" maxlength="100" rows="3" placeholder="Maximum 100 caract√®res"></textarea>
                <small style="color:#666">Caract√®res restants: <span id="q7Count">100</span></small>
              </div>
              <button type="submit" class="btn btn-success">üì§ Envoyer mon √©valuation</button>
            </div>
          </form>
          <div id="thankYouMessage" style="display:none"></div>
        </div>
      </div>

      <div class="version-info" style="margin-top:24px;">
        <div class="version-number">Version 3.1</div>
        <div class="version-date">12 novembre 2025</div>
        <div class="copyright">¬© 2025 WeN√©goce - Tous droits r√©serv√©s<br>Formation Manager est une solution propri√©taire d√©velopp√©e par WeN√©goce</div>
      </div>
    </div>
  </div>

  <!-- Modale √©dition email -->
  <div id="emailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úèÔ∏è Modifier l'email</h3>
        <button class="btn-icon" onclick="closeEmailModal()" style="color:white">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Objet de l'email *</label>
          <input type="text" id="emailSubjectEdit">
        </div>
        <div class="form-group">
          <label>Corps du message *</label>
          <textarea id="emailBodyEdit" rows="12" style="font-family:inherit;line-height:1.6"></textarea>
        </div>
        <div style="text-align:right;margin-top:10px">
          <button class="btn" onclick="saveEmailChanges()">‚úì Termin√©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modale relance -->
  <div id="reminderModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üìß Relancer le stagiaire</h3>
        <button class="btn-icon" onclick="closeReminderModal()" style="color:white">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="reminderInfo" class="info-display" style="margin-bottom:12px"></div>
        <div class="form-group">
          <label>Objet de l'email *</label>
          <input type="text" id="reminderSubjectEdit">
        </div>
        <div class="form-group">
          <label>Corps du message *</label>
          <textarea id="reminderBodyEdit" rows="12" style="font-family:inherit;line-height:1.6"></textarea>
        </div>
        <div class="alert alert-info" style="margin-top:10px">‚ÑπÔ∏è <strong>Note :</strong> Le lien personnalis√© sera automatiquement ins√©r√© √† la place de [LIEN]</div>
        <div style="text-align:right;margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btn-secondary" onclick="closeReminderModal()">Annuler</button>
          <button class="btn" onclick="sendReminder()">üìß Envoyer la relance</button>
        </div>
      </div>
    </div>
  </div>

  <!-- XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Helpers g√©n√©riques App/Azure -->
  <script>
    function toDateISOFromInput(d){
      if(!d) return null; try{
        if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d+"T00:00:00Z";
        if(/^\d{2}\/\d{2}\/\d{4}$/.test(d)){const [dd,mm,yyyy]=d.split('/');return `${yyyy}-${mm}-${dd}T00:00:00Z`;}
      }catch(e){}
      return null;
    }
  </script>

  <!-- ============================= -->
  <!--   FORMATION MANAGER core JS   -->
  <!-- ============================= -->
  <script>
  // ===== Donn√©es & √©tat =====
  let stagiaireCount=0; let formationsData=[]; let currentFormationId=null; const MAX_STAGIAIRES=10;
  let emailSubjectGlobal=''; let emailBodyGlobal=''; let currentFormationData=null;

  // ===== Endpoints Azure (adapter si besoin) =====
  const FM_ENDPOINTS={
    createFormation: "https://prod-01.francecentral.logic.azure.com:443/workflows/2ed0a1ded8c04bdb919956463f324d76/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=xdDuSi6kyJazxW0euPSUkEowfVgIrgxfAQ6a6Ogejg0",
    createPresence:  "https://prod-02.francecentral.logic.azure.com:443/workflows/a108ca6c917a4197ba14e2674ff31b44/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=zOjl38vl1AXhyV25ZGW_01wVLwXZwftceAYxyk8gjro",
    manager:         "https://prod-20.francecentral.logic.azure.com:443/workflows/bad15f005ef64adab56e14fd436b8a1f/triggers/When_an_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_an_HTTP_request_is_received%2Frun&sv=1.0&sig=6iHn4hVguX6pLJFyTTvbq4ujoMwF0dnCgRfy7k7hiKA"
  };
  const ENABLE_SHAREPOINT_SYNC=true;

  // ===== Utils =====
  async function postJson(url,data){
    const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    if(!(res.ok||res.status===202)){const txt=await res.text().catch(()=>" ");throw new Error(`HTTP ${res.status} ${res.statusText} ‚Äî ${txt}`)}
    try{return await res.json();}catch{return await res.text().catch(()=>null)}
  }

  // ===== DOM Ready =====
  document.addEventListener('DOMContentLoaded',()=>{
    loadFormations(); addStagiaire(); initStarRatings(); initCharCounters(); checkURLParams(); initEventListeners(); initTypeFormationToggle(); setTodayDate();
  });

  // ===== UI helpers =====
  function setTodayDate(){const el=document.getElementById('dateFormation'); if(el && !el.value){const d=new Date(),y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0'); el.value=`${y}-${m}-${da}`;}}
  function switchTab(name){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); const t=document.querySelector(`.tab[data-tab="${name}"]`),c=document.getElementById(name); if(t)t.classList.add('active'); if(c)c.classList.add('active'); if(name==='formations') loadFormationsTab(); }
  function initEventListeners(){
    document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click',function(){switchTab(this.getAttribute('data-tab'));}));
    const btnAdd=document.getElementById('btnAddStagiaire'); if(btnAdd) btnAdd.addEventListener('click',e=>{e.preventDefault(); addStagiaire();});
    const formateurForm=document.getElementById('formateurForm'); if(formateurForm) formateurForm.addEventListener('submit',e=>{e.preventDefault(); handleFormateurSubmit();});
    ['raisonSociale','themeFormation','nomFormateur','dateFormation','heureDebut','heureFin'].forEach(id=>{const f=document.getElementById(id); if(!f) return; f.addEventListener('blur',()=>validateRequiredField(f)); f.addEventListener('input',()=>{if(f.value.trim()) clearError(f);});});
    const hd=document.getElementById('heureDebut'), hf=document.getElementById('heureFin'); if(hd) hd.addEventListener('change',validateHeures); if(hf){hf.addEventListener('change',validateHeures); hf.addEventListener('blur',validateHeures);} 
    const df=document.getElementById('dateFormation'); if(df) df.addEventListener('change',validateDateFormation);
    const presenceForm=document.getElementById('presenceForm'); if(presenceForm) presenceForm.addEventListener('submit',e=>{e.preventDefault(); handlePresenceSubmit();});
    const satisfactionForm=document.getElementById('satisfactionForm'); if(satisfactionForm) satisfactionForm.addEventListener('submit',e=>{e.preventDefault(); handleSatisfactionSubmit();});
    const jira=document.getElementById('referenceJira'); if(jira) jira.addEventListener('blur',function(){if(this.value.trim()) validateJiraReference(this);});
  }

  // ===== Validations =====
  function showError(input,msg){input.style.borderColor='var(--danger)'; const ex=input.parentElement.querySelector('.error-message'); if(ex) ex.remove(); const s=document.createElement('small'); s.className='error-message'; s.textContent=msg; input.parentElement.appendChild(s);}
  function clearError(input){const ex=input.parentElement.querySelector('.error-message'); if(ex) ex.remove(); input.style.borderColor='#e0e0e0';}
  function validateRequiredField(input){ if(!input.value.trim()) showError(input,'Ce champ est obligatoire'); else {clearError(input); input.style.borderColor='var(--success)';}}
  function validateEmail(input){const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; if(input.value.trim() && !re.test(input.value)) showError(input,'Format email invalide'); else if(input.value.trim()){clearError(input); input.style.borderColor='var(--success)';}}
  function validateJiraReference(input){const r=/^(TIC|SMC|SNC)-\d+$/i; if(input.value.trim() && !r.test(input.value)) showError(input,'Format JIRA invalide (ex: TIC-123)'); else if(input.value.trim()){clearError(input); input.style.borderColor='var(--success)';}}
  function validateDateFormation(){const el=document.getElementById('dateFormation'); const d=new Date(el.value), today=new Date(); today.setHours(0,0,0,0); const min=new Date(); min.setDate(today.getDate()-7); if(d<min){showError(el,'La formation est trop ancienne. Date minimum: '+min.toLocaleDateString('fr-FR'));} else {clearError(el); el.style.borderColor='var(--success)';}}
  function validateHeures(){const hd=document.getElementById('heureDebut'), hf=document.getElementById('heureFin'); if(hd.value && hf.value){const [a,b]=hd.value.split(':').map(Number), [c,d]=hf.value.split(':').map(Number); if((c*60+d) <= (a*60+b)) showError(hf,"L'heure de fin doit √™tre apr√®s l'heure de d√©but"); else {clearError(hf); hf.style.borderColor='var(--success)';}}}
  function initTypeFormationToggle(){const t=document.getElementById('typeFormationToggle'), lp=document.getElementById('labelPresentiel'), lv=document.getElementById('labelVisio'); if(!t) return; t.addEventListener('change',function(){ if(this.checked){lp.classList.remove('active'); lv.classList.add('active');} else {lp.classList.add('active'); lv.classList.remove('active');}})}

  // ===== Gestion stagiaires =====
  function addStagiaire(){ if(stagiaireCount>=MAX_STAGIAIRES){alert('‚ö†Ô∏è Maximum de '+MAX_STAGIAIRES+' stagiaires atteint'); return;} stagiaireCount++; const c=document.getElementById('stagiairesList'); const d=document.createElement('div'); d.className='stagiaire-item'; d.id='stagiaire-'+stagiaireCount; d.innerHTML=`
    <div class="stagiaire-header">
      <span class="stagiaire-number">Stagiaire ${stagiaireCount}</span>
      <button type="button" class="btn-remove" onclick="removeStagiaire(${stagiaireCount})">üóëÔ∏è Supprimer</button>
    </div>
    <div class="row">
      <div class="form-group"><label>Nom complet *</label><input type="text" id="nomStagiaire${stagiaireCount}" required></div>
      <div class="form-group"><label>Email *</label><input type="email" id="emailStagiaire${stagiaireCount}" required></div>
    </div>`; c.appendChild(d);
    const emailInput=document.getElementById('emailStagiaire'+stagiaireCount); if(emailInput){emailInput.addEventListener('blur',function(){validateEmail(this)}); emailInput.addEventListener('input',function(){if(this.value.trim()) clearError(this)});}
  }
  function removeStagiaire(id){const it=document.getElementById('stagiaire-'+id); if(it){it.remove(); stagiaireCount--;}}

  // ===== Submit formation -> Azure =====
  async function handleFormateurSubmit(){
    const raisonSociale=document.getElementById('raisonSociale').value.trim();
    const theme=document.getElementById('themeFormation').value.trim();
    const referenceJira=document.getElementById('referenceJira').value.trim();
    const nomFormateur=document.getElementById('nomFormateur').value.trim();
    const dateFormation=document.getElementById('dateFormation').value;
    const typeFormation=document.getElementById('typeFormationToggle').checked ? 'Visio':'Pr√©sentiel';
    const heureDebut=document.getElementById('heureDebut').value; const heureFin=document.getElementById('heureFin').value;

    if(!raisonSociale||!theme||!nomFormateur||!dateFormation||!heureDebut||!heureFin){alert('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires'); return;}
    if(referenceJira){const r=/^(TIC|SMC|SNC)-\d+$/i; if(!r.test(referenceJira)){alert('‚ö†Ô∏è Format de r√©f√©rence JIRA invalide. Utilisez TIC-123 / SMC-456 / SNC-789'); return;}}
    const d=new Date(dateFormation), today=new Date(); today.setHours(0,0,0,0); const min=new Date(); min.setDate(today.getDate()-7); if(d<min){alert('‚ö†Ô∏è La date de formation est trop ancienne (plus de 7 jours)'); return;}
    const [hd,md]=heureDebut.split(':').map(Number), [hf,mf]=heureFin.split(':').map(Number); if((hf*60+mf)<=(hd*60+md)){alert("‚ö†Ô∏è L'heure de fin doit √™tre apr√®s l'heure de d√©but"); return;}

    const stagiaires=[]; let hasError=false;
    for(let i=1;i<=stagiaireCount;i++){
      const nom=document.getElementById('nomStagiaire'+i); const email=document.getElementById('emailStagiaire'+i);
      if(!nom||!email) continue; const n=nom.value.trim(), e=email.value.trim();
      if(!n){showError(nom,'Ce champ est obligatoire'); hasError=true}
      if(!e){showError(email,'Ce champ est obligatoire'); hasError=true}
      else{const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; if(!re.test(e)){showError(email,'Format email invalide'); hasError=true}}
      if(n&&e){const id='STG-'+Date.now()+'-'+Math.random().toString(36).substr(2,9); stagiaires.push({id,nom:n,email:e,lien:null,presence:null,commentaire:'',satisfaction:null});}
    }
    if(hasError){alert('‚ö†Ô∏è Veuillez corriger les erreurs'); return;}
    if(stagiaires.length===0){alert('‚ö†Ô∏è Ajoutez au moins un stagiaire'); return;}

    currentFormationId='FRM-'+Date.now()+'-'+Math.random().toString(36).substr(2,9);
    currentFormationData={id:currentFormationId, raisonSociale, theme, referenceJira, nomFormateur, date:dateFormation, type:typeFormation, heureDebut, heureFin, stagiaires};
    const base=window.location.origin+window.location.pathname; currentFormationData.stagiaires.forEach(s=>{s.lien=`${base}?fid=${currentFormationId}&stid=${s.id}`;});

    const btn=document.querySelector('#formateurForm button[type="submit"]'); const txt=btn.innerHTML; btn.disabled=true; btn.innerHTML='‚è≥ Enregistrement en cours...';
    try{
      const payload={
        FormationID:currentFormationId, Theme:theme, Formateur:nomFormateur, Client:raisonSociale,
        DateISO:toDateISOFromInput(dateFormation), HeureDebut:heureDebut, HeureFin:heureFin,
        TypeFormation:typeFormation, Statut:'Planifi√©e', ReferenceJIRA:referenceJira||'',
        Stagiaires:currentFormationData.stagiaires
      };
      if(ENABLE_SHAREPOINT_SYNC) await postJson(FM_ENDPOINTS.createFormation,payload);
      formationsData.push(currentFormationData); saveFormations();
      document.getElementById('preparationForm').style.display='none';
      document.getElementById('postFormationSection').style.display='block';
      displayFormationInfo(); displayPresenceForm(); window.scrollTo(0,0);
    }catch(e){alert('‚ùå Erreur lors de l\'enregistrement de la formation.\n'+e.message); console.error(e);}finally{btn.disabled=false; btn.innerHTML=txt;}
  }

  function displayFormationInfo(){const f=currentFormationData; const el=document.getElementById('formationInfo'); el.innerHTML=`
    <div class="info-row"><div class="info-label">Client :</div><div>${f.raisonSociale}</div></div>
    <div class="info-row"><div class="info-label">Formation :</div><div>${f.theme}</div></div>
    ${f.referenceJira?`<div class="info-row"><div class="info-label">R√©f√©rence JIRA :</div><div>${f.referenceJira}</div></div>`:''}
    <div class="info-row"><div class="info-label">Formateur :</div><div>${f.nomFormateur}</div></div>
    <div class="info-row"><div class="info-label">Date :</div><div>${new Date(f.date).toLocaleDateString('fr-FR')}</div></div>
    <div class="info-row"><div class="info-label">Type :</div><div>${f.type}</div></div>
    <div class="info-row"><div class="info-label">Horaires :</div><div>${f.heureDebut} - ${f.heureFin}</div></div>
    <div class="info-row"><div class="info-label">Nombre de stagiaires :</div><div>${f.stagiaires.length}</div></div>`;}

  function displayPresenceForm(){const c=document.getElementById('presenceList'); c.innerHTML=''; currentFormationData.stagiaires.forEach((s,idx)=>{
    const d=document.createElement('div'); d.className='stagiaire-item'; d.innerHTML=`
      <div class="stagiaire-header"><span class="stagiaire-number">${s.nom}</span></div>
      <div class="form-group"><label>Pr√©sence *</label>
        <div class="radio-group">
          <label class="radio-item"><input type="radio" name="presence${idx}" value="Present" required><span>‚úÖ Present</span></label>
          <label class="radio-item"><input type="radio" name="presence${idx}" value="Absent" required><span>‚ùå Absent</span></label>
          <label class="radio-item"><input type="radio" name="presence${idx}" value="Partielle" required><span>‚ö†Ô∏è Partielle</span></label>
        </div>
      </div>
      <div class="form-group"><label>Commentaire du formateur</label><textarea id="commentaire${idx}" rows="2" placeholder="Observations particuli√®res sur ce stagiaire..."></textarea></div>`; c.appendChild(d);
  });}

  function handlePresenceSubmit(){currentFormationData.stagiaires.forEach((s,idx)=>{const inputs=document.getElementsByName('presence'+idx); const com=document.getElementById('commentaire'+idx); let v=null; inputs.forEach(i=>{if(i.checked) v=i.value}); s.presence=v; s.commentaire=com?com.value.trim():'';}); saveFormations(); document.getElementById('postFormationSection').style.display='none'; generateEmailLinks(); window.scrollTo(0,0);}

  function generateEmailLinks(){const f=currentFormationData; const container=document.getElementById('emailLinks');
    if(ENABLE_SHAREPOINT_SYNC){sendPresenceDataToAzure(f.id,f.stagiaires).catch(e=>console.error('Push pr√©sences KO:',e));}
    const d=new Date(f.date).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    emailSubjectGlobal=`Votre formation ${f.theme} - attestation et enqu√™te de satisfaction`;
    emailBodyGlobal=
      `Bonjour,\n\n`+
      `Vous avez particip√© √† la formation ¬´ ${f.theme} ¬ª anim√©e par ${f.nomFormateur} le ${d}.\n\n`+
      `Afin de finaliser votre dossier, nous vous invitons √† cliquer sur le lien ci-dessous. Vous y trouverez :\n`+
      `‚Ä¢ votre attestation de pr√©sence,\n`+
      `‚Ä¢ ainsi qu'une br√®ve enqu√™te de satisfaction (moins d'une minute √† remplir).\n\n`+
      `üëâ [LIEN]\n\n`+
      `Nous vous remercions pour votre participation et restons √† votre disposition pour toute question compl√©mentaire.\n\n`+
      `Bien cordialement,`;
    container.innerHTML=`
      <h2 style="margin-bottom:12px;color:var(--brand)">üìß Envoi des liens aux stagiaires</h2>
      <div class="alert alert-success" style="margin-bottom:14px">‚úÖ Les pr√©sences ont √©t√© enregistr√©es avec succ√®s ! Vous pouvez maintenant envoyer les emails aux stagiaires.</div>
      <div style="background:var(--brand-50);padding:16px;border-radius:10px;border-left:4px solid var(--brand);margin-bottom:14px;">
        <strong style="color:var(--brand)">üìß Mod√®le d'email</strong>
        <button class="btn-edit" style="margin-left:10px" onclick="openEmailModal()">‚úèÔ∏è Personnaliser l'email</button>
        <div style="margin-top:12px;padding:12px;background:#fff;border-radius:10px">
          <div style="margin-bottom:8px"><strong>Objet :</strong> ${emailSubjectGlobal}</div>
          <div style="white-space:pre-wrap;color:#666;font-size:14px">${emailBodyGlobal.replace('[LIEN]','üîó Lien personnalis√© du stagiaire')}</div>
        </div>
      </div>
      <div style="margin-bottom:12px;padding:12px;background:var(--brand-50);border-radius:10px;border-left:4px solid var(--brand)">
        <strong style="color:var(--brand)">üìß Envoi individuel par stagiaire</strong><br>
        <small style="color:#666">Chaque stagiaire recevra un email avec uniquement son lien personnel</small>
        <div style="margin-top:12px" id="individualEmailsList"></div>
      </div>`;
    const list=document.getElementById('individualEmailsList');
    f.stagiaires.forEach(s=>{
      const d=document.createElement('div'); d.style.cssText='background:#fff;padding:14px;border-radius:10px;margin-bottom:10px;border:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;';
      d.innerHTML=`
        <div>
          <strong style="color:#333">${s.nom}</strong><br>
          <small style="color:#666">${s.email}</small><br>
          <small style="color:#999">Pr√©sence : <strong style="color:${s.presence==='Present'?'#28a745':'#666'}">${s.presence||'‚Äî'}</strong></small>
        </div>
        <button class="btn" style="margin:0;padding:10px 18px;font-size:14px" onclick="sendIndividualEmail('${s.id}')">üìß Envoyer l'email</button>`;
      list.appendChild(d);
    });
    document.getElementById('linksGenerated').style.display='block';
  }
  function openEmailModal(){document.getElementById('emailSubjectEdit').value=emailSubjectGlobal; document.getElementById('emailBodyEdit').value=emailBodyGlobal; document.getElementById('emailModal').style.display='flex';}
  function closeEmailModal(){document.getElementById('emailModal').style.display='none'}
  function saveEmailChanges(){emailSubjectGlobal=document.getElementById('emailSubjectEdit').value; emailBodyGlobal=document.getElementById('emailBodyEdit').value; closeEmailModal(); generateEmailLinks();}
  function sendIndividualEmail(stagiaireId){const f=currentFormationData; const s=f.stagiaires.find(x=>x.id===stagiaireId); if(!s){alert('‚ùå Erreur : Stagiaire non trouv√©'); return;} const subject=encodeURIComponent(emailSubjectGlobal); const body=encodeURIComponent(emailBodyGlobal.replace('[LIEN]',s.lien)); window.location.href=`mailto:${s.email}?subject=${subject}&body=${body}`;}

  // ===== Relance =====
  let currentReminderFormationId=null, currentReminderStagiaireId=null;
  function openReminderModal(formationId,idx){const f=formationsData.find(x=>x.id===formationId); if(!f) return; const enAttente=f.stagiaires.filter(s=>(s.presence==='Present'||s.presence==='Partielle')&&!s.satisfaction); const s=enAttente[idx]; if(!s) return; currentReminderFormationId=formationId; currentReminderStagiaireId=s.id; const d=new Date(f.date).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}); document.getElementById('reminderInfo').innerHTML=`
    <div class="info-row"><div class="info-label">Formation :</div><div>${f.theme}</div></div>
    <div class="info-row"><div class="info-label">Date :</div><div>${d}</div></div>
    <div class="info-row"><div class="info-label">Stagiaire :</div><div>${s.nom}</div></div>
    <div class="info-row"><div class="info-label">Email :</div><div>${s.email}</div></div>`;
    document.getElementById('reminderSubjectEdit').value=`Relance - Enqu√™te de satisfaction formation ${f.theme}`;
    document.getElementById('reminderBodyEdit').value=`Bonjour,\n\nLa mesure de votre satisfaction est importante pour √©valuer la formation ${f.theme} du ${d}.\n\nMerci de r√©pondre au questionnaire en cliquant sur le lien : [LIEN]\n\nTr√®s cordialement`;
    document.getElementById('reminderModal').style.display='flex';}
  function closeReminderModal(){document.getElementById('reminderModal').style.display='none'; currentReminderFormationId=null; currentReminderStagiaireId=null;}
  function sendReminder(){if(!currentReminderFormationId||!currentReminderStagiaireId) return; const f=formationsData.find(x=>x.id===currentReminderFormationId); if(!f) return; const s=f.stagiaires.find(x=>x.id===currentReminderStagiaireId); if(!s) return; const subject=document.getElementById('reminderSubjectEdit').value; const body=document.getElementById('reminderBodyEdit').value.replace('[LIEN]',s.lien); const href=`mailto:${s.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; window.location.href=href; closeReminderModal();}

  // ===== Azure: pr√©sences & satisfaction =====
  async function sendPresenceDataToAzure(formationId,stagiaires){ if(!ENABLE_SHAREPOINT_SYNC) return; if(!FM_ENDPOINTS.createPresence) throw new Error('Endpoint createPresence manquant.'); const payload={FormationID:formationId, Stagiaires:(stagiaires||[]).map(s=>({id:s.id,nom:s.nom,email:s.email,presence:s.presence??null,commentaire:s.commentaire??''}))}; await postJson(FM_ENDPOINTS.createPresence,payload); }
  function initStarRatings(){['q1','q2','q3'].forEach(q=>{const c=document.getElementById(q+'Stars'); if(!c) return; for(let i=1;i<=5;i++){const s=document.createElement('span'); s.className='star'; s.innerHTML='‚òÖ'; s.dataset.value=i; s.dataset.question=q; s.addEventListener('click',function(){document.getElementById(this.dataset.question).value=this.dataset.value; updateStars(this.dataset.question,this.dataset.value);}); c.appendChild(s);}});} 
  function updateStars(id,val){document.querySelectorAll('#'+id+'Stars .star').forEach((s,idx)=>{if(idx<val) s.classList.add('active'); else s.classList.remove('active');});}
  function initCharCounters(){['q6','q7'].forEach(id=>{const t=document.getElementById(id), c=document.getElementById(id+'Count'); if(t&&c){t.addEventListener('input',function(){const r=100-this.value.length; c.textContent=r; c.style.color=(r<20)?'var(--danger)':'#666';});}});} 

  function handleSatisfactionSubmit(){const q4=document.querySelector('input[name="q4"]:checked'); const q5=document.querySelector('input[name="q5"]:checked'); if(!q4||!q5){alert('‚ö†Ô∏è Veuillez r√©pondre √† toutes les questions obligatoires (*)'); return;} const q1=parseInt(document.getElementById('q1').value||'0',10); const q2=parseInt(document.getElementById('q2').value||'0',10); const q3=parseInt(document.getElementById('q3').value||'0',10); let q4s=0; switch(q4.value){case 'Pas du tout':q4s=0;break;case 'Un peu':q4s=1;break;case 'Moyennement':q4s=2;break;case 'Assez':q4s=3;break;case 'Tout √† fait':q4s=5;break;} let q5s=0; switch(q5.value){case 'Trop courte':q5s=0;break;case 'Adapt√©e':q5s=5;break;case 'Trop longue':q5s=3;break;} const total=q1+q2+q3+q4s+q5s; const note=(total/5).toFixed(2); const url=new URL(window.location.href); const formationId=url.searchParams.get('fid'); const stagiaireId=url.searchParams.get('stid'); const satisfaction={q1,q2,q3,q4:q4.value,q5:q5.value,q6:document.getElementById('q6').value,q7:document.getElementById('q7').value,noteGlobale:note,dateEnvoi:new Date().toISOString()}; if(ENABLE_SHAREPOINT_SYNC && FM_ENDPOINTS.manager){ const payload={action:'SaveSatisfaction', FormationID:formationId, StagiaireID:stagiaireId, Q1_Attentes:q1, Q2_Objectifs:q2, Q3_Formateur:q3, Q4_Aise:q4.value, Q5_Duree:q5.value, Q6_Suggestions:satisfaction.q6||'', Q7_Commentaire:satisfaction.q7||'', NoteGlobale:parseFloat(note), DateReponse:satisfaction.dateEnvoi}; postJson(FM_ENDPOINTS.manager,payload).then(()=>{const msg= note<3 ? 'Nous allons revenir vers vous pour comprendre cette √©valuation.' : (note<=4.5 ? 'Merci, votre retour va nous permettre de nous am√©liorer.' : 'Merci ! Cette bonne note nous encourage √† continuer.'); displayThankYouMessage(note,msg);}).catch(err=>{console.error('Erreur envoi satisfaction:',err); displayThankYouMessage(note,'Votre r√©ponse est enregistr√©e localement. Une erreur est survenue c√¥t√© serveur.');}); } else { displayThankYouMessage(note,'Votre r√©ponse est enregistr√©e localement (mode hors-ligne).'); } }

  function displayThankYouMessage(note,message){document.getElementById('infoFormation').style.display='none'; document.getElementById('satisfactionForm').style.display='none'; const t=document.getElementById('thankYouMessage'); t.innerHTML=`
    <div class="alert alert-success">
      <h3 style="margin-bottom:10px">‚úÖ Merci pour votre participation !</h3>
      <p style="font-size:18px;margin:10px 0"><strong>Votre avis compte beaucoup pour nous.</strong></p>
      <p style="font-size:20px;margin:10px 0;color:var(--brand)"><strong>Votre appr√©ciation globale est de ${note} sur 5.</strong></p>
      <p style="margin-top:10px">${message||''}</p>
    </div>`; t.style.display='block';}

  // ===== Stockage local & export =====
  function saveFormations(){localStorage.setItem('wenegoce_formations',JSON.stringify(formationsData));}
  function loadFormations(){const s=localStorage.getItem('wenegoce_formations'); if(!s) return; try{formationsData=JSON.parse(s)||[];}catch(e){console.error('Erreur chargement localStorage:',e); formationsData=[];}}
  function generateExcel(autoExport=false){if(formationsData.length===0){if(!autoExport) alert('‚ùå Aucune donn√©e √† exporter'); return;} const data=[]; formationsData.forEach(f=>{const row={'Date':new Date(f.date).toLocaleDateString('fr-FR'),'Client':f.raisonSociale,'Formation':f.theme,'R√©f√©rence JIRA':f.referenceJira||'','Formateur':f.nomFormateur,'Type':f.type,'Heure d√©but':f.heureDebut,'Heure fin':f.heureFin}; for(let i=0;i<10;i++){const s=f.stagiaires[i]; const p=`Stagiaire ${i+1} - `; if(s){row[p+'Nom']=s.nom; row[p+'Email']=s.email; row[p+'Pr√©sence']=s.presence||'Non renseign√©'; row[p+'Commentaire formateur']=s.commentaire||''; if(s.satisfaction){row[p+'Q1 (attentes 1-5)']=s.satisfaction.q1; row[p+'Q2 (objectifs 1-5)']=s.satisfaction.q2; row[p+'Q3 (formateur 1-5)']=s.satisfaction.q3; row[p+'Q4 (aisance)']=s.satisfaction.q4; row[p+'Q5 (dur√©e)']=s.satisfaction.q5; row[p+'Suggestions']=s.satisfaction.q6; row[p+'Commentaire']=s.satisfaction.q7; row[p+'Note globale /5']=s.satisfaction.noteGlobale; row[p+'Date r√©ponse']=new Date(s.satisfaction.dateEnvoi).toLocaleDateString('fr-FR');} else {row[p+'Q1 (attentes 1-5)']=''; row[p+'Q2 (objectifs 1-5)']=''; row[p+'Q3 (formateur 1-5)']=''; row[p+'Q4 (aisance)']=''; row[p+'Q5 (dur√©e)']=''; row[p+'Suggestions']=""; row[p+'Commentaire']=''; row[p+'Note globale /5']=''; row[p+'Date r√©ponse']='';}} else {row[p+'Nom']=''; row[p+'Email']=''; row[p+'Pr√©sence']=''; row[p+'Commentaire formateur']=''; row[p+'Q1 (attentes 1-5)']=''; row[p+'Q2 (objectifs 1-5)']=''; row[p+'Q3 (formateur 1-5)']=''; row[p+'Q4 (aisance)']=''; row[p+'Q5 (dur√©e)']=''; row[p+'Suggestions']=''; row[p+'Commentaire']=''; row[p+'Note globale /5']=''; row[p+'Date r√©ponse']='';}} data.push(row);}); const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Formations'); const file='wenegoce-formations-'+new Date().toISOString().split('T')[0]+'.xlsx'; XLSX.writeFile(wb,file); if(!autoExport) console.log('Export Excel g√©n√©r√© : '+file);}

  // ===== Onglet Formations =====
  async function loadFormationsTab(){const loading=document.getElementById('formationsLoading'); const list=document.getElementById('formationsList'); const empty=document.getElementById('formationsEmpty'); loading.style.display='block'; list.style.display='none'; empty.style.display='none'; let arr=[...formationsData]; const three=new Date(); three.setMonth(three.getMonth()-3); arr=arr.filter(f=>{const d=new Date(f.date); if(d<three) return false; return f.stagiaires.some(s=>(s.presence==='Present'||s.presence==='Partielle') && !s.satisfaction);}); setTimeout(()=>{loading.style.display='none'; if(arr.length===0) empty.style.display='block'; else {displayFormationsCards(arr); list.style.display='block';}},400);}
  function displayFormationsCards(list){const c=document.getElementById('formationsList'); c.innerHTML=''; list.forEach(f=>c.appendChild(createFormationCard(f)));}
  function createFormationCard(f){const date=new Date(f.date).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'}); const pending=f.stagiaires.filter(s=>(s.presence==='Present'||s.presence==='Partielle')&&!s.satisfaction); const card=document.createElement('div'); card.className='formation-card'; let stagList=''; pending.forEach((s,i)=>{stagList += `<div class="stagiaire-item" style="margin:12px 0;padding:12px;background:#f8f9fa;border-radius:10px"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${s.nom}</strong><br><small style="color:#666">${s.email}</small></div><button class="btn" onclick="openReminderModal('${f.id}', ${i})" style="background:var(--warning)">üìß Relancer le stagiaire</button></div></div>`;}); card.innerHTML=`
      <div class="formation-card-header" style="background:var(--brand);color:#fff;padding:14px;border-radius:12px 12px 0 0">
        <div style="margin-bottom:6px"><div style="font-size:14px;opacity:.9;font-weight:600">${f.raisonSociale}</div><div class="formation-card-title" style="font-size:18px;margin-top:2px">${f.theme}</div></div>
        <div class="formation-card-date" style="font-size:13px;opacity:.85;font-style:italic;border-top:1px solid rgba(255,255,255,.25);padding-top:6px;margin-top:6px">${date}</div>
      </div>
      <div class="formation-card-body" style="padding:14px">
        <h4 style="color:var(--brand);margin:0 0 10px">Stagiaires en attente de r√©ponse :</h4>
        ${stagList}
      </div>`; return card;}

  // ===== Routing lien stagiaire =====
  function checkURLParams(){const p=new URLSearchParams(window.location.search); const fid=p.get('fid'), sid=p.get('stid'); if(fid && sid){document.querySelectorAll('.tab').forEach(t=>{if(t.getAttribute('data-tab')!=='stagiaire') t.style.display='none';}); switchTab('stagiaire'); loadStagiaireView(fid,sid);}}

  // ===== Vue stagiaire (r√©cup via Azure manager si non local) =====
  async function loadStagiaireView(fid,sid){let formation=formationsData.find(f=>f.id===fid); if(!formation && FM_ENDPOINTS.manager){try{const raw=await postJson(FM_ENDPOINTS.manager,{formationId:fid, stagiaireId:sid}); const data=(raw && raw.formation)?raw.formation:raw; formation=transformAzureFormation(data);}catch(e){console.error('Erreur r√©cup√©ration Azure manager:',e);}}
    if(!formation){document.getElementById('infoFormation').innerHTML=`<div class="alert" style="background:#f8d7da;border:1px solid #f5c6cb;color:#721c24">‚ùå Formation non trouv√©e ou lien invalide.</div>`; return;}
    const stagiaire=formation.stagiaires.find(s=>s.id===sid); if(!stagiaire){document.getElementById('infoFormation').innerHTML=`<div class="alert" style="background:#f8d7da;border:1px solid #f5c6cb;color:#721c24">‚ùå Stagiaire non trouv√© ou lien invalide.</div>`; return;}
    if(stagiaire.satisfaction){displayThankYouMessage(stagiaire.satisfaction.noteGlobale,'Merci ! Votre retour a bien √©t√© enregistr√©.'); return;}
    const d=new Date(formation.date).toLocaleDateString('fr-FR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    document.getElementById('infoFormation').innerHTML=`
      <h3 style="color:var(--brand);margin-bottom:10px">‚úÖ Attestation de pr√©sence</h3>
      <div class="info-row"><div class="info-label">Formation :</div><div>${formation.theme}</div></div>
      <div class="info-row"><div class="info-label">Date :</div><div>${d}</div></div>
      <div class="info-row"><div class="info-label">Horaires :</div><div>${formation.heureDebut} - ${formation.heureFin}</div></div>
      <div class="info-row"><div class="info-label">Formateur :</div><div>${formation.nomFormateur}</div></div>
      <div class="info-row"><div class="info-label">Client :</div><div>${formation.raisonSociale}</div></div>
      <div class="info-row"><div class="info-label">Stagiaire :</div><div>${stagiaire.nom}</div></div>
      <div class="info-row"><div class="info-label">Statut :</div><div><strong style="color:${stagiaire.presence==='Present'?'#28a745':'#dc3545'}">${stagiaire.presence||'Non renseign√©'}</strong></div></div>`;
    if(stagiaire.presence!=='Absent'){const form=document.getElementById('satisfactionForm'); form.style.display='block'; form.onsubmit=function(e){e.preventDefault(); handleSatisfactionSubmit();};}
    else{document.getElementById('infoFormation').innerHTML += `<div class="alert alert-warning" style="margin-top:10px">‚ÑπÔ∏è L'enqu√™te de satisfaction est disponible uniquement pour les stagiaires pr√©sents ou partiels.</div>`}
  }

  function transformAzureFormation(sp){if(!sp) return null; let stagiaires=[]; if(sp.Stagiaires!==undefined){const raw=sp.Stagiaires; if(typeof raw==='string'){try{stagiaires=JSON.parse(raw)}catch{stagiaires=[]}} else if(Array.isArray(raw)){stagiaires=raw} else if(raw&&typeof raw==='object'){stagiaires=[raw]}} else if(sp.stagiaires){stagiaires=sp.stagiaires}
    let date=sp.DateFormation||sp.Date||sp.date; if(date && typeof date==='string' && date.includes('T')) date=date.split('T')[0];
    return {id:sp.FormationID||sp.id, raisonSociale:sp.RaisonSociale||sp.Client||sp.raisonSociale||'', theme:sp.Theme||sp.ThemeFormation||sp.theme||'', referenceJira:sp.ReferenceJIRA||sp.ReferenceJira||sp.referenceJira||'', nomFormateur:sp.Formateur||sp.NomFormateur||sp.nomFormateur||'', date:date||'', type:sp.TypeFormation||sp.type||'', heureDebut:sp.HeureDebut||sp.heureDebut||'', heureFin:sp.HeureFin||sp.heureFin||'', stagiaires};
  }

  // ===== Modales email =====
  function openEmailModal(){document.getElementById('emailSubjectEdit').value=emailSubjectGlobal; document.getElementById('emailBodyEdit').value=emailBodyGlobal; document.getElementById('emailModal').style.display='flex';}
  function closeEmailModal(){document.getElementById('emailModal').style.display='none'}

  // Expose pour onClick inline
  window.switchTab=switchTab; window.addStagiaire=addStagiaire; window.removeStagiaire=removeStagiaire;
  window.openEmailModal=openEmailModal; window.closeEmailModal=closeEmailModal; window.saveEmailChanges=saveEmailChanges;
  window.openReminderModal=openReminderModal; window.closeReminderModal=closeReminderModal; window.sendReminder=sendReminder;
  window.sendIndividualEmail=sendIndividualEmail;
  </script>
</body>
</html>
